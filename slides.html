<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Enterprise Clojure Training</title>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="copyright" content="Copyright &#169; Timothy Pratley" />
<meta name="generator" content="AsciiDoc 8.6.9" />
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

.monospaced, code, pre {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
  padding: 0;
  margin: 0;
}
pre {
  white-space: pre-wrap;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; vertical-align: text-bottom; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}
/* slidy.css

   Copyright (c) 2005-2010 W3C (MIT, ERCIM, Keio), All Rights Reserved.
   W3C liability, trademark, document use and software licensing
   rules apply, see:

   http://www.w3.org/Consortium/Legal/copyright-documents
   http://www.w3.org/Consortium/Legal/copyright-software
*/

/*
   SJR: 2010-09-29: Modified for AsciiDoc slidy backend.
   Mostly just commented out stuff that is handled by AsciiDoc's CSS files.
*/

body
{
  margin: 0 0 0 0;
  padding: 0 0 0 0;
  width: 100%;
  height: 100%;
  color: black;
  background-color: white;
/*
  font-family: "Gill Sans MT", "Gill Sans", GillSans, sans-serif;
*/
  font-size: 14pt;
}

div.toolbar {
  position: fixed; z-index: 200;
  top: auto; bottom: 0; left: 0; right: 0;
  height: 1.2em; text-align: right;
  padding-left: 1em;
  padding-right: 1em;
  font-size: 60%;
  color: red;
  background-color: rgb(240,240,240);
  border-top: solid 1px rgb(180,180,180);
}

div.toolbar span.copyright {
  color: black;
  margin-left: 0.5em;
}

div.initial_prompt {
  position: absolute;
  z-index: 1000;
  bottom: 1.2em;
  width: 90%;
  background-color: rgb(200,200,200);
  opacity: 0.35;
  background-color: rgb(200,200,200, 0.35);
  cursor: pointer;
}

div.initial_prompt p.help {
  text-align: center;
}

div.initial_prompt p.close {
  text-align: right;
  font-style: italic;
}

div.slidy_toc {
  position: absolute;
  z-index: 300;
  width: 60%;
  max-width: 30em;
  height: 30em;
  overflow: auto;
  top: auto;
  right: auto;
  left: 4em;
  bottom: 4em;
  padding: 1em;
  background: rgb(240,240,240);
  border-style: solid;
  border-width: 2px;
  font-size: 60%;
}

div.slidy_toc .toc_heading {
  text-align: center;
  width: 100%;
  margin: 0;
  margin-bottom: 1em;
  border-bottom-style: solid;
  border-bottom-color: rgb(180,180,180);
  border-bottom-width: 1px;
}

div.slide {
  z-index: 20;
  margin: 0 0 0 0;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 20px;
  padding-right: 20px;
  border-width: 0;
  clear: both;
  top: 0;
  bottom: 0;
  left: 0;
  right: 0;
  line-height: 120%;
  background-color: transparent;
}

div.background {
  display: none;
}

div.handout {
  margin-left: 20px;
  margin-right: 20px;
}

div.slide.titlepage {
  text-align: center;
}

div.slide.titlepage.h1 {
  padding-top: 10%;
}

div.slide h1 {
  padding-left: 0;
  padding-right: 20pt;
  padding-top: 4pt;
  padding-bottom: 4pt;
  margin-top: 0;
  margin-left: 0;
  margin-right: 60pt;
  margin-bottom: 0.5em;
  display: block;
  font-size: 160%;
  line-height: 1.2em;
  background: transparent;
}

div.toc {
  position: absolute;
  top: auto;
  bottom: 4em;
  left: 4em;
  right: auto;
  width: 60%;
  max-width: 30em;
  height: 30em;
  border: solid thin black;
  padding: 1em;
  background: rgb(240,240,240);
  color: black;
  z-index: 300;
  overflow: auto;
  display: block;
  visibility: visible;
}

div.toc-heading {
  width: 100%;
  border-bottom: solid 1px rgb(180,180,180);
  margin-bottom: 1em;
  text-align: center;
}

/*
pre {
 font-size: 80%;
 font-weight: bold;
 line-height: 120%;
 padding-top: 0.2em;
 padding-bottom: 0.2em;
 padding-left: 1em;
 padding-right: 1em;
 border-style: solid;
 border-left-width: 1em;
 border-top-width: thin;
 border-right-width: thin;
 border-bottom-width: thin;
 border-color: #95ABD0;
 color: #00428C;
 background-color: #E4E5E7;
}
*/

/*
li pre { margin-left: 0; }

blockquote { font-style: italic }

img { background-color: transparent }

p.copyright { font-size: smaller }
*/

.center { text-align: center }
.footnote { font-size: smaller; margin-left: 2em; }

/*
a img { border-width: 0; border-style: none }
*/

a:visited { color: navy }
a:link { color: navy }
a:hover { color: red; text-decoration: underline }
a:active { color: red; text-decoration: underline }

a {text-decoration: none}
.navbar a:link {color: white}
.navbar a:visited {color: yellow}
.navbar a:active {color: red}
.navbar a:hover {color: red}

/*
ul { list-style-type: square; }
ul ul { list-style-type: disc; }
ul ul ul { list-style-type: circle; }
ul ul ul ul { list-style-type: disc; }
li { margin-left: 0.5em; margin-top: 0.5em; }
li li { font-size: 85%; font-style: italic }
li li li { font-size: 85%; font-style: normal }
*/

div dt
{
  margin-left: 0;
  margin-top: 1em;
  margin-bottom: 0.5em;
  font-weight: bold;
}
div dd
{
  margin-left: 2em;
  margin-bottom: 0.5em;
}


/*
p,pre,ul,ol,blockquote,h2,h3,h4,h5,h6,dl,table {
  margin-left: 1em;
  margin-right: 1em;
}
*/

p.subhead { font-weight: bold; margin-top: 2em; }

.smaller { font-size: smaller }
.bigger { font-size: 130% }

/*
td,th { padding: 0.2em }
*/

ul {
  margin: 0.5em 1.5em 0.5em 1.5em;
  padding: 0;
}

ol {
  margin: 0.5em 1.5em 0.5em 1.5em;
  padding: 0;
}

ul { list-style-type: square; }
ul ul { list-style-type: disc; }
ul ul ul { list-style-type: circle; }
ul ul ul ul { list-style-type: disc; }

/*
ul li {
  list-style: square;
  margin: 0.1em 0em 0.6em 0;
  padding: 0 0 0 0;
  line-height: 140%;
}

ol li {
  margin: 0.1em 0em 0.6em 1.5em;
  padding: 0 0 0 0px;
  line-height: 140%;
  list-style-type: decimal;
}

li ul li {
  font-size: 85%;
  font-style: italic;
  list-style-type: disc;
  background: transparent;
  padding: 0 0 0 0;
}
li li ul li {
  font-size: 85%;
  font-style: normal;
  list-style-type: circle;
  background: transparent;
  padding: 0 0 0 0;
}
li li li ul li {
  list-style-type: disc;
  background: transparent;
  padding: 0 0 0 0;
}

li ol li {
  list-style-type: decimal;
}


li li ol li {
  list-style-type: decimal;
}
*/

/*
 setting class="outline" on ol or ul makes it behave as an
 ouline list where blocklevel content in li elements is
 hidden by default and can be expanded or collapsed with
 mouse click. Set class="expand" on li to override default
*/

ol.outline li:hover { cursor: pointer }
ol.outline li.nofold:hover { cursor: default }

ul.outline li:hover { cursor: pointer }
ul.outline li.nofold:hover { cursor: default }

ol.outline { list-style:decimal; }
ol.outline ol { list-style-type:lower-alpha }

ol.outline li.nofold {
  padding: 0 0 0 20px;
  background: transparent url(../graphics/nofold-dim.gif) no-repeat 0px 0.5em;
}
ol.outline li.unfolded {
  padding: 0 0 0 20px;
  background: transparent url(../graphics/fold-dim.gif) no-repeat 0px 0.5em;
}
ol.outline li.folded {
  padding: 0 0 0 20px;
  background: transparent url(../graphics/unfold-dim.gif) no-repeat 0px 0.5em;
}
ol.outline li.unfolded:hover {
  padding: 0 0 0 20px;
  background: transparent url(../graphics/fold.gif) no-repeat 0px 0.5em;
}
ol.outline li.folded:hover {
  padding: 0 0 0 20px;
  background: transparent url(../graphics/unfold.gif) no-repeat 0px 0.5em;
}

ul.outline li.nofold {
  padding: 0 0 0 20px;
  background: transparent url(../graphics/nofold-dim.gif) no-repeat 0px 0.5em;
}
ul.outline li.unfolded {
  padding: 0 0 0 20px;
  background: transparent url(../graphics/fold-dim.gif) no-repeat 0px 0.5em;
}
ul.outline li.folded {
  padding: 0 0 0 20px;
  background: transparent url(../graphics/unfold-dim.gif) no-repeat 0px 0.5em;
}
ul.outline li.unfolded:hover {
  padding: 0 0 0 20px;
  background: transparent url(../graphics/fold.gif) no-repeat 0px 0.5em;
}
ul.outline li.folded:hover {
  padding: 0 0 0 20px;
  background: transparent url(../graphics/unfold.gif) no-repeat 0px 0.5em;
}

/* for slides with class "title" in table of contents */
a.titleslide { font-weight: bold; font-style: italic }

/*
 hide images for work around for save as bug
 where browsers fail to save images used by CSS
*/
img.hidden { display: none; visibility: hidden }
div.initial_prompt { display: none; visibility: hidden }

  div.slide {
     visibility: visible;
     position: inherit;
  }
  div.handout {
     border-top-style: solid;
     border-top-width: thin;
     border-top-color: black;
  }

@media screen {
  .hidden { display: none; visibility: visible }

  div.slide.hidden { display: block; visibility: visible }
  div.handout.hidden { display: block; visibility: visible }
  div.background { display: none; visibility: hidden }
  body.single_slide div.initial_prompt { display: block; visibility: visible }
  body.single_slide div.background { display: block; visibility: visible }
  body.single_slide div.background.hidden { display: none; visibility: hidden }
  body.single_slide .invisible { visibility: hidden }
  body.single_slide .hidden { display: none; visibility: hidden }
  body.single_slide div.slide { position: absolute }
  body.single_slide div.handout { display: none; visibility: hidden }
}

@media print {
  .hidden { display: block; visibility: visible }

/*
  div.slide pre { font-size: 60%; padding-left: 0.5em; }
*/
  div.toolbar { display: none; visibility: hidden; }
  div.slidy_toc { display: none; visibility: hidden; }
  div.background { display: none; visibility: hidden; }
  div.slide { page-break-before: always }
  /* :first-child isn't reliable for print media */
  div.slide.first-slide { page-break-before: avoid }
}


/* SJR: AsciiDoc slidy backend tweaks */

ol, ul {
  margin: 0.8em 1.5em 0.8em 1.8em;
}
li > ul, li > ol {
  margin-top: 0.5em;
}

.outline > li.folded,
.outline > li.unfolded {
  color: #527bbd;
}
ul > li{ color: #aaa; }
ul > li > *, ol > li > * { color: black; }

li {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}


</style>
<script type="text/javascript">
/*<![CDATA[*/
/* slidy.js

   Copyright (c) 2005-2010 W3C (MIT, ERCIM, Keio), All Rights Reserved.
   W3C liability, trademark, document use and software licensing
   rules apply, see:

   http://www.w3.org/Consortium/Legal/copyright-documents
   http://www.w3.org/Consortium/Legal/copyright-software
*/

// the slidy object implementation
var w3c_slidy = {
  // classify which kind of browser we're running under
  ns_pos: (typeof window.pageYOffset!='undefined'),
  khtml: ((navigator.userAgent).indexOf("KHTML") >= 0 ? true : false),
  opera: ((navigator.userAgent).indexOf("Opera") >= 0 ? true : false),
  ipad: ((navigator.userAgent).indexOf("iPad") >= 0 ? true : false),
  iphone: ((navigator.userAgent).indexOf("iPhone") >= 0 ? true : false),
  ie: (typeof document.all != "undefined" && !this.opera),
  ie6: (!this.ns_pos && navigator.userAgent.indexOf("MSIE 6") != -1),
  ie7: (!this.ns_pos && navigator.userAgent.indexOf("MSIE 7") != -1),
  ie8: (!this.ns_pos && navigator.userAgent.indexOf("MSIE 8") != -1),
  ie9: (!this.ns_pos && navigator.userAgent.indexOf("MSIE 9") != -1),
  keyboardless: (this.ipad || this.iphone),

  // are we running as XHTML? (doesn't work on Opera)
  is_xhtml: /xml/.test(document.contentType),

  slide_number: 0, // integer slide count: 0, 1, 2, ...
  slide_number_element: null, // element containing slide number
  slides: [], // set to array of slide div's
  notes: [], // set to array of handout div's
  backgrounds: [], // set to array of background div's
  toolbar: null, // element containing toolbar
  title: null, // document title
  last_shown: null, // last incrementally shown item
  eos: null,  // span element for end of slide indicator
  toc: null, // table of contents
  outline: null, // outline element with the focus
  selected_text_len: 0, // length of drag selection on document
  view_all: 0,  // 1 to view all slides + handouts
  want_toolbar: true,  // user preference to show/hide toolbar
  mouse_click_enabled: true, // enables left click for next slide
  scroll_hack: 0, // IE work around for position: fixed
  disable_slide_click: false,  // used by clicked anchors

  lang: "en", // updated to language specified by html file

  help_anchor: null, // used for keyboard focus hack in showToolbar()
  help_page: "http://www.w3.org/Talks/Tools/Slidy2/help/help.html",
  help_text: "Navigate with mouse click, space bar, Cursor Left/Right, " +
             "or Pg Up and Pg Dn. Use S and B to change font size.",

  size_index: 0,
  size_adjustment: 0,
  sizes:  new Array("10pt", "12pt", "14pt", "16pt", "18pt", "20pt",
                    "22pt", "24pt", "26pt", "28pt", "30pt", "32pt"),

  // needed for efficient resizing
  last_width: 0,
  last_height: 0,


  // Needed for cross browser support for relative width/height on
  // object elements. The work around is to save width/height attributes
  // and then to recompute absolute width/height dimensions on resizing
   objects: [],

  // attach initialiation event handlers
  set_up: function () {
    var init = function() { w3c_slidy.init(); };
    if (typeof window.addEventListener != "undefined")
      window.addEventListener("load", init, false);
    else
      window.attachEvent("onload", init);
  },

  hide_slides: function () {
    if (document.body && !w3c_slidy.initialized)
      document.body.style.visibility = "hidden";
    else
      setTimeout(w3c_slidy.hide_slides, 50);
  },

  // hack to persuade IE to compute correct document height
  // as needed for simulating fixed positioning of toolbar
  ie_hack: function () {
    window.resizeBy(0,-1);
    window.resizeBy(0, 1);
  },

  init: function () {
    //alert("slidy starting test 10");
    document.body.style.visibility = "visible";
    w3c_slidy_i18n.init();
    this.add_toolbar();
    this.wrap_implicit_slides();
    this.collect_slides();
    this.collect_notes();
    this.collect_backgrounds();
    this.objects = document.body.getElementsByTagName("object");
    this.patch_anchors();
    this.slide_number = this.find_slide_number(location.href);
    window.offscreenbuffering = true;
    this.size_adjustment = this.find_size_adjust();
    this.time_left = this.find_duration();
    this.hide_image_toolbar();  // suppress IE image toolbar popup
    this.init_outliner();  // activate fold/unfold support
    this.title = document.title;

    // work around for opera bug
    this.is_xhtml = (document.body.tagName == "BODY" ? false : true);

    if (this.slides.length > 0)
    {
      var slide = this.slides[this.slide_number];

      if (this.slide_number > 0)
      {
        this.set_visibility_all_incremental("visible");
        this.last_shown = this.previous_incremental_item(null);
        this.set_eos_status(true);
      }
      else
      {
        this.last_shown = null;
        this.set_visibility_all_incremental("hidden");
        this.set_eos_status(!this.next_incremental_item(this.last_shown));
      }

      this.set_location();
      this.add_class(this.slides[0], "first-slide");
      w3c_slidy.show_slide(slide);
    }

    this.toc = this.table_of_contents();

    this.add_initial_prompt();

    // bind event handlers without interfering with custom page scripts
    // Tap events behave too weirdly to support clicks reliably on
    // iPhone and iPad, so exclude these from click handler

    if (!this.keyboardless)
      this.add_listener(document.body, "click", this.mouse_button_click);

    this.add_listener(document, "keydown", this.key_down);
    this.add_listener(document, "keypress", this.key_press);
    this.add_listener(window, "resize", this.resized);
    this.add_listener(window, "scroll", this.scrolled);
    this.add_listener(window, "unload", this.unloaded);

    if (!document.body.onclick)
      document.body.onclick = function () { };

    this.single_slide_view();

    //this.set_location();

    this.resized();

    if (this.ie7)
      setTimeout(w3c_slidy.ie_hack, 100);

    this.show_toolbar();

    // for back button detection
    setInterval(function () { w3c_slidy.check_location(); }, 200);
    w3c_slidy.initialized = true;
  },

  // create div element with links to each slide
  table_of_contents: function () {
    var toc = this.create_element("div");
    this.add_class(toc, "slidy_toc hidden");
    //toc.setAttribute("tabindex", "0");

    var heading = this.create_element("div");
    this.add_class(heading, "toc-heading");
    heading.innerHTML = "Table of Contents".localize();

    toc.appendChild(heading);
    var previous = null;

    for (var i = 0; i < this.slides.length; ++i)
    {
      var title = this.has_class(this.slides[i], "title");
      var num = document.createTextNode((i + 1) + ". ");

      toc.appendChild(num);

      var a = this.create_element("a");
      a.setAttribute("href", "#(" + (i+1) + ")");

      if (title)
        this.add_class(a, "titleslide");

      var name = document.createTextNode(this.slide_name(i));
      a.appendChild(name);
      a.onclick = w3c_slidy.toc_click;
      a.onkeydown = w3c_slidy.toc_keydown;
      a.previous = previous;

      if (previous)
        previous.next = a;

      toc.appendChild(a);

      if (i == 0)
        toc.first = a;

      if (i < this.slides.length - 1)
      {
        var br = this.create_element("br");
        toc.appendChild(br);
      }

      previous = a;
    }

    toc.focus = function () {
      if (this.first)
        this.first.focus();
    }

    toc.onmouseup = w3c_slidy.mouse_button_up;

    toc.onclick = function (e) {
      e||(e=window.event);

      if (w3c_slidy.selected_text_len <= 0)
         w3c_slidy.hide_table_of_contents();

      w3c_slidy.stop_propagation(e);

      if (e.cancel != undefined)
        e.cancel = true;

      if (e.returnValue != undefined)
        e.returnValue = false;

      return false;
    };

    document.body.insertBefore(toc, document.body.firstChild);
    return toc;
  },

  is_shown_toc: function () {
    return !w3c_slidy.has_class(w3c_slidy.toc, "hidden");
  },

  show_table_of_contents: function () {
    w3c_slidy.remove_class(w3c_slidy.toc, "hidden");
    var toc = w3c_slidy.toc;
    toc.focus();

    if (w3c_slidy.ie7 && w3c_slidy.slide_number == 0)
      setTimeout(w3c_slidy.ie_hack, 100);
  },

  hide_table_of_contents: function () {
    w3c_slidy.add_class(w3c_slidy.toc, "hidden");

    if (!w3c_slidy.opera)
      w3c_slidy.help_anchor.focus();
  },

  toggle_table_of_contents: function () {
    if (w3c_slidy.is_shown_toc())
      w3c_slidy.hide_table_of_contents();
    else
      w3c_slidy.show_table_of_contents();
  },

  // called on clicking toc entry
  toc_click: function (e) {
    if (!e)
      e = window.event;

    var target = w3c_slidy.get_target(e);

    if (target && target.nodeType == 1)
    {
      var uri = target.getAttribute("href");

      if (uri)
      {
        //alert("going to " + uri);
        var slide = w3c_slidy.slides[w3c_slidy.slide_number];
        w3c_slidy.hide_slide(slide);
        w3c_slidy.slide_number = w3c_slidy.find_slide_number(uri);
        slide = w3c_slidy.slides[w3c_slidy.slide_number];
        w3c_slidy.last_shown = null;
        w3c_slidy.set_location();
        w3c_slidy.set_visibility_all_incremental("hidden");
        w3c_slidy.set_eos_status(!w3c_slidy.next_incremental_item(w3c_slidy.last_shown));
        w3c_slidy.show_slide(slide);
        //target.focus();

        try
        {
          if (!w3c_slidy.opera)
            w3c_slidy.help_anchor.focus();
        }
        catch (e)
        {
        }
      }
    }

    w3c_slidy.hide_table_of_contents(e);
    if (w3c_slidy.ie7) w3c_slidy.ie_hack();
    w3c_slidy.stop_propagation(e);
    return w3c_slidy.cancel(e);
  },

  // called onkeydown for toc entry
  toc_keydown: function (event) {
    var key;

    if (!event)
      var event = window.event;

    // kludge around NS/IE differences
    if (window.event)
      key = window.event.keyCode;
    else if (event.which)
      key = event.which;
    else
      return true; // Yikes! unknown browser

    // ignore event if key value is zero
    // as for alt on Opera and Konqueror
    if (!key)
      return true;

    // check for concurrent control/command/alt key
    // but are these only present on mouse events?

    if (event.ctrlKey || event.altKey)
      return true;

    if (key == 13)
    {
      var uri = this.getAttribute("href");

      if (uri)
      {
        //alert("going to " + uri);
       var slide = w3c_slidy.slides[w3c_slidy.slide_number];
        w3c_slidy.hide_slide(slide);
        w3c_slidy.slide_number = w3c_slidy.find_slide_number(uri);
        slide = w3c_slidy.slides[w3c_slidy.slide_number];
        w3c_slidy.last_shown = null;
        w3c_slidy.set_location();
        w3c_slidy.set_visibility_all_incremental("hidden");
        w3c_slidy.set_eos_status(!w3c_slidy.next_incremental_item(w3c_slidy.last_shown));
        w3c_slidy.show_slide(slide);
        //target.focus();

        try
        {
          if (!w3c_slidy.opera)
            w3c_slidy.help_anchor.focus();
        }
        catch (e)
        {
        }
      }

      w3c_slidy.hide_table_of_contents();

      if (self.ie7)
       w3c_slidy.ie_hack();

      return w3c_slidy.cancel(event);
    }

    if (key == 40 && this.next)
    {
      this.next.focus();
      return w3c_slidy.cancel(event);
    }

    if (key == 38 && this.previous)
    {
      this.previous.focus();
      return w3c_slidy.cancel(event);
    }

    return true;
  },


  // ### OBSOLETE ###
  before_print: function () {
    this.show_all_slides();
    this.hide_toolbar();
    alert("before print");
  },

  // ### OBSOLETE ###
  after_print: function () {
    if (!this.view_all)
    {
      this.single_slide_view();
      this.show_toolbar();
    }
    alert("after print");
  },

  // ### OBSOLETE ###
  print_slides: function () {
    this.before_print();
    window.print();
    this.after_print();
  },

  // ### OBSOLETE ?? ###
  toggle_view: function () {
    if (this.view_all)
    {
      this.single_slide_view();
      this.show_toolbar();
      this.view_all = 0;
    }
    else
    {
      this.show_all_slides();
      this.hide_toolbar();
      this.view_all = 1;
    }
  },

  // prepare for printing  ### OBSOLETE ###
  show_all_slides: function () {
    this.remove_class(document.body, "single_slide");
    this.set_visibility_all_incremental("visible");
  },

  // restore after printing  ### OBSOLETE ###
  single_slide_view: function () {
    this.add_class(document.body, "single_slide");
    this.set_visibility_all_incremental("visible");
    this.last_shown = this.previous_incremental_item(null);
  },

  // suppress IE's image toolbar pop up
  hide_image_toolbar: function () {
    if (!this.ns_pos)
    {
      var images = document.getElementsByTagName("IMG");

      for (var i = 0; i < images.length; ++i)
        images[i].setAttribute("galleryimg", "no");
    }
  },

  unloaded: function (e) {
    //alert("unloaded");
  },

  // Safari and Konqueror don't yet support getComputedStyle()
  // and they always reload page when location.href is updated
  is_KHTML: function () {
    var agent = navigator.userAgent;
    return (agent.indexOf("KHTML") >= 0 ? true : false);
  },

  // find slide name from first h1 element
  // default to document title + slide number
  slide_name: function (index) {
    var name = null;
    var slide = this.slides[index];

    var heading = this.find_heading(slide);

    if (heading)
      name = this.extract_text(heading);

    if (!name)
      name = this.title + "(" + (index + 1) + ")";

    name.replace(/\&/g, "&amp;");
    name.replace(/\</g, "&lt;");
    name.replace(/\>/g, "&gt;");

    return name;
  },

  // find first h1 element in DOM tree
  find_heading: function (node) {
    if (!node || node.nodeType != 1)
      return null;

    if (node.nodeName == "H1" || node.nodeName == "h1")
      return node;

    var child = node.firstChild;

    while (child)
    {
      node = this.find_heading(child);

      if (node)
        return node;

      child = child.nextSibling;
    }

    return null;
  },

  // recursively extract text from DOM tree
  extract_text: function (node) {
    if (!node)
      return "";

    // text nodes
    if (node.nodeType == 3)
      return node.nodeValue;

    // elements
    if (node.nodeType == 1)
    {
      node = node.firstChild;
      var text = "";

      while (node)
      {
        text = text + this.extract_text(node);
        node = node.nextSibling;
      }

      return text;
    }

    return "";
  },

  // find copyright text from meta element
  find_copyright: function () {
    var name, content;
    var meta = document.getElementsByTagName("meta");

    for (var i = 0; i < meta.length; ++i)
    {
      name = meta[i].getAttribute("name");
      content = meta[i].getAttribute("content");

      if (name == "copyright")
        return content;
    }

    return null;
  },

  find_size_adjust: function () {
    var name, content, offset;
    var meta = document.getElementsByTagName("meta");

    for (var i = 0; i < meta.length; ++i)
    {
      name = meta[i].getAttribute("name");
      content = meta[i].getAttribute("content");

      if (name == "font-size-adjustment")
        return 1 * content;
    }

    return 1;
  },

  // <meta name="duration" content="20" />  for 20 minutes
  find_duration: function () {
    var name, content, offset;
    var meta = document.getElementsByTagName("meta");

    for (var i = 0; i < meta.length; ++i)
    {
      name = meta[i].getAttribute("name");
      content = meta[i].getAttribute("content");

      if (name == "duration")
        return 60000 * content;
    }

    return null;
  },

  replace_by_non_breaking_space: function (str) {
    for (var i = 0; i < str.length; ++i)
      str[i] = 160;
  },

  // ### CHECK ME ### is use of "li" okay for text/html?
  // for XHTML do we also need to specify namespace?
  init_outliner: function () {
    var items = document.getElementsByTagName("li");

    for (var i = 0; i < items.length; ++i)
    {
      var target = items[i];

      if (!this.has_class(target.parentNode, "outline"))
        continue;

      target.onclick = this.outline_click;
/* ### more work needed for IE6
      if (!this.ns_pos)
      {
        target.onmouseover = this.hover_outline;
        target.onmouseout = this.unhover_outline;
      }
*/
      if (this.foldable(target))
      {
        target.foldable = true;
        target.onfocus = function () {w3c_slidy.outline = this;};
        target.onblur = function () {w3c_slidy.outline = null;};

        if (!target.getAttribute("tabindex"))
          target.setAttribute("tabindex", "0");

        if (this.has_class(target, "expand"))
          this.unfold(target);
        else
          this.fold(target);
      }
      else
      {
        this.add_class(target, "nofold");
        target.visible = true;
        target.foldable = false;
      }
    }
  },

  foldable: function (item) {
    if (!item || item.nodeType != 1)
      return false;

    var node = item.firstChild;

    while (node)
    {
      if (node.nodeType == 1 && this.is_block(node))
        return true;

      node = node.nextSibling;
    }

    return false;
  },

  // ### CHECK ME ### switch to add/remove "hidden" class
  fold: function (item) {
    if (item)
    {
      this.remove_class(item, "unfolded");
      this.add_class(item, "folded");
    }

    var node = item ? item.firstChild : null;

    while (node)
    {
      if (node.nodeType == 1 && this.is_block(node)) // element
      {
         w3c_slidy.add_class(node, "hidden");
      }

      node = node.nextSibling;
    }

    item.visible = false;
  },

  // ### CHECK ME ### switch to add/remove "hidden" class
  unfold: function (item) {
    if (item)
    {
      this.add_class(item, "unfolded");
      this.remove_class(item, "folded");
    }

    var node = item ? item.firstChild : null;

    while (node)
    {
      if (node.nodeType == 1 && this.is_block(node)) // element
      {
        w3c_slidy.remove_class(node, "hidden");
      }

      node = node.nextSibling;
    }

    item.visible = true;
  },

  outline_click: function (e) {
    if (!e)
      e = window.event;

    var rightclick = false;
    var target = w3c_slidy.get_target(e);

    while (target && target.visible == undefined)
      target = target.parentNode;

    if (!target)
      return true;

    if (e.which)
      rightclick = (e.which == 3);
    else if (e.button)
      rightclick = (e.button == 2);

    if (!rightclick && target.visible != undefined)
    {
      if (target.foldable)
      {
        if (target.visible)
          w3c_slidy.fold(target);
        else
          w3c_slidy.unfold(target);
      }

      w3c_slidy.stop_propagation(e);
      e.cancel = true;
      e.returnValue = false;
    }

    return false;
  },

  add_initial_prompt: function () {
    var prompt = this.create_element("div");
    prompt.setAttribute("class", "initial_prompt");

    var p1 = this.create_element("p");
    prompt.appendChild(p1);
    p1.setAttribute("class", "help");

    if (this.keyboardless)
      p1.innerHTML = "Tap footer to move to next slide";
    else
      p1.innerHTML = "Space or Right Arrow to move to next " +
                     "slide, click help below for more details";

    this.add_listener(prompt, "click", function (e) {
      document.body.removeChild(prompt);
      w3c_slidy.stop_propagation(e);

      if (e.cancel != undefined)
        e.cancel = true;

      if (e.returnValue != undefined)
        e.returnValue = false;

      return false;
    });

    document.body.appendChild(prompt);
    this.initial_prompt = prompt;
    setTimeout(function() {document.body.removeChild(prompt);}, 5000);
  },

  add_toolbar: function () {
    var counter, page;

     this.toolbar = this.create_element("div");
     this.toolbar.setAttribute("class", "toolbar");

     // a reasonably behaved browser
     if (this.ns_pos || !this.ie6)
     {
       var right = this.create_element("div");
       right.setAttribute("style", "float: right; text-align: right");

       counter = this.create_element("span")
       counter.innerHTML = "slide".localize() + " n/m";
       right.appendChild(counter);
       this.toolbar.appendChild(right);

       var left = this.create_element("div");
       left.setAttribute("style", "text-align: left");

       // global end of slide indicator
       this.eos = this.create_element("span");
       this.eos.innerHTML = "* ";
       left.appendChild(this.eos);

       var help = this.create_element("a");
       help.setAttribute("href", this.help_page);
       help.setAttribute("title", this.help_text.localize());
       help.innerHTML = "help?".localize();
       left.appendChild(help);
       this.help_anchor = help;  // save for focus hack

       var gap1 = document.createTextNode(" ");
       left.appendChild(gap1);

       var contents = this.create_element("a");
       contents.setAttribute("href", "javascript:w3c_slidy.toggle_table_of_contents()");
       contents.setAttribute("title", "table of contents".localize());
       contents.innerHTML = "contents?".localize();
       left.appendChild(contents);

       var gap2 = document.createTextNode(" ");
       left.appendChild(gap2);

       var copyright = this.find_copyright();

       if (copyright)
       {
         var span = this.create_element("span");
         span.className = "copyright";
         span.innerHTML = copyright;
         left.appendChild(span);
       }

       this.toolbar.setAttribute("tabindex", "0");
       this.toolbar.appendChild(left);
     }
     else // IE6 so need to work around its poor CSS support
     {
       this.toolbar.style.position = (this.ie7 ? "fixed" : "absolute");
       this.toolbar.style.zIndex = "200";
       this.toolbar.style.width = "99.9%";
       this.toolbar.style.height = "1.2em";
       this.toolbar.style.top = "auto";
       this.toolbar.style.bottom = "0";
       this.toolbar.style.left = "0";
       this.toolbar.style.right = "0";
       this.toolbar.style.textAlign = "left";
       this.toolbar.style.fontSize = "60%";
       this.toolbar.style.color = "red";
       this.toolbar.borderWidth = 0;
       this.toolbar.className = "toolbar";
       this.toolbar.style.background = "rgb(240,240,240)";

       // would like to have help text left aligned
       // and page counter right aligned, floating
       // div's don't work, so instead use nested
       // absolutely positioned div's.

       var sp = this.create_element("span");
       sp.innerHTML = "&nbsp;&nbsp;*&nbsp;";
       this.toolbar.appendChild(sp);
       this.eos = sp;  // end of slide indicator

       var help = this.create_element("a");
       help.setAttribute("href", this.help_page);
       help.setAttribute("title", this.help_text.localize());
       help.innerHTML = "help?".localize();
       this.toolbar.appendChild(help);
       this.help_anchor = help;  // save for focus hack

       var gap1 = document.createTextNode(" ");
       this.toolbar.appendChild(gap1);

       var contents = this.create_element("a");
       contents.setAttribute("href", "javascript:toggleTableOfContents()");
       contents.setAttribute("title", "table of contents".localize());
       contents.innerHTML = "contents?".localize();
       this.toolbar.appendChild(contents);

       var gap2 = document.createTextNode(" ");
       this.toolbar.appendChild(gap2);

       var copyright = this.find_copyright();

       if (copyright)
       {
         var span = this.create_element("span");
         span.innerHTML = copyright;
         span.style.color = "black";
         span.style.marginLeft = "0.5em";
         this.toolbar.appendChild(span);
       }

       counter = this.create_element("div")
       counter.style.position = "absolute";
       counter.style.width = "auto"; //"20%";
       counter.style.height = "1.2em";
       counter.style.top = "auto";
       counter.style.bottom = 0;
       counter.style.right = "0";
       counter.style.textAlign = "right";
       counter.style.color = "red";
       counter.style.background = "rgb(240,240,240)";

       counter.innerHTML = "slide".localize() + " n/m";
       this.toolbar.appendChild(counter);
     }

     // ensure that click isn't passed through to the page
     this.toolbar.onclick =
         function (e) {
           if (!e)
             e = window.event;

           var target = e.target;

           if (!target && e.srcElement)
             target = e.srcElement;

           // work around Safari bug
           if (target && target.nodeType == 3)
             target = target.parentNode;

           w3c_slidy.stop_propagation(e);

           if (target && target.nodeName.toLowerCase() != "a")
             w3c_slidy.mouse_button_click(e);
         };

     this.slide_number_element = counter;
     this.set_eos_status(false);
     document.body.appendChild(this.toolbar);
  },

  // wysiwyg editors make it hard to use div elements
  // e.g. amaya loses the div when you copy and paste
  // this function wraps div elements around implicit
  // slides which start with an h1 element and continue
  // up to the next heading or div element
  wrap_implicit_slides: function () {
    var i, heading, node, next, div;
    var headings = document.getElementsByTagName("h1");

    if (!headings)
      return;

    for (i = 0; i < headings.length; ++i)
    {
      heading = headings[i];

      if (heading.parentNode != document.body)
        continue;

      node = heading.nextSibling;

      div = document.createElement("div");
      this.add_class(div, "slide");
      document.body.replaceChild(div, heading);
      div.appendChild(heading);

      while (node)
      {
        if (node.nodeType == 1 &&    // an element
             (node.nodeName == "H1" ||
              node.nodeName == "h1" ||
              node.nodeName == "DIV" ||
              node.nodeName == "div"))
          break;

        next = node.nextSibling;
        node = document.body.removeChild(node);
        div.appendChild(node);
        node = next;
      }
    }
  },

// return new array of all slides
  collect_slides: function () {
    var slides = new Array();
    var divs = document.body.getElementsByTagName("div");

    for (var i = 0; i < divs.length; ++i)
    {
      div = divs.item(i);

      if (this.has_class(div, "slide"))
      {
        // add slide to collection
        slides[slides.length] = div;

        // hide each slide as it is found
        this.add_class(div, "hidden");

        // add dummy <br/> at end for scrolling hack
        var node1 = document.createElement("br");
        div.appendChild(node1);
        var node2 = document.createElement("br");
        div.appendChild(node2);
      }
      else if (this.has_class(div, "background"))
      {  // work around for Firefox SVG reload bug
        // which otherwise replaces 1st SVG graphic with 2nd
        div.style.display = "block";
      }
    }

    this.slides = slides;
  },

  // return new array of all <div class="handout">
  collect_notes: function () {
    var notes = new Array();
    var divs = document.body.getElementsByTagName("div");

    for (var i = 0; i < divs.length; ++i)
    {
      div = divs.item(i);

      if (this.has_class(div, "handout"))
      {
        // add note to collection
        notes[notes.length] = div;

        // and hide it
        this.add_class(div, "hidden");
      }
    }

    this.notes = notes;
  },

  // return new array of all <div class="background">
  // including named backgrounds e.g. class="background titlepage"
  collect_backgrounds: function () {
    var backgrounds = new Array();
    var divs = document.body.getElementsByTagName("div");

    for (var i = 0; i < divs.length; ++i)
    {
      div = divs.item(i);

      if (this.has_class(div, "background"))
      {
        // add background to collection
        backgrounds[backgrounds.length] = div;

        // and hide it
        this.add_class(div, "hidden");
      }
    }

    this.backgrounds = backgrounds;
  },

  // set click handlers on all anchors
  patch_anchors: function () {
    var self = w3c_slidy;
    var handler = function (event) {
      // compare this.href with location.href
      // for link to another slide in this doc

      if (self.page_address(this.href) == self.page_address(location.href))
      {
        // yes, so find new slide number
        var newslidenum = self.find_slide_number(this.href);

        if (newslidenum != self.slide_number)
        {
          var slide = self.slides[self.slide_number];
          self.hide_slide(slide);
          self.slide_number = newslidenum;
          slide = self.slides[self.slide_number];
          self.show_slide(slide);
          self.set_location();
        }
      }
      else if (this.target == null)
        location.href = this.href;

      this.blur();
      self.disable_slide_click = true;
    };

    var anchors = document.body.getElementsByTagName("a");

    for (var i = 0; i < anchors.length; ++i)
    {
      if (window.addEventListener)
        anchors[i].addEventListener("click", handler, false);
      else
        anchors[i].attachEvent("onclick", handler);
    }
  },

  // ### CHECK ME ### see which functions are invoked via setTimeout
  // either directly or indirectly for use of w3c_slidy vs this
  show_slide_number: function () {
    var timer = w3c_slidy.get_timer();
    w3c_slidy.slide_number_element.innerHTML = timer + "slide".localize() + " " +
           (w3c_slidy.slide_number + 1) + "/" + w3c_slidy.slides.length;
  },

  // every 200mS check if the location has been changed as a
  // result of the user activating the Back button/menu item
  // doesn't work for Opera < 9.5
  check_location: function () {
    var hash = location.hash;

    if (w3c_slidy.slide_number > 0 && (hash == "" || hash == "#"))
      w3c_slidy.goto_slide(0);
    else if (hash.length > 2 && hash != "#("+(w3c_slidy.slide_number+1)+")")
    {
      var num = parseInt(location.hash.substr(2));

      if (!isNaN(num))
        w3c_slidy.goto_slide(num-1);
    }

    if (w3c_slidy.time_left && w3c_slidy.slide_number > 0)
    {
      w3c_slidy.show_slide_number();

      if (w3c_slidy.time_left > 0)
        w3c_slidy.time_left -= 200;
    }
  },

  get_timer: function () {
    var timer = "";
    if (w3c_slidy.time_left)
    {
      var mins, secs;
      secs = Math.floor(w3c_slidy.time_left/1000);
      mins = Math.floor(secs / 60);
      secs = secs % 60;
      timer = (mins ? mins+"m" : "") + secs + "s ";
    }

    return timer;
  },

  // this doesn't push location onto history stack for IE
  // for which a hidden iframe hack is needed: load page into
  // the iframe with script that set's parent's location.hash
  // but that won't work for standalone use unless we can
  // create the page dynamically via a javascript: URL
  set_location: function () {
     var uri = w3c_slidy.page_address(location.href);
     var hash = "#(" + (w3c_slidy.slide_number+1) + ")";

     if (w3c_slidy.slide_number >= 0)
       uri = uri + hash;

     if (w3c_slidy.ie && !w3c_slidy.ie8)
       w3c_slidy.push_hash(hash);

     if (uri != location.href) // && !khtml
        location.href = uri;

     if (this.khtml)
        hash = "(" + (w3c_slidy.slide_number+1) + ")";

     if (!this.ie && location.hash != hash && location.hash != "")
       location.hash = hash;

     document.title = w3c_slidy.title + " (" + (w3c_slidy.slide_number+1) + ")";
     w3c_slidy.show_slide_number();
  },

  page_address: function (uri) {
    var i = uri.indexOf("#");

    if (i < 0)
      i = uri.indexOf("%23");

    // check if anchor is entire page

    if (i < 0)
      return uri;  // yes

    return uri.substr(0, i);
  },

  // only used for IE6 and IE7
  on_frame_loaded: function (hash) {
    location.hash = hash;
    var uri = w3c_slidy.page_address(location.href);
    location.href = uri + hash;
  },

  // history hack with thanks to Bertrand Le Roy
  push_hash: function (hash) {
    if (hash == "") hash = "#(1)";
      window.location.hash = hash;

    var doc = document.getElementById("historyFrame").contentWindow.document;
    doc.open("javascript:'<html></html>'");
    // PWL modified this string literal to break the close script tag
    // which otherwise gets parsed when incorporated
    doc.write("<html><head><script type=\"text/javascript\">window.parent.w3c_slidy.on_frame_loaded('"+
      (hash) + "');</" + "script></head><body>hello mum</body></html>");
    doc.close();
    },

  // find current slide based upon location
  // first find target anchor and then look
  // for associated div element enclosing it
  // finally map that to slide number
  find_slide_number: function (uri) {
    // first get anchor from page location

    var i = uri.indexOf("#");

    // check if anchor is entire page
    if (i < 0)
      return 0;  // yes

    var anchor = unescape(uri.substr(i+1));

    // now use anchor as XML ID to find target
    var target = document.getElementById(anchor);

    if (!target)
    {
      // does anchor look like "(2)" for slide 2 ??
      // where first slide is (1)
      var re = /\((\d)+\)/;

      if (anchor.match(re))
      {
        var num = parseInt(anchor.substring(1, anchor.length-1));

        if (num > this.slides.length)
          num = 1;

        if (--num < 0)
          num = 0;

        return num;
      }

      // accept [2] for backwards compatibility
      re = /\[(\d)+\]/;

      if (anchor.match(re))
      {
         var num = parseInt(anchor.substring(1, anchor.length-1));

         if (num > this.slides.length)
            num = 1;

         if (--num < 0)
            num = 0;

         return num;
      }

      // oh dear unknown anchor
      return 0;
    }

    // search for enclosing slide

    while (true)
    {
      // browser coerces html elements to uppercase!
      if (target.nodeName.toLowerCase() == "div" &&
            this.has_class(target, "slide"))
      {
        // found the slide element
        break;
      }

      // otherwise try parent element if any

      target = target.parentNode;

      if (!target)
      {
        return 0;   // no luck!
      }
    };

    for (i = 0; i < slides.length; ++i)
    {
      if (slides[i] == target)
        return i;  // success
    }

    // oh dear still no luck
    return 0;
  },

  previous_slide: function (incremental) {
    if (!w3c_slidy.view_all)
    {
      var slide;

      if ((incremental || w3c_slidy.slide_number == 0) && w3c_slidy.last_shown != null)
      {
        w3c_slidy.last_shown = w3c_slidy.hide_previous_item(w3c_slidy.last_shown);
        w3c_slidy.set_eos_status(false);
      }
      else if (w3c_slidy.slide_number > 0)
      {
        slide = w3c_slidy.slides[w3c_slidy.slide_number];
        w3c_slidy.hide_slide(slide);

        w3c_slidy.slide_number = w3c_slidy.slide_number - 1;
        slide = w3c_slidy.slides[w3c_slidy.slide_number];
        w3c_slidy.set_visibility_all_incremental("visible");
        w3c_slidy.last_shown = w3c_slidy.previous_incremental_item(null);
        w3c_slidy.set_eos_status(true);
        w3c_slidy.show_slide(slide);
      }

      w3c_slidy.set_location();

      if (!w3c_slidy.ns_pos)
        w3c_slidy.refresh_toolbar(200);
    }
  },

  next_slide: function (incremental) {
    if (!w3c_slidy.view_all)
    {
      var slide, last = w3c_slidy.last_shown;

      if (incremental || w3c_slidy.slide_number == w3c_slidy.slides.length - 1)
         w3c_slidy.last_shown = w3c_slidy.reveal_next_item(w3c_slidy.last_shown);

      if ((!incremental || w3c_slidy.last_shown == null) &&
             w3c_slidy.slide_number < w3c_slidy.slides.length - 1)
      {
         slide = w3c_slidy.slides[w3c_slidy.slide_number];
         w3c_slidy.hide_slide(slide);

         w3c_slidy.slide_number = w3c_slidy.slide_number + 1;
         slide = w3c_slidy.slides[w3c_slidy.slide_number];
         w3c_slidy.last_shown = null;
         w3c_slidy.set_visibility_all_incremental("hidden");
         w3c_slidy.show_slide(slide);
      }
      else if (!w3c_slidy.last_shown)
      {
         if (last && incremental)
           w3c_slidy.last_shown = last;
      }

      w3c_slidy.set_location();

      w3c_slidy.set_eos_status(!w3c_slidy.next_incremental_item(w3c_slidy.last_shown));

      if (!w3c_slidy.ns_pos)
         w3c_slidy.refresh_toolbar(200);
     }
  },

  // to first slide with nothing revealed
  // i.e. state at start of presentation
  first_slide: function () {
     if (!w3c_slidy.view_all)
     {
       var slide;

       if (w3c_slidy.slide_number != 0)
       {
         slide = w3c_slidy.slides[w3c_slidy.slide_number];
         w3c_slidy.hide_slide(slide);

         w3c_slidy.slide_number = 0;
         slide = w3c_slidy.slides[w3c_slidy.slide_number];
         w3c_slidy.last_shown = null;
         w3c_slidy.set_visibility_all_incremental("hidden");
         w3c_slidy.show_slide(slide);
       }

       w3c_slidy.set_eos_status(
         !w3c_slidy.next_incremental_item(w3c_slidy.last_shown));
       w3c_slidy.set_location();
     }
  },

  // goto last slide with everything revealed
  // i.e. state at end of presentation
  last_slide: function () {
    if (!w3c_slidy.view_all)
    {
      var slide;

      w3c_slidy.last_shown = null; //revealNextItem(lastShown);

      if (w3c_slidy.last_shown == null &&
          w3c_slidy.slide_number < w3c_slidy.slides.length - 1)
      {
         slide = w3c_slidy.slides[w3c_slidy.slide_number];
         w3c_slidy.hide_slide(slide);
         w3c_slidy.slide_number = w3c_slidy.slides.length - 1;
         slide = w3c_slidy.slides[w3c_slidy.slide_number];
         w3c_slidy.set_visibility_all_incremental("visible");
         w3c_slidy.last_shown = w3c_slidy.previous_incremental_item(null);

         w3c_slidy.show_slide(slide);
      }
      else
      {
         w3c_slidy.set_visibility_all_incremental("visible");
         w3c_slidy.last_shown = w3c_slidy.previous_incremental_item(null);
      }

      w3c_slidy.set_eos_status(true);
      w3c_slidy.set_location();
    }
  },


  // ### check this and consider add/remove class
  set_eos_status: function (state) {
    if (this.eos)
      this.eos.style.color = (state ? "rgb(240,240,240)" : "red");
  },

  // first slide is 0
  goto_slide: function (num) {
    //alert("going to slide " + (num+1));
    var slide = w3c_slidy.slides[w3c_slidy.slide_number];
    w3c_slidy.hide_slide(slide);
    w3c_slidy.slide_number = num;
    slide = w3c_slidy.slides[w3c_slidy.slide_number];
    w3c_slidy.last_shown = null;
    w3c_slidy.set_visibility_all_incremental("hidden");
    w3c_slidy.set_eos_status(!w3c_slidy.next_incremental_item(w3c_slidy.last_shown));
    document.title = w3c_slidy.title + " (" + (w3c_slidy.slide_number+1) + ")";
    w3c_slidy.show_slide(slide);
    w3c_slidy.show_slide_number();
  },


  show_slide: function (slide) {
    this.sync_background(slide);
    window.scrollTo(0,0);
    this.remove_class(slide, "hidden");
  },

  hide_slide: function (slide) {
    this.add_class(slide, "hidden");
  },

  // show just the backgrounds pertinent to this slide
  // when slide background-color is transparent
  // this should now work with rgba color values
  sync_background: function (slide) {
    var background;
    var bgColor;

    if (slide.currentStyle)
      bgColor = slide.currentStyle["backgroundColor"];
    else if (document.defaultView)
    {
      var styles = document.defaultView.getComputedStyle(slide,null);

      if (styles)
        bgColor = styles.getPropertyValue("background-color");
      else // broken implementation probably due Safari or Konqueror
      {
        //alert("defective implementation of getComputedStyle()");
        bgColor = "transparent";
      }
    }
    else
      bgColor == "transparent";

    if (bgColor == "transparent" ||
        bgColor.indexOf("rgba") >= 0 ||
        bgColor.indexOf("opacity") >= 0)
    {
      var slideClass = this.get_class_list(slide);

      for (var i = 0; i < this.backgrounds.length; i++)
      {
        background = this.backgrounds[i];

        var bgClass = this.get_class_list(background);

        if (this.matching_background(slideClass, bgClass))
          this.remove_class(background, "hidden");
        else
          this.add_class(background, "hidden");
      }
    }
    else // forcibly hide all backgrounds
      this.hide_backgrounds();
  },

  hide_backgrounds: function () {
    for (var i = 0; i < this.backgrounds.length; i++)
    {
      background = this.backgrounds[i];
      this.add_class(background, "hidden");
    }
  },

  // compare classes for slide and background
  matching_background: function (slideClass, bgClass) {
    var i, count, pattern, result;

    // define pattern as regular expression
    pattern = /\w+/g;

    // check background class names
    result = bgClass.match(pattern);

    for (i = count = 0; i < result.length; i++)
    {
      if (result[i] == "hidden")
        continue;

      if (result[i] == "background")
	continue;

      ++count;
    }

    if (count == 0)  // default match
      return true;

    // check for matches and place result in array
    result = slideClass.match(pattern);

    // now check if desired name is present for background
    for (i = count = 0; i < result.length; i++)
    {
      if (result[i] == "hidden")
        continue;

      if (this.has_token(bgClass, result[i]))
        return true;
    }

    return false;
  },

  resized: function () {
     var width = 0;

     if ( typeof( window.innerWidth ) == 'number' )
       width = window.innerWidth;  // Non IE browser
     else if (document.documentElement && document.documentElement.clientWidth)
       width = document.documentElement.clientWidth;  // IE6
     else if (document.body && document.body.clientWidth)
       width = document.body.clientWidth; // IE4

     var height = 0;

     if ( typeof( window.innerHeight ) == 'number' )
       height = window.innerHeight;  // Non IE browser
     else if (document.documentElement && document.documentElement.clientHeight)
       height = document.documentElement.clientHeight;  // IE6
     else if (document.body && document.body.clientHeight)
       height = document.body.clientHeight; // IE4

     if (height && (width/height > 1.05*1024/768))
     {
       width = height * 1024.0/768;
     }

     // IE fires onresize even when only font size is changed!
     // so we do a check to avoid blocking < and > actions
     if (width != w3c_slidy.last_width || height != w3c_slidy.last_height)
     {
       if (width >= 1100)
         w3c_slidy.size_index = 5;    // 4
       else if (width >= 1000)
         w3c_slidy.size_index = 4;    // 3
       else if (width >= 800)
         w3c_slidy.size_index = 3;    // 2
       else if (width >= 600)
         w3c_slidy.size_index = 2;    // 1
       else if (width)
         w3c_slidy.size_index = 0;

       // add in font size adjustment from meta element e.g.
       // <meta name="font-size-adjustment" content="-2" />
       // useful when slides have too much content ;-)

       if (0 <= w3c_slidy.size_index + w3c_slidy.size_adjustment &&
             w3c_slidy.size_index + w3c_slidy.size_adjustment < w3c_slidy.sizes.length)
         w3c_slidy.size_index = w3c_slidy.size_index + w3c_slidy.size_adjustment;

       // enables cross browser use of relative width/height
       // on object elements for use with SVG and Flash media
       w3c_slidy.adjust_object_dimensions(width, height);

       if (document.body.style.fontSize != w3c_slidy.sizes[w3c_slidy.size_index])
       {
         document.body.style.fontSize = w3c_slidy.sizes[w3c_slidy.size_index];
       }

       w3c_slidy.last_width = width;
       w3c_slidy.last_height = height;

       // force reflow to work around Mozilla bug
       if (w3c_slidy.ns_pos)
       {
         var slide = w3c_slidy.slides[w3c_slidy.slide_number];
         w3c_slidy.hide_slide(slide);
         w3c_slidy.show_slide(slide);
       }

       // force correct positioning of toolbar
       w3c_slidy.refresh_toolbar(200);
     }
  },

  scrolled: function () {
    if (w3c_slidy.toolbar && !w3c_slidy.ns_pos && !w3c_slidy.ie7)
    {
      w3c_slidy.hack_offset = w3c_slidy.scroll_x_offset();
      // hide toolbar
      w3c_slidy.toolbar.style.display = "none";

      // make it reappear later
      if (w3c_slidy.scrollhack == 0 && !w3c_slidy.view_all)
      {
        setTimeout(function () {w3c_slidy.show_toolbar(); }, 1000);
        w3c_slidy.scrollhack = 1;
      }
    }
  },

  hide_toolbar: function () {
    w3c_slidy.add_class(w3c_slidy.toolbar, "hidden");
    window.focus();
  },

  // used to ensure IE refreshes toolbar in correct position
  refresh_toolbar: function (interval) {
    if (!w3c_slidy.ns_pos && !w3c_slidy.ie7)
    {
      w3c_slidy.hide_toolbar();
      setTimeout(function () {w3c_slidy.show_toolbar(); }, interval);
    }
  },

  // restores toolbar after short delay
  show_toolbar: function () {
    if (w3c_slidy.want_toolbar)
    {
      w3c_slidy.toolbar.style.display = "block";

      if (!w3c_slidy.ns_pos)
      {
        // adjust position to allow for scrolling
        var xoffset = w3c_slidy.scroll_x_offset();
        w3c_slidy.toolbar.style.left = xoffset;
        w3c_slidy.toolbar.style.right = xoffset;

        // determine vertical scroll offset
        //var yoffset = scrollYOffset();

        // bottom is doc height - window height - scroll offset
        //var bottom = documentHeight() - lastHeight - yoffset

        //if (yoffset > 0 || documentHeight() > lastHeight)
        //   bottom += 16;  // allow for height of scrollbar

        w3c_slidy.toolbar.style.bottom = 0; //bottom;
      }

      w3c_slidy.remove_class(w3c_slidy.toolbar, "hidden");
    }

    w3c_slidy.scrollhack = 0;


    // set the keyboard focus to the help link on the
    // toolbar to ensure that document has the focus
    // IE doesn't always work with window.focus()
    // and this hack has benefit of Enter for help

    try
    {
      if (!w3c_slidy.opera)
        w3c_slidy.help_anchor.focus();
    }
    catch (e)
    {
    }
  },

// invoked via F key
  toggle_toolbar: function () {
    if (!w3c_slidy.view_all)
    {
      if (w3c_slidy.has_class(w3c_slidy.toolbar, "hidden"))
      {
        w3c_slidy.remove_class(w3c_slidy.toolbar, "hidden")
        w3c_slidy.want_toolbar = 1;
      }
      else
      {
        w3c_slidy.add_class(w3c_slidy.toolbar, "hidden")
        w3c_slidy.want_toolbar = 0;
      }
    }
  },

  scroll_x_offset: function () {
    if (window.pageXOffset)
      return self.pageXOffset;

    if (document.documentElement &&
             document.documentElement.scrollLeft)
      return document.documentElement.scrollLeft;

    if (document.body)
      return document.body.scrollLeft;

    return 0;
  },

  scroll_y_offset: function () {
    if (window.pageYOffset)
      return self.pageYOffset;

    if (document.documentElement &&
             document.documentElement.scrollTop)
      return document.documentElement.scrollTop;

    if (document.body)
      return document.body.scrollTop;

    return 0;
  },

  // looking for a way to determine height of slide content
  // the slide itself is set to the height of the window
  optimize_font_size: function () {
    var slide = w3c_slidy.slides[w3c_slidy.slide_number];

    //var dh = documentHeight(); //getDocHeight(document);
    var dh = slide.scrollHeight;
    var wh = getWindowHeight();
    var u = 100 * dh / wh;

    alert("window utilization = " + u + "% (doc "
      + dh + " win " + wh + ")");
  },

  // from document object
  get_doc_height: function (doc) {
    if (!doc)
      doc = document;

    if (doc && doc.body && doc.body.offsetHeight)
      return doc.body.offsetHeight;  // ns/gecko syntax

    if (doc && doc.body && doc.body.scrollHeight)
      return doc.body.scrollHeight;

    alert("couldn't determine document height");
  },

  get_window_height: function () {
    if ( typeof( window.innerHeight ) == 'number' )
      return window.innerHeight;  // Non IE browser

    if (document.documentElement && document.documentElement.clientHeight)
      return document.documentElement.clientHeight;  // IE6

    if (document.body && document.body.clientHeight)
      return document.body.clientHeight; // IE4
  },

  document_height: function () {
    var sh, oh;

    sh = document.body.scrollHeight;
    oh = document.body.offsetHeight;

    if (sh && oh)
    {
      return (sh > oh ? sh : oh);
    }

    // no idea!
    return 0;
  },

  smaller: function () {
    if (w3c_slidy.size_index > 0)
    {
      --w3c_slidy.size_index;
    }

    w3c_slidy.toolbar.style.display = "none";
    document.body.style.fontSize = w3c_slidy.sizes[w3c_slidy.size_index];
    var slide = w3c_slidy.slides[w3c_slidy.slide_number];
    w3c_slidy.hide_slide(slide);
    w3c_slidy.show_slide(slide);
    setTimeout(function () {w3c_slidy.show_toolbar(); }, 50);
  },

  bigger: function () {
    if (w3c_slidy.size_index < w3c_slidy.sizes.length - 1)
    {
      ++w3c_slidy.size_index;
    }

    w3c_slidy.toolbar.style.display = "none";
    document.body.style.fontSize = w3c_slidy.sizes[w3c_slidy.size_index];
    var slide = w3c_slidy.slides[w3c_slidy.slide_number];
    w3c_slidy.hide_slide(slide);
    w3c_slidy.show_slide(slide);
    setTimeout(function () {w3c_slidy.show_toolbar(); }, 50);
  },

  // enables cross browser use of relative width/height
  // on object elements for use with SVG and Flash media
  // with thanks to Ivan Herman for the suggestion
  adjust_object_dimensions: function (width, height) {
    for( var i = 0; i < w3c_slidy.objects.length; i++ )
    {
      var obj = this.objects[i];
      var mimeType = obj.getAttribute("type");

      if (mimeType == "image/svg+xml" || mimeType == "application/x-shockwave-flash")
      {
        if ( !obj.initialWidth )
          obj.initialWidth = obj.getAttribute("width");

        if ( !obj.initialHeight )
          obj.initialHeight = obj.getAttribute("height");

        if ( obj.initialWidth && obj.initialWidth.charAt(obj.initialWidth.length-1) == "%" )
        {
          var w = parseInt(obj.initialWidth.slice(0, obj.initialWidth.length-1));
          var newW = width * (w/100.0);
          obj.setAttribute("width",newW);
        }

        if ( obj.initialHeight &&
             obj.initialHeight.charAt(obj.initialHeight.length-1) == "%" )
        {
          var h = parseInt(obj.initialHeight.slice(0, obj.initialHeight.length-1));
          var newH = height * (h/100.0);
          obj.setAttribute("height", newH);
        }
      }
    }
  },

  // needed for Opera to inhibit default behavior
  // since Opera delivers keyPress even if keyDown
  // was cancelled
  key_press: function (event) {
    if (!event)
      event = window.event;

    if (!w3c_slidy.key_wanted)
      return w3c_slidy.cancel(event);

    return true;
  },

  //  See e.g. http://www.quirksmode.org/js/events/keys.html for keycodes
  key_down: function (event) {
    var key;

    w3c_slidy.key_wanted = true;

    if (!event)
      event = window.event;

    // kludge around NS/IE differences
    if (window.event)
      key = window.event.keyCode;
    else if (event.which)
      key = event.which;
    else
      return true; // Yikes! unknown browser

    // ignore event if key value is zero
    // as for alt on Opera and Konqueror
    if (!key)
       return true;

    // check for concurrent control/command/alt key
    // but are these only present on mouse events?

    if (event.ctrlKey || event.altKey || event.metaKey)
       return true;

    // dismiss table of contents if visible
    if (w3c_slidy.is_shown_toc() && key != 9 && key != 16 && key != 38 && key != 40)
    {
      w3c_slidy.hide_table_of_contents();

      if (key == 27 || key == 84 || key == 67)
        return w3c_slidy.cancel(event);
    }

    if (key == 34) // Page Down
    {
      if (w3c_slidy.view_all)
        return true;

      w3c_slidy.next_slide(false);
      return w3c_slidy.cancel(event);
    }
    else if (key == 33) // Page Up
    {
      if (w3c_slidy.view_all)
        return true;

      w3c_slidy.previous_slide(false);
      return w3c_slidy.cancel(event);
    }
    else if (key == 32) // space bar
    {
      w3c_slidy.next_slide(true);
      return w3c_slidy.cancel(event);
    }
    else if (key == 37) // Left arrow
    {
      w3c_slidy.previous_slide(!event.shiftKey);
      return w3c_slidy.cancel(event);
    }
    else if (key == 36) // Home
    {
      w3c_slidy.first_slide();
      return w3c_slidy.cancel(event);
    }
    else if (key == 35) // End
    {
      w3c_slidy.last_slide();
      return w3c_slidy.cancel(event);
    }
    else if (key == 39) // Right arrow
    {
      w3c_slidy.next_slide(!event.shiftKey);
      return w3c_slidy.cancel(event);
    }
    else if (key == 13) // Enter
    {
      if (w3c_slidy.outline)
      {
        if (w3c_slidy.outline.visible)
          w3c_slidy.fold(w3c_slidy.outline);
        else
          w3c_slidy.unfold(w3c_slidy.outline);

       return w3c_slidy.cancel(event);
      }
    }
    else if (key == 188)  // < for smaller fonts
    {
      w3c_slidy.smaller();
      return w3c_slidy.cancel(event);
    }
    else if (key == 190)  // > for larger fonts
    {
      w3c_slidy.bigger();
      return w3c_slidy.cancel(event);
    }
    else if (key == 189 || key == 109)  // - for smaller fonts
    {
      w3c_slidy.smaller();
      return w3c_slidy.cancel(event);
    }
    else if (key == 187 || key == 191 || key == 107)  // = +  for larger fonts
    {
      w3c_slidy.bigger();
      return w3c_slidy.cancel(event);
    }
    else if (key == 83)  // S for smaller fonts
    {
      w3c_slidy.smaller();
      return w3c_slidy.cancel(event);
    }
    else if (key == 66)  // B for larger fonts
    {
      w3c_slidy.bigger();
      return w3c_slidy.cancel(event);
    }
    else if (key == 90)  // Z for last slide
    {
      w3c_slidy.last_slide();
      return w3c_slidy.cancel(event);
    }
    else if (key == 70)  // F for toggle toolbar
    {
      w3c_slidy.toggle_toolbar();
      return w3c_slidy.cancel(event);
    }
    else if (key == 65)  // A for toggle view single/all slides
    {
      w3c_slidy.toggle_view();
      return w3c_slidy.cancel(event);
    }
    else if (key == 75)  // toggle action of left click for next page
    {
      w3c_slidy.mouse_click_enabled = !w3c_slidy.mouse_click_enabled;
      var alert_msg = (w3c_slidy.mouse_click_enabled ?
                "enabled" : "disabled") +  " mouse click advance";

      alert(alert_msg.localize());
      return w3c_slidy.cancel(event);
    }
    else if (key == 84 || key == 67)  // T or C for table of contents
    {
      if (w3c_slidy.toc)
        w3c_slidy.toggle_table_of_contents();

      return w3c_slidy.cancel(event);
    }
    else if (key == 72) // H for help
    {
      window.location = w3c_slidy.help_page;
      return w3c_slidy.cancel(event);
    }
    //else alert("key code is "+ key);

    return true;
  },

  // safe for both text/html and application/xhtml+xml
  create_element: function (name) {
    if (this.xhtml && (typeof document.createElementNS != 'undefined'))
      return document.createElementNS("http://www.w3.org/1999/xhtml", name)

    return document.createElement(name);
  },

  get_element_style: function (elem, IEStyleProp, CSSStyleProp) {
    if (elem.currentStyle)
    {
      return elem.currentStyle[IEStyleProp];
    }
    else if (window.getComputedStyle)
    {
      var compStyle = window.getComputedStyle(elem, "");
      return compStyle.getPropertyValue(CSSStyleProp);
    }
    return "";
  },

  // the string str is a whitespace separated list of tokens
  // test if str contains a particular token, e.g. "slide"
  has_token: function (str, token) {
    if (str)
    {
      // define pattern as regular expression
      var pattern = /\w+/g;

      // check for matches
      // place result in array
      var result = str.match(pattern);

      // now check if desired token is present
      for (var i = 0; i < result.length; i++)
      {
        if (result[i] == token)
          return true;
      }
    }

    return false;
  },

  get_class_list: function (element) {
    if (typeof element.className != 'undefined')
      return element.className;

    return element.getAttribute("class");
  },

  has_class: function (element, name) {
    if (element.nodeType != 1)
      return false;

    var regexp = new RegExp("(^| )" + name + "\W*");

    if (typeof element.className != 'undefined')
      return regexp.test(element.className);

    return regexp.test(element.getAttribute("class"));
  },

  remove_class: function (element, name) {
    var regexp = new RegExp("(^| )" + name + "\W*");
    var clsval = "";

    if (typeof element.className != 'undefined')
    {
      clsval = element.className;

      if (clsval)
      {
        clsval = clsval.replace(regexp, "");
        element.className = clsval;
      }
    }
    else
    {
      clsval = element.getAttribute("class");

      if (clsval)
      {
        clsval = clsval.replace(regexp, "");
        element.setAttribute("class", clsval);
      }
    }
  },

  add_class: function (element, name) {
    if (!this.has_class(element, name))
    {
      if (typeof element.className != 'undefined')
        element.className += " " + name;
      else
      {
        var clsval = element.getAttribute("class");
        clsval = clsval ? clsval + " " + name : name;
        element.setAttribute("class", clsval);
      }
    }
  },

  // HTML elements that can be used with class="incremental"
  // note that you can also put the class on containers like
  // up, ol, dl, and div to make their contents appear
  // incrementally. Upper case is used since this is what
  // browsers report for HTML node names (text/html).
  incremental_elements: null,
  okay_for_incremental: function (name) {
    if (!this.incremental_elements)
    {
      var inclist = new Array();
      inclist["p"] = true;
      inclist["pre"] = true;
      inclist["li"] = true;
      inclist["blockquote"] = true;
      inclist["dt"] = true;
      inclist["dd"] = true;
      inclist["h2"] = true;
      inclist["h3"] = true;
      inclist["h4"] = true;
      inclist["h5"] = true;
      inclist["h6"] = true;
      inclist["span"] = true;
      inclist["address"] = true;
      inclist["table"] = true;
      inclist["tr"] = true;
      inclist["th"] = true;
      inclist["td"] = true;
      inclist["img"] = true;
      inclist["object"] = true;
      this.incremental_elements = inclist;
    }
    return this.incremental_elements[name.toLowerCase()];
  },

  next_incremental_item: function (node) {
    var br = this.is_xhtml ? "br" : "BR";
    var slide = w3c_slidy.slides[w3c_slidy.slide_number];

    for (;;)
    {
      node = w3c_slidy.next_node(slide, node);

      if (node == null || node.parentNode == null)
        break;

      if (node.nodeType == 1)  // ELEMENT
      {
        if (node.nodeName == br)
          continue;

        if (w3c_slidy.has_class(node, "incremental")
             && w3c_slidy.okay_for_incremental(node.nodeName))
          return node;

        if (w3c_slidy.has_class(node.parentNode, "incremental")
             && !w3c_slidy.has_class(node, "non-incremental"))
          return node;
      }
    }

    return node;
  },

  previous_incremental_item: function (node) {
    var br = this.is_xhtml ? "br" : "BR";
    var slide = w3c_slidy.slides[w3c_slidy.slide_number];

    for (;;)
    {
      node = w3c_slidy.previous_node(slide, node);

      if (node == null || node.parentNode == null)
        break;

      if (node.nodeType == 1)
      {
        if (node.nodeName == br)
          continue;

        if (w3c_slidy.has_class(node, "incremental")
             && w3c_slidy.okay_for_incremental(node.nodeName))
          return node;

        if (w3c_slidy.has_class(node.parentNode, "incremental")
             && !w3c_slidy.has_class(node, "non-incremental"))
          return node;
      }
    }

    return node;
  },

  // set visibility for all elements on current slide with
  // a parent element with attribute class="incremental"
  set_visibility_all_incremental: function (value) {
    var node = this.next_incremental_item(null);

    if (value == "hidden")
    {
      while (node)
      {
        w3c_slidy.add_class(node, "invisible");
        node = w3c_slidy.next_incremental_item(node);
      }
    }
    else // value == "visible"
    {
      while (node)
      {
        w3c_slidy.remove_class(node, "invisible");
        node = w3c_slidy.next_incremental_item(node);
      }
    }
  },

  // reveal the next hidden item on the slide
  // node is null or the node that was last revealed
  reveal_next_item: function (node) {
    node = w3c_slidy.next_incremental_item(node);

    if (node && node.nodeType == 1)  // an element
      w3c_slidy.remove_class(node, "invisible");

    return node;
  },

  // exact inverse of revealNextItem(node)
  hide_previous_item: function (node) {
    if (node && node.nodeType == 1)  // an element
      w3c_slidy.add_class(node, "invisible");

    return this.previous_incremental_item(node);
  },

  // left to right traversal of root's content
  next_node: function (root, node) {
    if (node == null)
      return root.firstChild;

    if (node.firstChild)
      return node.firstChild;

    if (node.nextSibling)
      return node.nextSibling;

    for (;;)
    {
      node = node.parentNode;

      if (!node || node == root)
        break;

      if (node && node.nextSibling)
        return node.nextSibling;
    }

    return null;
  },

  // right to left traversal of root's content
  previous_node: function (root, node) {
    if (node == null)
    {
      node = root.lastChild;

      if (node)
      {
        while (node.lastChild)
          node = node.lastChild;
      }

      return node;
    }

    if (node.previousSibling)
    {
      node = node.previousSibling;

      while (node.lastChild)
        node = node.lastChild;

      return node;
    }

    if (node.parentNode != root)
      return node.parentNode;

    return null;
  },

  previous_sibling_element: function (el) {
    el = el.previousSibling;

    while (el && el.nodeType != 1)
      el = el.previousSibling;

    return el;
  },

  next_sibling_element: function (el) {
    el = el.nextSibling;

    while (el && el.nodeType != 1)
      el = el.nextSibling;

    return el;
  },

  first_child_element: function (el) {
    var node;

    for (node = el.firstChild; node; node = node.nextSibling)
    {
      if (node.nodeType == 1)
        break;
    }

    return node;
  },

  first_tag: function (element, tag) {
    var node;

    if (!this.is_xhtml)
      tag = tag.toUpperCase();

    for (node = element.firstChild; node; node = node.nextSibling)
    {
      if (node.nodeType == 1 && node.nodeName == tag)
        break;
    }

    return node;
  },

  hide_selection: function () {
    if (window.getSelection) // Firefox, Chromium, Safari, Opera
    {
      var selection = window.getSelection();

      if (selection.rangeCount > 0)
      {
        var range = selection.getRangeAt(0);
        range.collapse (false);
      }
    }
    else // Internet Explorer
    {
      var textRange = document.selection.createRange ();
      textRange.collapse (false);
    }
  },

  get_selected_text: function () {
    try
    {
      if (window.getSelection)
        return window.getSelection().toString();

      if (document.getSelection)
        return document.getSelection().toString();

      if (document.selection)
        return document.selection.createRange().text;
    }
    catch (e)
    {
    }

    return "";
  },

  // make note of length of selected text
  // as this evaluates to zero in click event
  mouse_button_up: function (e) {
    w3c_slidy.selected_text_len = w3c_slidy.get_selected_text().length;
  },

  // right mouse button click is reserved for context menus
  // it is more reliable to detect rightclick than leftclick
  mouse_button_click: function (e) {
    var rightclick = false;
    var leftclick = false;
    var middleclick = false;
    var target;

    if (!e)
      var e = window.event;

    if (e.target)
      target = e.target;
    else if (e.srcElement)
      target = e.srcElement;

    // work around Safari bug
    if (target.nodeType == 3)
      target = target.parentNode;

    if (e.which) // all browsers except IE
    {
      leftclick = (e.which == 1);
      middleclick = (e.which == 2);
      rightclick = (e.which == 3);
    }
    else if (e.button)
    {
      // Konqueror gives 1 for left, 4 for middle
      // IE6 gives 0 for left and not 1 as I expected

      if (e.button == 4)
        middleclick = true;

      // all browsers agree on 2 for right button
      rightclick = (e.button == 2);
    }
    else leftclick = true;
/*
    alert("you clicked over a " + target.nodeName + " element\n" +
    "w3c_slidy.mouse_click_enabled = " + w3c_slidy.mouse_click_enabled + "\n" +
    "leftclick = " + leftclick + "\n" +
    "selected text length = " + w3c_slidy.selected_text_len);
    //alert("selected text length = " + w3c_slidy.selected_text_len);
*/
    if (w3c_slidy.selected_text_len > 0)
    {
      w3c_slidy.stop_propagation(e);
      e.cancel = true;
      e.returnValue = false;
      return false;
    }

    // dismiss table of contents
    w3c_slidy.hide_table_of_contents();

    // check if target is something that probably want's clicks
    // e.g. a, embed, object, input, textarea, select, option
    var tag = target.nodeName.toLowerCase();

    if (w3c_slidy.mouse_click_enabled && leftclick &&
        tag != "a" &&
        tag != "embed" &&
        tag != "object" &&
        tag != "video" &&
        tag != "input" &&
        tag != "textarea" &&
        tag != "select" &&
        tag != "option" &&
        !target.onclick)
    {
      w3c_slidy.next_slide(true);
      w3c_slidy.stop_propagation(e);
      e.cancel = true;
      e.returnValue = false;
      return false;
    }
  },

  get_key: function (e)
  {
    var key;

    // kludge around NS/IE differences
    if (typeof window.event != "undefined")
      key = window.event.keyCode;
    else if (e.which)
      key = e.which;

    return key;
  },

  get_target: function (e) {
    var target;

    if (!e)
      e = window.event;

    if (e.target)
      target = e.target;
    else if (e.srcElement)
      target = e.srcElement;

    if (target.nodeType != 1)
      target = target.parentNode;

    return target;
  },

  // does display property provide correct defaults?
  is_block: function (elem) {
    var tag = elem.nodeName.toLowerCase();

    return tag == "ol" || tag == "ul" || tag == "p" ||
           tag == "li" || tag == "table" || tag == "pre" ||
           tag == "h1" || tag == "h2" || tag == "h3" ||
           tag == "h4" || tag == "h5" || tag == "h6" ||
           tag == "blockquote" || tag == "address";
  },

  add_listener: function (element, event, handler) {
    if (window.addEventListener)
      element.addEventListener(event, handler, false);
    else
      element.attachEvent("on"+event, handler);
  },

  // used to prevent event propagation from field controls
  stop_propagation: function (event) {
    event = event ? event : window.event;
    event.cancelBubble = true;  // for IE

    if (event.stopPropagation)
      event.stopPropagation();

    return true;
  },

  cancel: function (event) {
    if (event)
    {
       event.cancel = true;
       event.returnValue = false;

      if (event.preventDefault)
        event.preventDefault();
    }

    w3c_slidy.key_wanted = false;
    return false;
  }
};

// for each language define an associative array
// and also the help text which is longer

var w3c_slidy_i18n = {
  strings_es: {
    "slide":"pág.",
    "help?":"Ayuda",
    "contents?":"Índice",
    "table of contents":"tabla de contenidos",
    "Table of Contents":"Tabla de Contenidos",
    "restart presentation":"Reiniciar presentación",
    "restart?":"Inicio"
  },
  help_es:
    "Utilice el ratón, barra espaciadora, teclas Izda/Dcha, " +
    "o Re pág y Av pág. Use S y B para cambiar el tamaño de fuente.",

  strings_ca: {
    "slide":"pàg..",
    "help?":"Ajuda",
    "contents?":"Índex",
    "table of contents":"taula de continguts",
    "Table of Contents":"Taula de Continguts",
    "restart presentation":"Reiniciar presentació",
    "restart?":"Inici"
  },
  help_ca:
    "Utilitzi el ratolí, barra espaiadora, tecles Esq./Dta. " +
    "o Re pàg y Av pàg. Usi S i B per canviar grandària de font.",

  strings_cs: {
    "slide":"snímek",
    "help?":"nápověda",
    "contents?":"obsah",
    "table of contents":"obsah prezentace",
    "Table of Contents":"Obsah prezentace",
    "restart presentation":"znovu spustit prezentaci",
    "restart?":"restart"
  },
  help_cs:
    "Prezentaci můžete procházet pomocí kliknutí myši, mezerníku, " +
    "šipek vlevo a vpravo nebo kláves PageUp a PageDown. Písmo se " +
    "dá zvětšit a zmenšit pomocí kláves B a S.",

  strings_nl: {
    "slide":"pagina",
    "help?":"Help?",
    "contents?":"Inhoud?",
    "table of contents":"inhoudsopgave",
    "Table of Contents":"Inhoudsopgave",
    "restart presentation":"herstart presentatie",
    "restart?":"Herstart?"
  },
  help_nl:
     "Navigeer d.m.v. het muis, spatiebar, Links/Rechts toetsen, " +
     "of PgUp en PgDn. Gebruik S en B om de karaktergrootte te veranderen.",

  strings_de: {
    "slide":"Seite",
    "help?":"Hilfe",
    "contents?":"Übersicht",
    "table of contents":"Inhaltsverzeichnis",
    "Table of Contents":"Inhaltsverzeichnis",
    "restart presentation":"Präsentation neu starten",
    "restart?":"Neustart"
  },
  help_de:
    "Benutzen Sie die Maus, Leerschlag, die Cursortasten links/rechts oder " +
    "Page up/Page Down zum Wechseln der Seiten und S und B für die Schriftgrösse.",

  strings_pl: {
    "slide":"slajd",
    "help?":"pomoc?",
    "contents?":"spis treści?",
    "table of contents":"spis treści",
    "Table of Contents":"Spis Treści",
    "restart presentation":"Restartuj prezentację",
    "restart?":"restart?"
  },
  help_pl:
    "Zmieniaj slajdy klikając myszą, naciskając spację, strzałki lewo/prawo" +
    "lub PgUp / PgDn. Użyj klawiszy S i B, aby zmienić rozmiar czczionki.",

  strings_fr: {
    "slide":"page",
    "help?":"Aide",
    "contents?":"Index",
    "table of contents":"table des matières",
    "Table of Contents":"Table des matières",
    "restart presentation":"Recommencer l'exposé",
    "restart?":"Début"
  },
  help_fr:
    "Naviguez avec la souris, la barre d'espace, les flèches " +
    "gauche/droite ou les touches Pg Up, Pg Dn. Utilisez " +
    "les touches S et B pour modifier la taille de la police.",

  strings_hu: {
    "slide":"oldal",
    "help?":"segítség",
    "contents?":"tartalom",
    "table of contents":"tartalomjegyzék",
    "Table of Contents":"Tartalomjegyzék",
    "restart presentation":"bemutató újraindítása",
    "restart?":"újraindítás"
  },
  help_hu:
    "Az oldalak közti lépkedéshez kattintson az egérrel, vagy " +
    "használja a szóköz, a bal, vagy a jobb nyíl, illetve a Page Down, " +
    "Page Up billentyűket. Az S és a B billentyűkkel változtathatja " +
    "a szöveg méretét.",

  strings_it: {
    "slide":"pag.",
    "help?":"Aiuto",
    "contents?":"Indice",
    "table of contents":"indice",
    "Table of Contents":"Indice",
    "restart presentation":"Ricominciare la presentazione",
    "restart?":"Inizio"
  },
  help_it:
    "Navigare con mouse, barra spazio, frecce sinistra/destra o " +
    "PgUp e PgDn. Usare S e B per cambiare la dimensione dei caratteri.",

  strings_el: {
    "slide":"σελίδα",
    "help?":"βοήθεια;",
    "contents?":"περιεχόμενα;",
    "table of contents":"πίνακας περιεχομένων",
    "Table of Contents":"Πίνακας Περιεχομένων",
    "restart presentation":"επανεκκίνηση παρουσίασης",
    "restart?":"επανεκκίνηση;"
  },
  help_el:
    "Πλοηγηθείτε με το κλίκ του ποντικιού, το space, τα βέλη αριστερά/δεξιά, " +
    "ή Page Up και Page Down. Χρησιμοποιήστε τα πλήκτρα S και B για να αλλάξετε " +
    "το μέγεθος της γραμματοσειράς.",

  strings_ja: {
    "slide":"スライド",
    "help?":"ヘルプ",
    "contents?":"目次",
    "table of contents":"目次を表示",
    "Table of Contents":"目次",
    "restart presentation":"最初から再生",
    "restart?":"最初から"
  },
  help_ja:
     "マウス左クリック ・ スペース ・ 左右キー " +
     "または Page Up ・ Page Downで操作， S ・ Bでフォントサイズ変更",

  strings_zh: {
    "slide":"幻灯片",
    "help?":"帮助?",
    "contents?":"内容?",
    "table of contents":"目录",
    "Table of Contents":"目录",
    "restart presentation":"重新启动展示",
    "restart?":"重新启动?"
  },
  help_zh:
    "用鼠标点击, 空格条, 左右箭头, Pg Up 和 Pg Dn 导航. " +
    "用 S, B 改变字体大小.",

  strings_ru: {
    "slide":"слайд",
    "help?":"помощь?",
    "contents?":"содержание?",
    "table of contents":"оглавление",
    "Table of Contents":"Оглавление",
    "restart presentation":"перезапустить презентацию",
    "restart?":"перезапуск?"
  },
  help_ru:
    "Перемещайтесь кликая мышкой, используя клавишу пробел, стрелки" +
    "влево/вправо или Pg Up и Pg Dn. Клавиши S и B меняют размер шрифта.",

  strings_sv: {
    "slide":"sida",
    "help?":"hjälp",
    "contents?":"innehåll",
    "table of contents":"innehållsförteckning",
    "Table of Contents":"Innehållsförteckning",
    "restart presentation":"visa presentationen från början",
    "restart?":"börja om"
  },
  help_sv:
    "Bläddra med ett klick med vänstra musknappen, mellanslagstangenten, " +
    "vänster- och högerpiltangenterna eller tangenterna Pg Up, Pg Dn. " +
    "Använd tangenterna S och B för att ändra textens storlek.",

// each such language array is declared in the localize array
// which is set on string prototype and used as in "foo".localize();
  localize: {
    "es":this.strings_es,
    "ca":this.strings_ca,
    "cs":this.strings_cs,
    "nl":this.strings_nl,
    "de":this.strings_de,
    "pl":this.strings_pl,
    "fr":this.strings_fr,
    "hu":this.strings_hu,
    "it":this.strings_it,
    "el":this.strings_el,
    "jp":this.strings_ja,
    "zh":this.strings_zh,
    "ru":this.strings_ru,
    "sv":this.strings_sv
  },

  init: function () {
    var i18n = w3c_slidy_i18n;
    var help_text = w3c_slidy.help_text;
    i18n.strings_es[help_text] = i18n.help_es;
    i18n.strings_ca[help_text] = i18n.help_ca;
    i18n.strings_cs[help_text] = i18n.help_cs;
    i18n.strings_nl[help_text] = i18n.help_nl;
    i18n.strings_de[help_text] = i18n.help_de;
    i18n.strings_pl[help_text] = i18n.help_pl;
    i18n.strings_fr[help_text] = i18n.help_fr;
    i18n.strings_hu[help_text] = i18n.help_hu;
    i18n.strings_it[help_text] = i18n.help_it;
    i18n.strings_el[help_text] = i18n.help_el;
    i18n.strings_ja[help_text] = i18n.help_ja;
    i18n.strings_zh[help_text] = i18n.help_zh;
    i18n.strings_ru[help_text] = i18n.help_ru;
    i18n.strings_sv[help_text] = i18n.help_sv;

    w3c_slidy.lang = document.body.parentNode.getAttribute("lang");

    if (!w3c_slidy.lang)
      w3c_slidy.lang = document.body.parentNode.getAttribute("xml:lang");

    if (!w3c_slidy.lang)
      w3c_slidy.lang = "en";

    // add localize method to all strings
    // for use as in "contents".localize()
   String.prototype.localize = function() {
     if (this == "")
       return this;

     // try full language code, e.g. en-US
     var s, lookup = w3c_slidy_i18n.localize[w3c_slidy.lang];

     if (lookup)
     {
       s = lookup[this];

       if (s)
        return s;
     }

     // strip country code suffix, e.g.
     // try en if undefined for en-US
     var lg = w3c_slidy.lang.split("-");

     if (lg.length > 1)
     {
       lookup = w3c_slidy_i18n.localize[lg[0]];

       if (lookup)
       {
         s = lookup[this];

         if (s)
          return s;
       }
     }

     // otherwise string as is
     return this;
   };
  }
};

// hack for back button behavior
if (w3c_slidy.ie6 || w3c_slidy.ie7)
{
  document.write("<iframe id='historyFrame' " +
  "src='javascript:\"<html"+"></"+"html>\"' " +
  "height='1' width='1' " +
  "style='position:absolute;left:-800px'></iframe>");
}

// attach event listeners for initialization
w3c_slidy.set_up();

// hide the slides as soon as body element is available
// to reduce annoying screen mess before the onload event
setTimeout(w3c_slidy.hide_slides, 50);

/*]]>*/
</script>
</head>
<body class="article" style="max-width:45em">
<div id="header" class="slide">
<h1>Enterprise Clojure Training</h1>
<span id="author">Timothy Pratley</span><br />
</div>
<div class="sect1 slide">
<h1 id="_introductions">Introductions</h1>
<div class="sectionbody" style="max-width:45em">
</div>
</div>
<div class="sect1 slide">
<h1 id="_clojure">Clojure</h1>
<div class="sectionbody" style="max-width:45em">
<ul class="">
<li>
<span>
Data
</span>
</li>
<li>
<span>
Functions
</span>
</li>
<li>
<span>
A tool for thought
</span>
</li>
<li>
<span>
Getting stuff done
</span>
</li>
</ul>
</div>
</div>
<div class="sect1 slide">
<h1 id="_syntax_summary">Syntax Summary</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Everything is a list with the operation at the front.</p></div>
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<thead>
<tr>
<th align="left" valign="top">Java </th>
<th align="left" valign="top">Clojure</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><div class="literal"><pre><code>int i = 5; </code></pre></div></td>
<td align="left" valign="top"><div class="literal"><pre><code>(def i 5)</code></pre></div></td>
</tr>
<tr>
<td align="left" valign="top"><div class="literal"><pre><code>if (x == 0)
  return y;
else
  return z;</code></pre></div></td>
<td align="left" valign="top"><div class="literal"><pre><code>(if (zero? x)
  y
  z)</code></pre></div></td>
</tr>
<tr>
<td align="left" valign="top"><div class="literal"><pre><code>x * y * z; </code></pre></div></td>
<td align="left" valign="top"><div class="literal"><pre><code>(* x y z)</code></pre></div></td>
</tr>
<tr>
<td align="left" valign="top"><div class="literal"><pre><code>foo(x, y, z); </code></pre></div></td>
<td align="left" valign="top"><div class="literal"><pre><code>(foo x y z)</code></pre></div></td>
</tr>
<tr>
<td align="left" valign="top"><div class="literal"><pre><code>foo.bar(x); </code></pre></div></td>
<td align="left" valign="top"><div class="literal"><pre><code>(.bar foo x)</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_1_the_clojure_ecosystem">1. The Clojure Ecosystem</h1>
<div class="sectionbody" style="max-width:45em">
<ul class="">
<li>
<span>
Libraries are plain old jars
</span>
</li>
<li>
<span>
Clojure is itself a jar
</span>
</li>
<li>
<span>
Clojure can make direct use of other jars
</span>
</li>
<li>
<span>
Easy to deploy
</span>
</li>
</ul>
</div>
</div>
<div class="sect1 slide">
<h1 id="_a_leiningen">a. Leiningen</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>lein new training
cd training
tree
cat project.clj
cat src/training/core.clj</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_tree">tree</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>.
├── CHANGELOG.md
├── doc
│   └── intro.md
├── LICENSE
├── project.clj
├── README.md
├── resources
├── src
│   └── training
│       └── core.clj
└── test
    └── training
        └── core_test.clj</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_project_clj">project.clj</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>(defproject training "0.1.0-SNAPSHOT"
  :description "FIXME: write description"
  :url "http://example.com/FIXME"
  :license {:name "Eclipse Public License"
            :url "http://www.eclipse.org/legal/epl-v10.html"}
  :dependencies [[org.clojure/clojure "1.8.0"]])</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_src_training_core_clj">src/training/core.clj</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>(ns training.core)</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(defn foo
  "I don't do a whole lot."
  [x]
  (println x "Hello, World!"))</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_b_the_read_eval_print_loop_repl">b. The Read Eval Print Loop (REPL)</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>$ lein repl</code></pre>
</div></div>
<div class="paragraph"><p>When you type in this code:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(+ 1 2)</code></pre>
</div></div>
<div class="paragraph"><p>Clojure evaluates it immediately and returns a result:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>=&gt; 3</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_c_editor_setup">c. Editor setup</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>IntelliJ+CursiveIDE: <a href="https://www.jetbrains.com/idea">https://www.jetbrains.com/idea</a> <a href="https://cursive-ide.com/userguide/">https://cursive-ide.com/userguide/</a></p></div>
<div class="paragraph"><p>Lighttable: <a href="http://lighttable.com">http://lighttable.com</a></p></div>
<div class="paragraph"><p>Browser: <a href="https://repl.it/languages/clojure">https://repl.it/languages/clojure</a></p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_d_exercises">d. Exercises</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Evaluate some math expressions in the REPL:</p></div>
<ul class="">
<li>
<span>
Find the sum of 2 and 3
</span>
</li>
<li>
<span>
What is 31 times 79?
</span>
</li>
<li>
<span>
Divide 10 by 2
</span>
</li>
<li>
<span>
Divide 2 by 10
</span>
</li>
</ul>
<div class="paragraph"><p>Create a new project called <code>training</code>. Open <code>src/training/core.clj</code> with your editor, write some expressions and send them to the REPL:</p></div>
<ul class="">
<li>
<span>
Find the sum of 1, 2, and 3
</span>
</li>
<li>
<span>
Send (println "hello world")
</span>
</li>
</ul>
</div>
</div>
<div class="sect1 slide">
<h1 id="_e_answers">e. Answers</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>(+ 2 3)
=&gt; 5</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(* 31 79)
=&gt; 2449</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(/ 10 2)
=&gt; 5</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(/ 2 10)
=&gt; 1/5</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(+ 1 2 3)
=&gt; 6</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(println "hello world")
=&gt; "hello world"</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_2_clojure_syntax">2. Clojure Syntax</h1>
<div class="sectionbody" style="max-width:45em">
</div>
</div>
<div class="sect1 slide">
<h1 id="_a_primitive_data_types">a. Primitive data types</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Strings are enclosed in double quotes</p></div>
<div class="listingblock">
<div class="content">
<pre><code>"This is a string."</code></pre>
</div></div>
<div class="paragraph"><p>Character literals are preceded by a backslash</p></div>
<div class="listingblock">
<div class="content">
<pre><code>\a \b \c \newline \tab</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_numbers">Numbers</h1>
<div class="sectionbody" style="max-width:45em">
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table">Long</p></td>
<td align="left" valign="top"><p class="table"><code>1</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Double</p></td>
<td align="left" valign="top"><p class="table"><code>3.14</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">BigInteger</p></td>
<td align="left" valign="top"><p class="table"><code>1000000000000N</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">BigDecimal</p></td>
<td align="left" valign="top"><p class="table"><code>1000000000000.1M</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Exponents</p></td>
<td align="left" valign="top"><p class="table"><code>1e3</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Ratio</p></td>
<td align="left" valign="top"><p class="table"><code>2/5</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>Automatically promoted on overflow.</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_truthiness">Truthiness</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Booleans: <code>true</code> and <code>false</code>.</p></div>
<div class="paragraph"><p><code>nil</code> means nothing and is considered false in logical tests.</p></div>
<div class="paragraph"><p>Anything else is truthy.</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_b_lists">b. Lists</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>()</code></pre>
</div></div>
<div class="paragraph"><p>Evaluated as function calls.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(inc 1)
=&gt; 2</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(quote (1 2))
=&gt; (1 2)</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>‘(1 2)
=&gt; (1 2)</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_sequences">Sequences</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>(seq ‘(1 2 3))
=&gt; (1 2 3)</code></pre>
</div></div>
<div class="paragraph"><p>Lazy</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_symbols">Symbols</h1>
<div class="sectionbody" style="max-width:45em">
<ul class="">
<li>
<span>
Begin with an alphabet character
</span>
</li>
<li>
<span>
Can contain numbers and punctuation
</span>
</li>
<li>
<span>
Usually <code>lowercase-words-hyphenated</code>
</span>
</li>
</ul>
</div>
</div>
<div class="sect1 slide">
<h1 id="_resolving_symbols">Resolving symbols</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>inc
=&gt; #object[clojure.core$inc]</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>foo
=&gt; Exception: Unable to resolve symbol foo</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>‘foo
=&gt; foo</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_vectors">Vectors</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>[1 2 3 4]</code></pre>
</div></div>
<ul class="">
<li>
<span>
Order 1 count and lookup by index
</span>
</li>
<li>
<span>
Preferred over lists
</span>
</li>
</ul>
</div>
</div>
<div class="sect1 slide">
<h1 id="_equality">Equality</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Identity and by value</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(= [1 2 3] ‘(1 2 3))
=&gt; true</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_maps">Maps</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>{"Language" "Clojure"
 "Version" 1.5
 "Author" "Rich Hickey"}</code></pre>
</div></div>
<ul class="">
<li>
<span>
Near constant time lookup
</span>
</li>
<li>
<span>
Tuned to be fast
</span>
</li>
<li>
<span>
Replacement for object fields
</span>
</li>
</ul>
</div>
</div>
<div class="sect1 slide">
<h1 id="_keywords">Keywords</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>:language</code></pre>
</div></div>
<ul class="">
<li>
<span>
Shorthand identifiers
</span>
</li>
<li>
<span>
Begin with a colon
</span>
</li>
<li>
<span>
Often used as keys in hashmaps
</span>
<div class="listingblock">
<div class="content">
<pre><code>{:language "Clojure"
 :version 1.5
 :author "Rich Hickey"}</code></pre>
</div></div>
</li>
</ul>
</div>
</div>
<div class="sect1 slide">
<h1 id="_namespaced_keywords">Namespaced keywords</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>:timothy.example/rect</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>::rect
=&gt; :timothy.example/rect</code></pre>
</div></div>
<ul class="">
<li>
<span>
shorthand for current namespace
</span>
</li>
</ul>
</div>
</div>
<div class="sect1 slide">
<h1 id="_sets">Sets</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>#{1 2 3}</code></pre>
</div></div>
<ul class="">
<li>
<span>
Near constant time lookup
</span>
</li>
</ul>
</div>
</div>
<div class="sect1 slide">
<h1 id="_nesting">Nesting</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>{[1 2] {:name "diamond" :type :treasure}
 [3 4] {:name "dragon" :type :monster}}</code></pre>
</div></div>
<ul class="">
<li>
<span>
A map with vector coordinate keys, and map values
</span>
</li>
</ul>
</div>
</div>
<div class="sect1 slide">
<h1 id="_c_invoking_functions">c. Invoking functions</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>(inc 1)
=&gt; 2</code></pre>
</div></div>
<ul class="">
<li>
<span>
Prefix
</span>
</li>
</ul>
</div>
</div>
<div class="sect1 slide">
<h1 id="_d_defining_vars">d. Defining vars</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>(def x)
x
=&gt; #object[clojure.lang.Var$Unbound "Unbound: #'user/x"]</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(def x 1)
x
=&gt; 1</code></pre>
</div></div>
<ul class="">
<li>
<span>
Global mutable reference (use sparingly)
</span>
</li>
<li>
<span>
Dereferenced when evaluated
</span>
</li>
</ul>
</div>
</div>
<div class="sect1 slide">
<h1 id="_atoms">Atoms</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Change over time</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(def a (atom 1))
(swap! a inc)
@a
=&gt; 2</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(deref a)
=&gt; 2</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_e_let">e. Let</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>(let [x 1]
  (inc x))
=&gt; 2</code></pre>
</div></div>
<ul class="">
<li>
<span>
Bind symbols to values in a scope
</span>
</li>
<li>
<span>
Shadow existing bindings
</span>
</li>
<li>
<span>
Prefer <code>let</code> over <code>def</code>
</span>
</li>
</ul>
</div>
</div>
<div class="sect1 slide">
<h1 id="_f_destructuring_binding_forms">f. Destructuring (binding forms)</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>(let [[x y] [1 2]]
  (+ x y))
=&gt; 3</code></pre>
</div></div>
<ul class="">
<li>
<span>
Literal data structure containing symbols
</span>
</li>
<li>
<span>
Matches structure
</span>
</li>
</ul>
</div>
</div>
<div class="sect1 slide">
<h1 id="_destructuring">Destructuring</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Avoids extracting substructure manually:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(defn normalize1 [v]
  (let [x (first v)
        y (second v)
        length (Math/sqrt (+ (* x x) (* y y)))]
    [(/ x length) (/ y length)]))</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(defn normalize2 [[x y]]
  (let [length (Math/sqrt (+ (* x x) (* y y)))]
    [(/ x length) (/ y length)]))</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_destructuring_2">Destructuring</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Available in any binding form</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(for [[k v] m]
  [v k])</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_for_expressions">For expressions</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>(for [i (range 10)
      :when (odd? i)]
  (* i i))
=&gt; (1 9 25 49 81)</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_variadic_functions">Variadic functions</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Destructured using <code>&amp;</code></p></div>
<div class="listingblock">
<div class="content">
<pre><code>(defn sub [&amp; vs]
  vs)</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(sub 1 2 3 4)
=&gt; (1 2 3 4)</code></pre>
</div></div>
<ul class="">
<li>
<span>
Variadic means variable number of arguments
</span>
</li>
<li>
<span>
Arity means number of arguments
</span>
</li>
<li>
<span>
We could have just passed a vector instead
</span>
</li>
</ul>
</div>
</div>
<div class="sect1 slide">
<h1 id="_apply">Apply</h1>
<div class="sectionbody" style="max-width:45em">
<ul class="">
<li>
<span>
Calls a function with a sequence of arguments
</span>
<div class="listingblock">
<div class="content">
<pre><code>(apply + [1 2 3 4])
=&gt; 10</code></pre>
</div></div>
</li>
<li>
<span>
Most mathematical functions are variadic:
</span>
<div class="listingblock">
<div class="content">
<pre><code>(+ 1 2 3)
=&gt; 6</code></pre>
</div></div>
</li>
</ul>
</div>
</div>
<div class="sect1 slide">
<h1 id="_destructuring_a_map">Destructuring a map</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>(:field1 x)
(:field2 x)</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>{:keys [field1 field2]} x</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>{f1 :field1, f2 :field2}</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>{:strs [label1 label2]} x</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_destructuring_a_sequence">Destructuring a sequence:</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>(first x)
(rest x)</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>[a &amp; more]</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_nested_destructuring">Nested destructuring</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>(get-in x [:a :b])</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>{{b :b} :a}</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_more_destructuring">More destructuring</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>:as x</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>:or {field1 "default"}</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_g_namespaces">g. Namespaces</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>(ns training.core
  (:require [clojure.string :as string])
  (:import [java.util Date]))</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(string/upper-case "shout")</code></pre>
</div></div>
<ul class="">
<li>
<span>
First thing in a file
</span>
</li>
<li>
<span>
Must match path and filename
</span>
</li>
<li>
<span>
<code>training.core</code> in <code>src/training/core.clj</code>
</span>
</li>
<li>
<span>
<code>-</code> replaced with <code>_</code> and <code>.</code> replaced with <code>/</code>
</span>
</li>
<li>
<span>
Other forms exist, but prefer this one
</span>
</li>
</ul>
</div>
</div>
<div class="sect1 slide">
<h1 id="_programs">Programs</h1>
<div class="sectionbody" style="max-width:45em">
<ul class="">
<li>
<span>
Expressions which are evaluated to results.
</span>
</li>
<li>
<span>
If an expression needs to be compiled, it will be.
</span>
</li>
<li>
<span>
Can be loaded from files or evaluated dynamically.
</span>
</li>
<li>
<span>
Unit of compilation is a form
</span>
</li>
</ul>
</div>
</div>
<div class="sect1 slide">
<h1 id="_h_regex">h. Regex</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>#"pattern"</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(re-seq #"\w+" "the quick brown fox")
=&gt; ("the" "quick" "brown" "fox")</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_i_exercises">i. Exercises</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Write code into a new file called <code>src/training/syntax.clj</code>, and send the lines to the REPL as you enter them.</p></div>
<ul class="">
<li>
<span>
Set up the new namespace called <code>training.syntax</code>
</span>
</li>
<li>
<span>
Define a var called <code>message</code> bound to the string <code>"greetings"</code>.
</span>
</li>
<li>
<span>
Print out the value of the var <code>message</code>.
</span>
</li>
<li>
<span>
Create a <code>let</code> binding that binds the symbol <code>message</code> to <code>"well hello there"</code>, and prints out <code>message</code> inside the <code>let</code> block.
</span>
</li>
<li>
<span>
Print out message again, outside of the <code>let</code> block.
</span>
</li>
<li>
<span>
Create a let binding that destructures the map
  <code>{:greeting "good morning", :tone "happy"}</code>
  and prints the greeting and tone inside the let block.
</span>
</li>
<li>
<span>
Destructure a single map input containing
  <code>{:greeting "good morning", :tone "happy"}</code>
  and return a string combining greeting and tone.
  Use the <code>str</code> function.
</span>
</li>
</ul>
</div>
</div>
<div class="sect1 slide">
<h1 id="_j_answers">j. Answers</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>(ns training.syntax)
=&gt; nil</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(def message "greetings")
=&gt; #’hello-clojure/message</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(prn message)
=&gt; "greetings"
   nil</code></pre>
</div></div>
<div class="paragraph"><p>Note <code>prn</code> and <code>println</code> behave slightly differently; <code>prn</code> keeps the quotes around strings. This is often useful when experimenting, because you can visually see the type of the values more clearly.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(let [message "well hello there"]
  (prn message))
=&gt; "well hello there"
   nil</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(prn message)
=&gt; "greetings"</code></pre>
</div></div>
<div class="paragraph"><p>Note that the <code>message</code> global var is still the original value.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(def m {:greeting "good morning", :tone "happy"})</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(let [{:keys [greeting tone]} m]
  (prn greeting tone))
=&gt; "good morning" "happy"</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(defn hi [{:keys [greeting tone]}]
  (str greeting " - " tone))</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(hi m)
=&gt; "good morning - happy"</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_3_functions">3. Functions</h1>
<div class="sectionbody" style="max-width:45em">
</div>
</div>
<div class="sect1 slide">
<h1 id="_a_defining_functions">a. Defining functions</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>(defn square [x]
  (* x x))</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(defn square
  "Multiplies a number by itself"
  [x]
  (* x x))</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_functions_continued">Functions continued</h1>
<div class="sectionbody" style="max-width:45em">
<ul class="">
<li>
<span>
All functions return the last expression as a result
</span>
</li>
<li>
<span>
Defn creates a var
</span>
<div class="listingblock">
<div class="content">
<pre><code>(square 2)
=&gt; 4</code></pre>
</div></div>
</li>
<li>
<span>
Mathematical operators in prefix notation.
</span>
<div class="listingblock">
<div class="content">
<pre><code>(+ (square 2) (square 3))
=&gt; 13</code></pre>
</div></div>
</li>
<li>
<span>
Arguments are evaluated from left to right before the function is called
</span>
</li>
</ul>
</div>
</div>
<div class="sect1 slide">
<h1 id="_unnamed_functions">Unnamed functions</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>(fn [a]
  (inc a))</code></pre>
</div></div>
<ul class="">
<li>
<span>
"Unnamed" means "anonymous" means "Lambda expression"
</span>
<div class="listingblock">
<div class="content">
<pre><code>#(inc %)</code></pre>
</div></div>
</li>
<li>
<span>
Special syntax
</span>
<div class="listingblock">
<div class="content">
<pre><code>(#(inc %) 1)
=&gt; 2</code></pre>
</div></div>
</li>
<li>
<span>
Invoked like a named function
</span>
</li>
</ul>
</div>
</div>
<div class="sect1 slide">
<h1 id="_closures">Closures</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Function that captures values from the environment.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(let [who "world"]
  (defn greet []
    (str "Hello " who))</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(greet)
=&gt; "Hello world"</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_functions_are_values">Functions are values</h1>
<div class="sectionbody" style="max-width:45em">
<ul class="">
<li>
<span>
Can be passed as arguments to other functions.
</span>
</li>
<li>
<span>
Functions that take a function as an argument are called higher order functions.
</span>
<div class="listingblock">
<div class="content">
<pre><code>(defn higher-order-function [f]
  (f))</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(higher-order-function greet)
=&gt; "Hello world"</code></pre>
</div></div>
</li>
</ul>
</div>
</div>
<div class="sect1 slide">
<h1 id="_map">Map</h1>
<div class="sectionbody" style="max-width:45em">
<ul class="">
<li>
<span>
Not to be confused with the <code>hash-map</code> data structure
</span>
</li>
<li>
<span>
Function that calls a function on every element in a sequence
</span>
<div class="listingblock">
<div class="content">
<pre><code>(map #(inc %) [1 2 3])
=&gt; (2 3 4)</code></pre>
</div></div>
</li>
<li>
<span>
Higher order function, first argument is a function.
</span>
</li>
<li>
<span>
Unnamed closures are useful as arguments to higher order functions.
</span>
<div class="listingblock">
<div class="content">
<pre><code>(let [x 5]
  (map #(+ x %) [1 2 3]))
=&gt; (6 7 8)</code></pre>
</div></div>
</li>
</ul>
</div>
</div>
<div class="sect1 slide">
<h1 id="_b_pre_and_post_conditions">b. Pre- and post-conditions</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>(defn f [x]
  {:pre [(pos? x)]
   :post [(neg? %) (int? %)]}
  (- x))</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(f 1)
=&gt; -1</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(f -1)
=&gt; AssertionError Assert failed: (pos? x)</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(f 1.5)
=&gt; AssertionError Assert failed: (int? %)</code></pre>
</div></div>
<ul class="">
<li>
<span>
Assertions about inputs and outputs of a function.
</span>
</li>
<li>
<span>
Sequence of conditions
</span>
</li>
<li>
<span>
Rarely used.
</span>
</li>
</ul>
</div>
</div>
<div class="sect1 slide">
<h1 id="_pre_post_drawbacks">Pre/Post drawbacks:</h1>
<div class="sectionbody" style="max-width:45em">
<ul class="">
<li>
<span>
Syntax is easy to get wrong, no assertion made
</span>
</li>
<li>
<span>
Assertions can be disabled
</span>
</li>
<li>
<span>
Less control over error reporting and handling
</span>
</li>
</ul>
</div>
</div>
<div class="sect1 slide">
<h1 id="_more_common">More common</h1>
<div class="sectionbody" style="max-width:45em">
<ul class="">
<li>
<span>
Check for a condition and throw an exception
</span>
<div class="listingblock">
<div class="content">
<pre><code>(defn f [x]
  (when-not (pos? x)
    (throw (ex-info "bad input" {:x x}))
  (let [result (- x)]
    (if (and (neg? result) (int? result))
      result
      (throw (ex-info "bad result" {:x x})))</code></pre>
</div></div>
</li>
<li>
<span>
Or use a schema or spec
</span>
</li>
</ul>
</div>
</div>
<div class="sect1 slide">
<h1 id="_c_anonymous_functions">c. Anonymous functions</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>(fn [x]
  (inc x))</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>((fn [x]
   (inc x)
 1)
=&gt; 2</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(let [f (fn [x]
          (inc x))]
  (f 2))
=&gt; 3</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_often_pass_a_function_to_another_function">Often pass a function to another function</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>(map inc [1 2 3])
=&gt; (2 3 4)</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(map (fn [x] (* x x)) [1 2 3 4])
=&gt; (1 4 9 16)</code></pre>
</div></div>
<ul class="">
<li>
<span>
Don&#8217;t need to create global definitions
</span>
</li>
</ul>
</div>
</div>
<div class="sect1 slide">
<h1 id="_naming_anonymous_functions">Naming anonymous functions?!??!??</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>(fn add-one [x]
  (inc x))</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>add-one
=&gt; Unable to resolve symbol: add-one in this context</code></pre>
</div></div>
<ul class="">
<li>
<span>
Does not create a global var!
</span>
</li>
<li>
<span>
Names the purpose
</span>
</li>
<li>
<span>
Name appears in stacktraces (searchable clue)
</span>
</li>
<li>
<span>
The function can call itself with the name
</span>
</li>
</ul>
</div>
</div>
<div class="sect1 slide">
<h1 id="_note_that">Note that</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>(defn f [x]
  (inc x))</code></pre>
</div></div>
<div class="paragraph"><p>Is shorthand for</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(def f
  (fn [x]
    (inc x)))</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_d_function_literals">d. Function literals</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>#(inc %)
#(+ %1 %2)</code></pre>
</div></div>
<div class="paragraph"><p>Terse but powerful expressions</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(map #(* % %) [1 2 3 4])
=&gt; (1 4 9 16)</code></pre>
</div></div>
<div class="paragraph"><p>Prefer (fn) form: not much more typing, opportunity to name parameters and function</p></div>
<div class="paragraph"><p>Compare with</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(map (fn square [x]
       (* x x))
     [1 2 3 4])
=&gt; (1 4 9 16)</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_e_keyword_and_variadic_arguments">e. Keyword and variadic arguments</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>(defn f [&amp; args]
  args)</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(f 1 2 3)
=&gt; (1 2 3)</code></pre>
</div></div>
<div class="paragraph"><p>Disadvantages:</p></div>
<ul class="">
<li>
<span>
Causing callers to have to apply
</span>
</li>
<li>
<span>
Bypasses arity checking
</span>
</li>
</ul>
</div>
</div>
<div class="sect1 slide">
<h1 id="_antipattern">Antipattern</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>(defn f [x &amp; [y]]
  (if y
    (+ x y)
    (inc x)))</code></pre>
</div></div>
<div class="paragraph"><p>Prefer instead</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(defn f
  ([x] (inc x))
  ([x y] (+ x y)))</code></pre>
</div></div>
<div class="paragraph"><p>Multiple arities should be explicitly declared in parenthesis.</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_keyword_arguments">Keyword arguments</h1>
<div class="sectionbody" style="max-width:45em">
<ul class="">
<li>
<span>
Clojure supports keyword arguments
</span>
</li>
<li>
<span>
Discouraged: it prevents users from passing a map of options
</span>
</li>
<li>
<span>
Cannot apply a map to a keyword argument function
</span>
</li>
<li>
<span>
Use a map argument instead of keyword arguments.
</span>
</li>
</ul>
</div>
</div>
<div class="sect1 slide">
<h1 id="_f_exercises">f. Exercises</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Create a new namespace called <code>fun-functions</code>. Define the following functions and call them with some test input:</p></div>
<ul class="">
<li>
<span>
A function that computes the square of an input number. What is the square of 55?
</span>
</li>
<li>
<span>
A function that takes a number as input, ensures that the number is less than 100, and returns the square of the square of the input.
</span>
</li>
<li>
<span>
A function that takes two numbers as input, and returns a vector where the first element is the second input, and the second element is the sum of the first and second input.
</span>
</li>
</ul>
</div>
</div>
<div class="sect1 slide">
<h1 id="_g_answers">g. Answers</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>(defn square [x]
  (* x x))
(square 55)
=&gt; 3025</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(defn square-of-square [x]
  (if (&lt; x 100)
    (square (square x))
    (throw (ex-info "Input too large" {:x x}))))
(square-of-square 2)
=&gt; 16
(square-of-square 123)
=&gt; ExceptionInfo Input too large</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(defn fib-step [a b]
  [b (+ a b)]))
(fib-step 1 1)
=&gt; [1 2]
(fib-step 1 2)
=&gt; [2 3]
(fib-step 2 3)
=&gt; [3 5]</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_challenge_1_corgi_cover_eligibility">Challenge 1: Corgi Cover eligibility</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Insuricorp is about to launch a marketing campaign for a new “corgi cover” policy. Only certain people are eligible to register for “corgi cover”. To be eligible they must own a corgi, live in either Illinois (IL), Washington (WA), New York (NY), or Colorado (CO). You are tasked with building a system to validate applications for the policy.</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_part_1">Part 1:</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Write a function that will take as input a state and corgi-count, and will return a boolean indicating the person’s eligibility for the “corgi cover” policy.</p></div>
<div class="sect2">
<h3 id="_test_data">Test data:</h3>
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="25%" />
<col width="25%" />
<col width="25%" />
<col width="25%" />
<thead>
<tr>
<th align="left" valign="top">Name </th>
<th align="left" valign="top">State </th>
<th align="left" valign="top">Corgi count </th>
<th align="left" valign="top"> Existing policy count</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><div class="literal"><pre><code>Chloe </code></pre></div></td>
<td align="left" valign="top"><div class="literal"><pre><code>IL </code></pre></div></td>
<td align="left" valign="top"><div class="literal"><pre><code>1 </code></pre></div></td>
<td align="left" valign="top"><div class="literal"><pre><code>0</code></pre></div></td>
</tr>
<tr>
<td align="left" valign="top"><div class="literal"><pre><code>Ethan </code></pre></div></td>
<td align="left" valign="top"><div class="literal"><pre><code>IL </code></pre></div></td>
<td align="left" valign="top"><div class="literal"><pre><code>4 </code></pre></div></td>
<td align="left" valign="top"><div class="literal"><pre><code>2</code></pre></div></td>
</tr>
<tr>
<td align="left" valign="top"><div class="literal"><pre><code>Annabelle </code></pre></div></td>
<td align="left" valign="top"><div class="literal"><pre><code>WY </code></pre></div></td>
<td align="left" valign="top"><div class="literal"><pre><code>19 </code></pre></div></td>
<td align="left" valign="top"><div class="literal"><pre><code>0</code></pre></div></td>
</tr>
<tr>
<td align="left" valign="top"><div class="literal"><pre><code>Logan </code></pre></div></td>
<td align="left" valign="top"><div class="literal"><pre><code>WA </code></pre></div></td>
<td align="left" valign="top"><div class="literal"><pre><code>2 </code></pre></div></td>
<td align="left" valign="top"><div class="literal"><pre><code>1</code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>See <code>if</code> <code>=</code></p></div>
</div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_part_2">Part 2:</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>A focus group of corgi owners has revealed that “corgi cover” needs to be offered at 3 different tiers: “corgi cover silver”, “corgi cover gold”, and “corgi cover platinum”. Platinum is available when covering 7 or more corgis OR covering at least 3 corgis and also having one other policy with Insuricorp. Gold is available when covering at least 3 corgis. Silver is the original “corgi cover” policy. Create a new function that takes an additional argument policy-count and returns a keyword indicating their eligibility.</p></div>
<div class="paragraph"><p>See <code>cond</code></p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_part_3">Part 3:</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>The “corgi cover” applications Insuricorp collect contain more information than necessary to determine eligibility. Create a new function that takes as input a single map data structure as input instead of multiple inputs. It should pick out the values that it needs from the input map. Create some test data and feed it to your function. The data should look something like:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>{:name "Chloe", :state "IL", :corgi-count 1, :policy-count 0}</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_part_4">Part 4:</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Insuricorp just merged with Megacorp. Platinum level corgi cover is now offered to people with an existing Megacorp policy as well. Because the company is still restructuring, the policy-count input still only contains Insuricorp data. But a new input has been made available to you which is a map of people to policies.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>{"Chloe" ["secure goldfish"]
 "Ethan" ["cool cats cover" "megasafe"]}</code></pre>
</div></div>
<div class="paragraph"><p>Create a new function that takes as inputs two maps: the application, and the existing policies. It should apply the same logic, but make use of the Megacorp data.</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_4_testing_with_clojure_test">4. Testing with clojure.test</h1>
<div class="sectionbody" style="max-width:45em">
</div>
</div>
<div class="sect1 slide">
<h1 id="_a_defining_tests_with_deftest">a. Defining tests with deftest</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>You can define a test in any file, but it is common to put all test code in a separate “test” directory, and to create namespaces that mirror the “src” directory but have -test appened. So if we have a source file <code>src/my_namespace.clj</code> then we create a test file as <code>test/my_namespace_test.clj</code>.</p></div>
<div class="paragraph"><p>Test namespaces are normal Clojure namespaces. Test related functions come from the <code>clojure.test</code> namespace, so it is common to refer all symbols from <code>clojure.test</code> for convenience:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(ns my-namespace-test
  (:require [clojure.test :refer :all]))</code></pre>
</div></div>
<div class="paragraph"><p>A test is just a function that takes no arguments and will be called by the Clojure test runner.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(deftest my-test
  (prn "My test ran"))</code></pre>
</div></div>
<div class="paragraph"><p>You can run the tests manually from the REPL:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(run-tests)</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>=&gt; "My test ran"
Ran 0 tests containing 0 assertions.
0 failures, 0 errors.
{:test 0, :pass 0, :fail 0, :error 0, :type :summary}</code></pre>
</div></div>
<div class="paragraph"><p>To run all tests in a project from the command line:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ lein test</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>=&gt; "My test ran"
Ran 0 tests containing 0 assertions.
0 failures, 0 errors.
{:test 0, :pass 0, :fail 0, :error 0, :type :summary}</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_b_lein_test_refresh">b. lein-test-refresh</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Lein-test-refresh is a Leiningen plugin that reloads code and re-runs tests when you save a file.
<a href="https://github.com/jakemcc/lein-test-refresh">https://github.com/jakemcc/lein-test-refresh</a>.</p></div>
<div class="paragraph"><p>Add lein-test-refresh to your <code>~/.lein/profiles.clj</code>. It should look similar to below.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>{:user {:plugins [[com.jakemccrary/lein-test-refresh "0.22.0"]]}}</code></pre>
</div></div>
<div class="paragraph"><p>Alternatively you may add it to your <code>project.clj</code>.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(defproject sample
  :dependencies [[org.clojure/clojure "1.8.0"]]
  :profiles
  {:dev
   {:plugins [[com.jakemccrary/lein-test-refresh "0.22.0"]]}})</code></pre>
</div></div>
<div class="paragraph"><p>Now you can watch for changes from the command line:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ lein test-refresh</code></pre>
</div></div>
<div class="paragraph"><p>If you change <code>my-test</code> now to print a new message, the tests are re-run as soon as you save the file&#8230; giving immediate feedback on your change.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(deftest my-test
  (prn "My test ran immediately"))</code></pre>
</div></div>
<div class="paragraph"><p>Seeing as saving the file executes code, you can use lein-test-refresh like a REPL.</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_c_assertions_with_is_and_are">c. Assertions with is and are</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Let’s begin with a false assertion:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(deftest my-test
  (is (= 1 (inc 1))))</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>    =&gt; FAIL in (my-test)
expected: (= 1 (inc 1))
  actual: (not (= 1 2))</code></pre>
</div></div>
<div class="paragraph"><p>And then convert it to a true assertion:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(deftest my-test
  (is (= 2 (inc 1))))</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>    =&gt; Ran 1 tests containing 1 assertions.
0 failures, 0 errors.</code></pre>
</div></div>
<div class="paragraph"><p>We have written a test that makes an assertion about the function <code>inc</code>. Most tests check for equality with the expected value first, and the actual value second. The expected value is a literal expression and the actual is a call to the function under test. However you are not limited to following this for every test case. You can use any truthy assertion. Here is an example that does not do equality checking:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(deftest my-test
  (is (odd? 1)))</code></pre>
</div></div>
<div class="paragraph"><p>If your assertion expression is not self explanatory, supply an optional string argument which describes the assertion:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(deftest my-test
  (is (= (* 5 5) (+ (* 3 3) (* 4 4)))
    "The square of the hypotenuse is equal to the sum of the squares of the other two sides"))</code></pre>
</div></div>
<div class="paragraph"><p>And to group assertions into logical blocks, use the testing form:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(deftest math-test
  (testing "basic math"
    (is (odd? 1))
    (is (= 2 (inc 1))))
  (testing "pythagoras"
    (is (= (* 5 5) (+ (* 3 3) (* 4 4)))
    "The square of the hypotenuse is equal to the sum of the squares of the other two sides"))</code></pre>
</div></div>
<div class="paragraph"><p>It is also possible to more concisely express multiple assertions using the are form:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(are [x y] (= x y)
     2 (+ 1 1)
     4 (* 2 2))</code></pre>
</div></div>
<div class="paragraph"><p>However I recommend you avoid this form. It is easy to make an error in the syntax, and can be confusing. Furthermore line numbers are not preserved, so a failing test case is harder to identify.</p></div>
<div class="paragraph"><p>Occasionally we need to assert that an exception is thrown:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(defn bad [x]
  (throw (ex-info "oh no" {})))</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(deftest test-exception
  (is (thrown-with-msg? Exception #"oh no"
        (bad 42))))</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_d_test_fixtures">d. Test fixtures</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Test fixtures are for setting up and tearing down resources required by your tests. We can specify :once fixtures that execute one time for all tests in the namespace, or :each fixtures that run around each test in the namespace.</p></div>
<div class="paragraph"><p>A fixture is simply a function that takes a test and executes it. Recall that tests are functions.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(use-fixtures :once
  (fn print-enter-exit [tests]
    (println "before")
    (tests)
    (println "after")))</code></pre>
</div></div>
<div class="paragraph"><p>Now the test runner will print out “before”, execute the tests in the namespace, and then print out “after”.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(use-fixtures :every
  (fn capture-prints [f]
    (with-out-str (f))))</code></pre>
</div></div>
<div class="paragraph"><p>Here we prevent printing within our function from appearing in the console. Usually we want our tests to make assertions, but not produce output. Otherwise the test report can be cluttered.</p></div>
<div class="paragraph"><p>Another common use case is when doing database tests, we can wrap the test execution inside a transaction and rollback after the test completes. This avoids cleaning up data after the tests run, as no data was created.</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_e_using_with_redefs_for_mocking_behavior">e. Using with-redefs for mocking behavior</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Often when we are writing tests we want to isolate particular behaviors. Some parts of a function might not be appropriate to occur during the test. We can conveniently replace the definition of any var during a test using with-redefs:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(defn post [url]
  {:body (str "Hello world")})</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(deftest test-post
  (with-redefs [str (fn [&amp; args]
                       "Goodbye world")]
    (is (= {:body "Goodbye world"}
           (post "http://service.com/greet")))))</code></pre>
</div></div>
<div class="paragraph"><p>At first glance this is very similar to let, but notice that a let would not work in this example. We changed the behavior of the str function whose definition is outside the scope of the test. We replaced it with an anonymous function that always returns “Goodbye world” regardless of its inputs. Note that we could have used (constantly "Goodbye world") instead, which produces an anonymous function just like the one we defined.</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_f_debugging">f. Debugging</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>While working on a function, sometimes it is useful to print out an intermediary value. One way to accomplish this is using doto. Say that we were working on a complicated nested function:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(defn shazam [a b]
  (/ 1 (+ a b) (+ a (* a b))))</code></pre>
</div></div>
<div class="paragraph"><p>And we wanted to see what <code>(+ a (* a b))</code> was evaluating to in the context of the function call. We can temporarily wrap the expression in <code>(doto ... (prn))</code>.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(defn shazam [a b]
  (/ 1 (+ a b) (doto (+ a (* a b)) (prn "***"))))</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(shazam 1 2)
=&gt; 3 "***"
   1/9</code></pre>
</div></div>
<div class="paragraph"><p>The difference from wrapping with just <code>prn</code> is that <code>prn</code> always returns <code>nil</code>, while <code>doto</code> will cause the <code>prn</code> side-effect to occur, but will return the original argument. This is also very useful when interacting with Java, because you can construct an object, call various methods on it, and return the object constructed.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(doto (new java.util.HashMap)
  (.put "a" 1)
  (.put "b" 2))
=&gt; {"a" 1, "b" 2}</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_g_exercises">g. Exercises</h1>
<div class="sectionbody" style="max-width:45em">
<ul class="">
<li>
<span>
Start lein-test-refresh running in your existing project directory.
</span>
</li>
<li>
<span>
Create a new namespace in the “test” directory called <code>training.core-test</code>
</span>
</li>
<li>
<span>
Write a function called <code>pythag</code> that returns the square root of the sum of squares for two inputs.
</span>
</li>
<li>
<span>
Write a test containing an assertion that exercises your function. Expect <code>5</code> when passing <code>4</code> and <code>3</code> as arguments.
</span>
</li>
<li>
<span>
Write another test case with different inputs.
</span>
</li>
<li>
<span>
Introduce a bug into pythag to make sure your tests discover the problem.
</span>
</li>
<li>
<span>
Fix <code>pythag</code> so that all tests pass.
</span>
</li>
<li>
<span>
Copy the test <code>test-post</code> from the "with-redefs" section and modify it so that it counts how many times <code>str</code> gets called. Call <code>post</code> several times and make an assertion about how many times <code>str</code> should get called.
</span>
</li>
</ul>
</div>
</div>
<div class="sect1 slide">
<h1 id="_h_answers">h. Answers</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>(defn pythag [a b]
  (Math/sqrt (+ (* a a) (* b b))))</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(deftest test-pythag
  (is (= 5 (pythag 4 3)))
  (is (= 13 (pythag 12 5))))</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(defn post [url]
  {:body (str "Hello world")})</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(deftest test-post
  (let [c (atom 0)]
    (with-redefs [str (fn [&amp; args]
                        (swap! c inc)
                        "Goodbye world")]
      (post "http://service.com/greet")
      (post "http://service.com/greet")
      (post "http://service.com/greet")
      (is (= 3 @c)))))</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_5_control_flow">5. Control Flow</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Clojure provides special forms for control flow. Special forms are built in primitives that behave differently from functions. We already saw several special forms in action: <code>def</code>, <code>let</code>, <code>quote</code> and <code>fn</code> are all special forms. The main thing that is different about them is that they don’t evaluate all their arguments like a regular function call.</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_a_conditionals_if_when_cond">a. Conditionals: if, when, cond</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Another special form is if which chooses between two options.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(if (pos? 1)
  (println "one is positive")
  (println "or is it?"))
=&gt; "one is positive"</code></pre>
</div></div>
<div class="paragraph"><p>Only one branch is evaluated, whereas a function call evaluates all arguments.</p></div>
<div class="paragraph"><p>Often we want to execute some code only when a condition is met:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(when (pos? 1)
  (println "one is positive")
  (println "multiple expressions allowed"))
=&gt; "one is positive"
   "multiple expressions allowed"</code></pre>
</div></div>
<div class="paragraph"><p>When the test fails, nothing is evaluated, when it passes, everything in the body is evaluated.</p></div>
<div class="paragraph"><p>Cond allows for multiple branches.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(def x {:cake 1})
(cond (= x 1) "one"
      (= x :cake) "the cake is a lie"
      (map? x) "it’s a map!"
      :else "not sure what it is")
=&gt; "it’s a map!"</code></pre>
</div></div>
<div class="paragraph"><p>Note that <code>:else</code> is not a special keyword, it just happens to be a truthy value.</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_b_recursion">b. Recursion</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Functions that call themselves are called recursive. Here is an example of recursion:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(defn sum-up [coll result]
  (if (empty? coll)
    result
    (sum-up (rest coll) (+ result (first coll)))))</code></pre>
</div></div>
<div class="paragraph"><p>In Clojure there is a special way to do recursion which avoids consuming the stack:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(defn sum-up-with-recur [coll result]
  (if (empty? coll)
    result
    (recur (rest coll) (+ result (first coll)))))</code></pre>
</div></div>
<div class="paragraph"><p>Recur can only occur at the last position of a function (where scope can be discarded).</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_c_loops">c. Loops</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Loop establishes bindings, and allows you to recur back to the start of the loop with new values.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(loop [a 0
       b 1]
  (if (&lt; b 1000)
    (recur b (+ a b))
    a))
=&gt; fib number below 1000</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_d_exception_handling">d. Exception handling</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>You can work with exceptions using try catch finally and throw.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(try
  (inc "cat")
  (catch Exception e
    (println "cat cannot be incremented")))</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_e_comments">e. Comments</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Anything following a semicolon is a comment</p></div>
<div class="listingblock">
<div class="content">
<pre><code>; this is an inline comment
;; this is a function level comment</code></pre>
</div></div>
<div class="paragraph"><p>Less common is the comment form:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(comment anything)</code></pre>
</div></div>
<div class="paragraph"><p>And a special form for complete removal of any form it is prefixed to</p></div>
<div class="listingblock">
<div class="content">
<pre><code>#_(this form is removed)</code></pre>
</div></div>
<div class="paragraph"><p>Which is handy for temporarily removing a form when modifying code. You can use hash-underscore multiple times to comment out multiple forms.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>#_#_ ignored-1 ignored-2</code></pre>
</div></div>
<div class="paragraph"><p>I call this the bug eyes operator, because it looks like a bug emoji.</p></div>
<div class="paragraph"><p>Commas are optional and treated as whitespace.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(= {:a 1, :b 2, :c 3} {:a 1 :b 2 :c 3})</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_f_exercises_2">f. Exercises</h1>
<div class="sectionbody" style="max-width:45em">
<ul class="">
<li>
<span>
Create a function that given a test score between 0 and 100 returns a grade A B C D or F for fail.
</span>
</li>
<li>
<span>
Write a function that takes a number and uses a loop to calculate the factorial of that number. Factorial 5 is 1*2*3*4*5.
</span>
</li>
<li>
<span>
Write a new version of factorial that does not use a loop but recursively calls itself.
</span>
</li>
<li>
<span>
Write a loop for the Fibonacci sequence (1 1 2 3 5 8 13) that finds the maximum Fibonacci number less than 100. The sequence is defined by n2 = n1 + n0.
</span>
</li>
</ul>
</div>
</div>
<div class="sect1 slide">
<h1 id="_g_answers_2">g. Answers</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>(def grade [score]
  (cond (&gt;= score 90) "A"
        (&gt;= score 80) "B"
        (&gt;= score 70) "C"
        (&gt;= score 60) "D"
        :else "F"))</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(defn factorial [n]
  (loop [acc 1
         x n]
    (if (&lt;= x 1)
      acc
      (recur (* acc x) (dec x)))))
(deftest factorial-test
  (is (= 120 (factorial 5))))</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(defn factorial2
  ([n] (factorial 1 n))
  ([acc n]
   (if (&lt;= n 1)
     acc
     (recur (* acc n) (dec n)))))
(deftest factorial2-test
  (is (= 120 (factorial2 5))))</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(defn fib [limit]
  (loop [a 1
         b 1]
    (if (&gt;= b limit)
      a
      (recur b (+ a b)))))
(deftest fib-test
  (is (= 89 (fib 100))))</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_6_functional_programming">6. Functional Programming</h1>
<div class="sectionbody" style="max-width:45em">
</div>
</div>
<div class="sect1 slide">
<h1 id="_a_pure_functions_and_side_effects">a. Pure functions and side effects</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>You have probably noticed that Clojure functions always return a value. Moreover they usually return a useful result, not just a nil. There is a distinction to be made between functions which produce useful result values from functions which cause side-effects.</p></div>
<div class="paragraph"><p>Functions that produces side effects are often called in a way that discards their result. For example calling <code>(println "hi")</code> is done not because we want a result. <code>println</code> returns <code>nil</code>, which is useless. What we want is to print to System out the string <code>"hi"</code>, which occurs as a side-effect of us calling the function. Contrast that with calling <code>(str "hi" "there")</code>, which returns a new string <code>"hithere"</code>; no side-effects occur.</p></div>
<div class="paragraph"><p>A function with no side-effects is a pure function. Calling pure functions with a given input always results with the same corresponding output. Note that <code>rand</code> is not a pure function even though it returns a useful result, because it produces a different output every time.</p></div>
<div class="paragraph"><p>Pure functions are desirable because they are:</p></div>
<ul class="">
<li>
<span>
easier to reason about
</span>
</li>
<li>
<span>
easier to combine
</span>
</li>
<li>
<span>
easier to test
</span>
</li>
<li>
<span>
easier to debug
</span>
</li>
<li>
<span>
easier to parallelize
</span>
</li>
</ul>
<div class="paragraph"><p>The Clojure api provides many pure functions. For example <code>conj</code> does not add something to a vector, it returns a completely new vector!</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(def v [1 2])
(conj v 3)
=&gt; [1 2 3]</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>v
=&gt; [1 2]</code></pre>
</div></div>
<div class="paragraph"><p>In this example we can see that v remained unchanged. Clojure implements data structures that enable this to happen efficiently. Using a regular Java vector would require duplicating the vector, but Clojure makes use of a technique called shared structure to provide immutable data structures that don’t require the entire object to be duplicated.</p></div>
<div class="paragraph"><p>Clojure does allow side-effects, indeed they are very useful. It is good style to keep side-effects co-located instead of having them occur throughout various parts of the code. We will see some good examples of this philosophy in action later in the course when we get to atoms. We can use pure function to calculate the next value to be assigned to an atom given the current value. The logic is separate from the side effect.</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_b_apply_partial_and_comp">b. Apply, partial, and comp</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>If you have 4 numbers and want the max, you can call</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(max 1 2 5 3)
=&gt; 5</code></pre>
</div></div>
<div class="paragraph"><p>But what if you have a sequence of many numbers? What if you don’t know how many numbers there will be? Fortunately there is a way to convert a sequence of arguments into a function call:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(apply max [1 2 5 3])
=&gt; 5</code></pre>
</div></div>
<div class="paragraph"><p>This is especially useful when calling variadic functions like max. Note that we could have alternatively reduced over the sequence, but apply is much more concise and clear about the intent.</p></div>
<div class="paragraph"><p>In Clojure we often pass functions as values, so there is a convenient way to create a function that consumes some arguments that can be used with additional arguments later:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(partial + 1)</code></pre>
</div></div>
<div class="paragraph"><p>Creates a function that adds 1 to any number of arguments supplied. It returns a function that is equivalent to:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(fn [&amp; args]
  (apply + 1 args))</code></pre>
</div></div>
<div class="paragraph"><p>So let’s see how we might make use of that:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>((partial + 1) 2 3)
=&gt; 6</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(map (partial / 1) (range 1 5))
=&gt; (1 1/2 1/3 1/4)</code></pre>
</div></div>
<div class="paragraph"><p>In the previous example, we could have instead written:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(map #(/ 1 %) (range 1 5))
=&gt; (1 1/2 1/3 1/4)</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_c_functions_on_sequences_map_reduce_and_friends">c. Functions on sequences: map, reduce, and friends</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>To really embrace Clojure is to think in terms of sequences and data structures.</p></div>
<div class="paragraph"><p>The most basic way to construct a sequence is like so:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(cons 1 ())
=&gt; (1)</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(cons 3 (cons 2 (cons 1 ())))
=&gt; (3 2 1)</code></pre>
</div></div>
<div class="paragraph"><p>But Clojure provides several easier ways to create a sequence:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(range 10)
=&gt; (0 1 2 3 4 5 6 7 8 9)</code></pre>
</div></div>
<div class="paragraph"><p>Be careful though, Clojure can produce infinite sequences (don’t do this in a REPL):</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(range)</code></pre>
</div></div>
<div class="paragraph"><p>This would attempt to keep producing numbers forever. (Press control-c to cancel the REPL if you did try this). There is a way to limit the amount of values to take:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(take 5 (range))
=&gt; (0 1 2 3 4)</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(drop 5 (take 5 (range)))
=&gt; (5 6 7 8 9)</code></pre>
</div></div>
<div class="paragraph"><p>Clojure has an excellent sequence abstraction that fits naturally into the language. From a vector <code>[1 2 3 4]</code> we can find the odd numbers by calling the filter function:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(filter odd? [1 2 3 4])
=&gt; (1 3)</code></pre>
</div></div>
<div class="paragraph"><p>Here we called the filter function with two arguments: the <code>odd?</code> function and a vector of integers. filter is a higher order function, since it takes an input function to use in its computation. The result is a sequence of odd values. Functions like filter that operate on sequences call seq on their arguments to convert collections to sequences. The underlying mechanism is the <code>ISeq</code> interface, which allows many collection data structures to provide access to their elements.</p></div>
<div class="paragraph"><p><code>map</code> is a function that calls another function for every element in a sequence:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(map inc [1 2 3 4])
=&gt; (2 3 4 5)</code></pre>
</div></div>
<div class="paragraph"><p>The result is a sequence of the increment of each number in <code>[1 2 3 4]</code>.</p></div>
<div class="paragraph"><p>Sequences can be used as input arguments to other functions as shown here:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(filter odd? (map inc [1 2 3 4]))
=&gt; (3 5)</code></pre>
</div></div>
<div class="paragraph"><p>Here we filtered by <code>odd?</code> the values from <code>(2 3 4 5)</code>, which was the result of calling <code>map</code>.</p></div>
<div class="paragraph"><p>To aggregate across a sequence, use <code>reduce</code>:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(reduce * [1 2 3 4])
=&gt; 24</code></pre>
</div></div>
<div class="paragraph"><p>For each element in the sequence, reduce computes <code>(* aggregate element)</code> and passes the result of that as the aggregate for the next calculation. The first element <code>1</code> is used as the initial value of aggregate. The final result is 1 * 2 * 3 * 4.</p></div>
<div class="paragraph"><p>Clojure provides a built-in function for grouped aggregates:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(group-by count ["the" "quick" "brown" "fox"])
=&gt; {3 ["the" "fox"], 5 ["quick" "brown"]}</code></pre>
</div></div>
<div class="paragraph"><p>3 letter words are "the" and "fox", whereas 5 letter words are "quick" and "brown".</p></div>
<div class="paragraph"><p><code>filter</code> is like a Java loop:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>for (i=0; i &lt; vector.length; i++)
        if (condition)
            result.append(vector[i]);</code></pre>
</div></div>
<div class="paragraph"><p><code>map</code> is like a Java loop:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>for (i=0; i &lt; vector.length; i++)
    result[i] = func(vector[i]);</code></pre>
</div></div>
<div class="paragraph"><p><code>reduce</code> is like a Java loop:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>for (i=0; i &lt; vector.length; i++)
    result = func(result, vector[i]);</code></pre>
</div></div>
<div class="paragraph"><p>Sequence abstractions are like names for loops that you can add to your vocabulary to talk about and recognize different kinds of loops. Learning the names of the abstractions and patterns that replace loops is an effort, but it adds powerful words to a programmer’s vocabulary. A large vocabulary facilitates reasoning more succinctly, communicating more effectively, and writing less code that does more.</p></div>
<div class="paragraph"><p>Clojure provides a special form <code>#()</code> to create an anonymous function:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>#(&lt; % 3)</code></pre>
</div></div>
<div class="paragraph"><p>The <code>%</code> symbol is an implied input argument. This function takes one argument and returns <code>true</code> if the input argument is less than <code>3</code>, otherwise it is <code>false</code>. Anonymous functions are handy for adding small snippets of logic:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(filter #(&lt; % 3) [1 2 3 4 5]))
=&gt; (0 1 2)</code></pre>
</div></div>
<div class="paragraph"><p>This keeps only numbers less than <code>3</code>. Now let’s create a sequence of odd/even labels for each number in the vector:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(map #(if (odd? %) "odd" "even") [1 2 3 4 5])
=&gt; ("odd" "even" "odd" "even" "odd")</code></pre>
</div></div>
<div class="paragraph"><p>Sequence abstractions are more concise and descriptive than loops, especially when filtering multiple conditions, or performing multiple operations.</p></div>
<div class="paragraph"><p>Clojure also has useful functions for constructing sequences:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(range 5)
=&gt; (0 1 2 3 4)</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(repeat 3 1)
=&gt; (1 1 1)</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(partition 3 (range 9))
=&gt; ((0 1 2) (3 4 5) (6 7 8))</code></pre>
</div></div>
<div class="paragraph"><p>One situation that appears difficult to use a sequence abstraction in is when we have a vector of numbers and wish to perform a sequence operation that relies upon the previous value visited. For example, think about finding the sum of each pair in <code>[1 2 3 4 5]</code>. Using an imperative style loop we can peek into the vector at the previous value:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>for (i=1; i &lt; v.length; i++)
    print v[i] + v[i-1];
=&gt; 3 5 7 9</code></pre>
</div></div>
<div class="paragraph"><p>Can we represent this as a sequence? Yes! Imagine two identical sequences offset slightly:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>  [1 2 3 4 5]
[1 2 3 4 5]</code></pre>
</div></div>
<div class="paragraph"><p>The overlapping values are the pairs we want.</p></div>
<div class="paragraph"><p><code>map</code> can take multiple sequences from which to pull arguments for the input function:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(map + [1 3]
       [2 4])
=&gt; (3 7)</code></pre>
</div></div>
<div class="paragraph"><p>Here <code>1</code> adds to <code>2</code> to make <code>3</code>, and <code>3</code> adds to <code>4</code> to make <code>7</code>.</p></div>
<div class="paragraph"><p><code>rest</code> is a function which returns the input sequence without its first element:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(def v [1 2 3 4 5])
(rest v)
=&gt; (2 3 4 5)</code></pre>
</div></div>
<div class="paragraph"><p>Putting them together:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(map + v (rest v))
=&gt; (3 5 7 9)</code></pre>
</div></div>
<div class="paragraph"><p>We called map on the addition function over both input sequences:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>v        =&gt; (1 2 3 4 5)
(rest v) =&gt; (2 3 4 5)</code></pre>
</div></div>
<div class="paragraph"><p>The input sequences were of different lengths, so map stopped when the smallest sequence was exhausted. The result was a new sequence of the pairwise sums:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(3 5 7 9)</code></pre>
</div></div>
<div class="paragraph"><p>Why are sequence abstractions better than loops? When reading a loop you must comprehend the entire block of code to know what it does. As the loop body grows and changes you must mentally keep track of more complexity. Mistakes like “off by one” are hard to spot, and can creep in as the code changes. Testing requires the invasion of the loop with breakpoints. You may find yourself duplicating a loop to customize some similar operation. The loop abstraction is very easy to understand and use, but it does not provide leverage.</p></div>
<div class="paragraph"><p>Imagine discovering a new requirement where you need to multiply all of those numbers together. The change is invasive to the imperative loop:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>result = 1;
for (i=1; i &lt; v.length; i++)
    result *= (v[i] + v[i-1]);
=&gt; 945</code></pre>
</div></div>
<div class="paragraph"><p>The change occurs inside the loop with the addition and multiplication intertwined.</p></div>
<div class="paragraph"><p>Contrast this with modifying the Clojure sequence. We compose a reduce with the original map expression:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(reduce * (map + v (rest v)))
=&gt; 945</code></pre>
</div></div>
<ul class="">
<li>
<span>
<code>reduce</code>: Aggregate by multiplication the sequence
</span>
</li>
<li>
<span>
<code>map</code>: adding items together from two sequences
</span>
</li>
<li>
<span>
<code>pairing</code>: the sequence of elements in v, adjacent to the rest of v
</span>
</li>
</ul>
<div class="paragraph"><p>This is dense, but descriptive code&#8230; if you know the vocabulary.</p></div>
<div class="paragraph"><p>With a sequence you can write unit tests for the component sequences and operations, reuse the same sequence without writing new code, and reason about the transformations as composable parts.</p></div>
<div class="paragraph"><p>Look out for opportunities to name your steps by identifying long expressions and creating a named function out of them.</p></div>
<div class="paragraph"><p>Clojure exposes a sequence interface over data collections to a rich set of functions that compose well. Three important functional sequence concepts are: filter, which retains each item in a sequence where some function evaluates to be truthy; map, which selects new values by calling a function over input sequence(s) to create a new sequence; and reduce, which aggregates a sequence and returns a single value.</p></div>
<div class="paragraph"><p>I invite you to take the “no loops” challenge. The next time you spot a loop stop and think about what sequence operation the loop represents. Think about how to rewrite the loop as sequence operations instead. It will take time and mental effort, but you will be rewarded with a deeper understanding of the problem being solved. Whenever you see a loop, think about how it could be expressed as a sequence. Sequences are loop abstractions that allow you to ignore the implementation details.</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_d_threading_operators">d. Threading operators</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>By now, you should be feeling the combinatorial power functions offer. Simple functions compose sequence operations together to build transforms. Clojure has almost one hundred functions related to sequences, so you should also be feeling wary of such dense code. If we keep adding layers of function calls, the code becomes cryptic:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(reduce * (filter odd? (map inc v)))
=&gt; 15</code></pre>
</div></div>
<div class="paragraph"><p>With three layers of function calls, things are getting hard to keep in our head all at once. This expression may be easier to mentally process by starting from the innermost map, working out to filter, and then out to reduce last. But that is the opposite of our reading direction and locating the true starting point is difficult.</p></div>
<div class="paragraph"><p>The presentation of sequence operations is clearer if you name intermediary results:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(let [incs (map inc v)
      odd-incs (filter odd? incs)]
  (reduce * odd-incs))
=&gt; 15</code></pre>
</div></div>
<div class="paragraph"><p>Or use a thread last:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(-&gt;&gt; v
    (map inc)
    (filter odd?)
    (reduce *))
=&gt; 15</code></pre>
</div></div>
<div class="paragraph"><p>Threading is good for unwrapping deeply nested function calls, or avoiding naming intermediary steps that don’t have a natural name.</p></div>
<div class="paragraph"><p>Thread first is similar, but passes the value in the first position</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(-&gt; 42 (/ 2) (inc))
=&gt; 22</code></pre>
</div></div>
<div class="paragraph"><p>Note that for empty expressions, the parenthesis are optional.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(-&gt; 42 (/ 2) inc)
=&gt; 22</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_e_data_structures_are_functions">e. Data structures are functions!</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Maps sets vectors and keywords are functions. They delegate to get. While it is possible to use get to access collections, calling the collection directly is more common.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(get {:a 1 :b 2} :a)
=&gt; 1</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>({:a 1 :b 2} :a)
=&gt; 1</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(:a {:a 1 :b 2})
=&gt; 1</code></pre>
</div></div>
<div class="paragraph"><p>This is useful because you don’t need to create a function to call get.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(map (fn [m] (get m :a)) [{:a 1} {:a 2} {:a 3}])
=&gt; (1 2 3)</code></pre>
</div></div>
<div class="paragraph"><p>Can instead be written as:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(map :a [{:a 1} {:a 2} {:a 3}])
=&gt; (1 2 3)</code></pre>
</div></div>
<div class="paragraph"><p>Where we are looking up the value associated with :a for each element in a vector of maps.</p></div>
<div class="paragraph"><p>Sets implement get:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(get #{1 2 3} 2)
=&gt; 2</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(#{1 2 3} 2)
=&gt; 2</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(remove #{nil "bad"} [:a nil :b "bad" "good"])</code></pre>
</div></div>
<div class="paragraph"><p>And so do vectors:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(get [1 2 3] 0)
=&gt; 1</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>([1 2 3] 0)
=&gt; 1</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_f_exercises_3">f. Exercises</h1>
<div class="sectionbody" style="max-width:45em">
<ul class="">
<li>
<span>
Write a function that takes two inputs, and returns the sum of the numbers in a range between two input integers, including the two input numbers.
</span>
</li>
<li>
<span>
Write a function that produces a sequence of powers of 2: (1 2 4 8 16 …)
</span>
</li>
<li>
<span>
Write a function that takes a string and produces a sequence of characters with no vowels.
</span>
</li>
<li>
<span>
Write a function that produces a sequence: (1 ½ ⅓ ¼ …)
</span>
</li>
<li>
<span>
Write a function that produces a sequence: (1  ½ ¼ ⅛ …)
</span>
</li>
<li>
<span>
Write a function that produces the Fibonacci sequence (1 1 2 3 5 8 13 21)
</span>
</li>
</ul>
</div>
</div>
<div class="sect1 slide">
<h1 id="_g_answers_3">g. Answers</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>(defn sum-between [a b]
  (apply + (range a (inc b))))
(sum-between 3 5)
=&gt; 12</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(defn powers-of [n]
  (iterate #(* % n) 1))
(take 5 (powers-of 2))
=&gt; (1 2 4 8 16)</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(defn shorten [s]
  (remove #{\a \e \i \o \u} s))
(apply str (shorten "Clojure sets are functions"))
=&gt; "Cljr sts r fnctns"</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(defn fractions []
  (map / (repeat 1) (rest (range))))
(take 5 (fractions))
=&gt; (1 1/2 1/3 1/4 1/5)</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(defn fraction-powers [n]
  (map / (repeat 1) (powers-of n)))
(take 5 (fraction-powers 2))
=&gt; (1 1/2 1/4 1/8 1/16)</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(defn fib-step [[a b]]
  [b (+ a b)])
(defn fib-seq []
  (map first (iterate fib-step [1 1])))
(take 10 (fib-seq))
=&gt; (1 1 2 3 5 8 13 21 34 55)</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_challenge_2_processing_files">Challenge 2: Processing files</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Insuricorp branches collect applications for the “corgi cover” policy and periodically send them to headquarters in a large comma separated text file. You have been tasked with processing the files using the validation logic you built earlier.</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_part_1_2">Part 1:</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Create a function that opens a file called corgi-cover-applications.csv and converts every row into a data structure and prints it. Next use that data structure as an input to your validation function and print the result. (see slurp, line-seq, clojure.string/split).</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_part_2_2">Part 2:</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>The downstream Insuricorp systems will only be operating on corgi cover applications that pass your eligibility check, but the invalid corgi cover applications need to be sent back to the branches so that they can follow up with the customers on why they are not eligible. Create a new function that opens two output files and writes to them based upon your eligibility check. The files should be called eligible-corgi-cover-applications.csv and ineligible-corgi-cover-applications.csv</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_part_3_2">Part 3:</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>A request has come in from several Insuricorp branches that if a person is ineligible for corgi cover, a short reason be supplied. That way the sales reps don’t have to spend time figuring out what they need to tell the customer. Create a new validation function that instead of returning a boolean, returns nil if no problems are found, or returns a string with the reason if a problem is found. Create a new processing function that splits the applications into two files based on the new validator.</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_part_4_2">Part 4:</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>As part of the Megacorp merger, the downstream systems are converting to JSON format. Create a new function that writes JSON data to a eligible-corgi-cover-applications.json file</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_7_macros">7. Macros</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Macros manipulate the operand forms instead of evaluating them as input arguments. They are not functions, and cannot be used as values or arguments to functions. We already used a macro; defn is a macro for conveniently defining functions.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(defn square [x] (* x x))</code></pre>
</div></div>
<div class="paragraph"><p>Actually expands to a def and fn form:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(def square (fn [x] (* x x)))</code></pre>
</div></div>
<div class="paragraph"><p>The difference between macros and functions is that macro arguments are manipulated at compile time instead of evaluated. Macros allow the user to extend the syntax of Clojure, but macros are less useful than functions as they cannot be used as values or arguments to higher order functions.</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_a_expanding_macros">a. Expanding macros</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Macros provide syntactic sugar. Macros first expand to produce new code that then gets compiled. The form is expanded at compile time through manipulation of the form. You can examine the expansion using <code>macroexpand-1</code>:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(macroexpand-1 '(defn square [x] (* x x)))
=&gt; (def my-namespace/square
     (clojure.core/fn
       ([my-namespace/x]
        (clojure.core/* my-namespace/x my-namespace/x))))</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_b_defining_macros">b. Defining macros</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Consider two different definitions of zen:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(defmacro zen1 [x]
  (println "x:" x) x)</code></pre>
</div></div>
<div class="paragraph"><p>and</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(defn zen2 [x]
  (println "x:" x) x)</code></pre>
</div></div>
<div class="paragraph"><p>Now call</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(zen1 (+ 1 2))
=&gt; x:(+ 1 2)
3</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(zen2 (+ 1 2))
=&gt; x:3
3</code></pre>
</div></div>
<div class="paragraph"><p>The final result is the same, but notice that the input to <code>zen1</code> was a list, where as the input to <code>zen2</code> was the result of evaluating the list. That’s the key difference between a macro and a function.</p></div>
<div class="paragraph"><p>Macros themselves are really just functions with a <code>:macro</code> flag set in their metadata, which causes them to be passed in the input forms unevaluated, and caused the result to be evaluated. This last part is less obvious&#8230; but think back to <code>zen1</code>&#8230; <code>x</code> was a list, we returned <code>x</code>, but the final result wasn’t a list&#8230; it was <code>3</code>. The list was evaluated as a function call to <code>+</code>, resulting in <code>3</code>.</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_c_syntax_quoting">c. Syntax quoting</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>To help write macros there is a special quoting form called syntax-quote.</p></div>
<div class="paragraph"><p>Back-quote (```) Unquote (<code>~</code>) and Unquote-splicing (<code>~@</code>)</p></div>
<div class="listingblock">
<div class="content">
<pre><code>‘(1 2 ~(+ 1 2) ~@(map inc [3 4 5]))
=&gt; (1 2 3 4 5 6)</code></pre>
</div></div>
<div class="paragraph"><p>All symbols in a syntax-quote form get fully qualified.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>`(inc 1)
=&gt; (clojure.core/inc 1)</code></pre>
</div></div>
<div class="paragraph"><p>Fully qualified symbols is desirable when creating macros, otherwise symbols may have another meaning in the context that the macro is expanded in:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(defmacro m1 []
  '(inc 1))
(defmacro m2 []
  `(inc 1))
(let [inc dec]
  {:m1 (m1)
   :m2 (m2)})
=&gt; {:m1 0, :m2 2}</code></pre>
</div></div>
<div class="paragraph"><p>Within the <code>let</code> block, the symbol <code>inc</code> has a different meaning than normal. Because <code>m2</code> uses syntax quote, <code>inc</code> gets fully qualified to <code>clojure.core/inc</code> which does not collide with the <code>let</code> binding.</p></div>
<div class="paragraph"><p>Fully qualified symbols avoids one source of collisions, but there is another:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(defmacro bad [expr]
  (list 'let '[a 1]
    (list 'inc expr)))</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(bad 0)
=&gt; 1</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(def a 0)
(bad a)
=&gt; 2</code></pre>
</div></div>
<div class="paragraph"><p>This might seem confusing, unless you notice that:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(macroexpand-1 '(bad a))
=&gt; (let [a 1] (inc a))</code></pre>
</div></div>
<div class="paragraph"><p>Instead of inc operating on the input parameter, it is operating on an internal let bound value. To avoid this situation Clojure provides a let gensyms form which will produce a randomly named binding:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(defmacro good [expr]
  `(let [a# 1]
     (inc ~expr)))</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(good a)
=&gt; 1</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(good 0)
=&gt; 1</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(macroexpand-1 '(good a))
=&gt; (clojure.core/let [a__6500__auto__ 1] (clojure.core/inc a))</code></pre>
</div></div>
<div class="paragraph"><p>The <code>let</code> binding <code>a#</code> expands out to a randomly generated symbol unlikely to collide with existing symbols.</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_d_code_as_data">d. Code as data</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>You may have noticed when we write a macro, we are really writing a function that produces code. The output is code… as data, and we manipulate code… as data. Homoiconic means that the language text has the same structure as its abstract syntax tree (AST). This allows all code in the language to be accessed and transformed as data, using the same representation. Nested code is well represented as a data structure.</p></div>
<div class="paragraph"><p>When working on a non-trivial macro a good strategy is:</p></div>
<ul class="">
<li>
<span>
Step 1: Write a function!
</span>
</li>
<li>
<span>
Step 2: Call your function from the macro.
</span>
</li>
</ul>
<div class="paragraph"><p>Stated another way; keep the macro as small as possible, and offload transformations to functions.</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_e_exercises">e. Exercises</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Create the following macros and test cases:</p></div>
<ul class="">
<li>
<span>
Create a macro called ignore which accepts any number of expressions, does absolutely nothing, and always returns <code>nil</code>.
</span>
<div class="listingblock">
<div class="content">
<pre><code>(ignore (println "hello???") (inc 42))</code></pre>
</div></div>
</li>
<li>
<span>
Define your own version of the when macro. When is like if, but only has one branch and allows multiple statements.
</span>
<div class="listingblock">
<div class="content">
<pre><code>(when2 (pos? x)
  (println "Positive:" x)
  (inc x))</code></pre>
</div></div>
</li>
<li>
<span>
Write a spy macro. Spy wraps an expression and prints out its value.
</span>
<div class="listingblock">
<div class="content">
<pre><code>(* (spy (+ 1 2)) 3)
=&gt; Expression (+ 1 2) has value 3
   9</code></pre>
</div></div>
</li>
<li>
<span>
Write your own version of the <code>or</code> macro
</span>
<div class="listingblock">
<div class="content">
<pre><code>(or2 (pos? 1) (println "does not execute"))</code></pre>
</div></div>
</li>
</ul>
</div>
</div>
<div class="sect1 slide">
<h1 id="_f_answers">f. Answers</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>(defmacro ignore  [expr]  nil)</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(defmacro when2 [test &amp; body]
  (list 'if test (cons ‘do body))</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(defmacro spy [expr]
  `(let [result# ~expr]
     (println "Expression" '~expr "has value" result#)
     result#))
(macroexpand-1 '(spy (* 2 3)))
=&gt; (clojure.core/let [result__6418__auto__ (* 2 3)]
     (clojure.core/println
       "Expression" (quote (* 2 3))
       "has value" result__6418__auto__)
     result__6418__auto__)
(+ 1 (spy (* 2 3)))
=&gt; Expression (* 2 3) has value 6
   7</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(defmacro or2
  ([] nil)
  ([x] x)
  ([x &amp; next]
      `(let [or# ~x]
         (if or# or# (or ~@next)))))</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_8_parallel_programming_and_concurrency">8. Parallel Programming and Concurrency</h1>
<div class="sectionbody" style="max-width:45em">
</div>
</div>
<div class="sect1 slide">
<h1 id="_a_vars_and_dynamic_scope">a. Vars and dynamic scope</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Vars are automatically derefed when evaluated, so it can seem like they are just a variable. But you can “see” the var itself using the var function or #' shorthand.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(def one-hundred 100)
=&gt; #'training.core-test/one-hundred</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(var one-hundred)
=&gt; #'training.core-test/one-hundred</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(deref #'one-hundred)
=&gt; 100</code></pre>
</div></div>
<div class="paragraph"><p>The most common reason you would want to do that is to examine the metadata of a var:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(meta #'one-hundred)
=&gt; {:line 73, :column 1, ...}</code></pre>
</div></div>
<div class="paragraph"><p>Metadata may be provided using <code>^{}</code></p></div>
<div class="listingblock">
<div class="content">
<pre><code>(def x ^{:private true} 1)</code></pre>
</div></div>
<div class="paragraph"><p>You can attach whatever metadata you wish. These are the keys the compiler looks for:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>:private
:doc
:author
:type</code></pre>
</div></div>
<div class="paragraph"><p>By default Vars are static. But Vars can be marked as dynamic to allow per-thread bindings. Within each thread they obey a stack discipline:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(def ^:dynamic x 1)
(def ^:dynamic y 1)
(+ x y)
=&gt; 2</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(binding [x 2 y 3]
         (+ x y))
=&gt; 5</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(+ x y)
=&gt; 2</code></pre>
</div></div>
<div class="paragraph"><p>Bindings created with binding cannot be seen by any other thread. Likewise, bindings created with binding can be assigned to, which provides a means for a nested context to communicate with code before it on the call stack. This capability is opt-in only by setting a metadata tag: dynamic to true as in the code block above.</p></div>
<div class="paragraph"><p>Functions defined with defn are stored in Vars, allowing for the re-definition of functions in a running program. This also enables many of the possibilities of aspect- or context-oriented programming. For instance, you could wrap a function with logging behavior only in certain call contexts or threads.</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_b_delays_futures_and_promises">b. Delays, Futures, and Promises</h1>
<div class="sectionbody" style="max-width:45em">
<div class="sect2">
<h3 id="_delays">Delays</h3>
<div class="paragraph"><p>Delays wrap an arbitrary body of code for evaluation at a later stage so that the code in question is not run unless the answer is asked for. Delays also cache the result value to prevent another execution. The body code will only run once, even if dereferenced concurrently.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(def d (delay (println "Hello world!") 42))</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>d
=&gt; #object[clojure.lang.Delay {:status :pending, :val nil}]</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(realized? d)
=&gt; false</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>@d
=&gt; Hello world!
   42</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>@d
=&gt; 42</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(realized? d)
=&gt; true</code></pre>
</div></div>
<div class="paragraph"><p>We assign the delay to a var called <code>d</code>. We see that it starts in a pending state. Dereferencing <code>d</code> with <code>@</code> causes the code to run, printing <code>"Hello world!"</code> and returning <code>42</code>. Notice that the second dereference with <code>@</code> does not print <code>"Hello world!"</code> again, it only returns the already realized value of <code>42</code>.</p></div>
</div>
<div class="sect2">
<h3 id="_futures">Futures</h3>
<div class="paragraph"><p>Futures provide an easy way to spin off a new thread to do some computation or I/O that you will need access to in the future. The call style is compatible with delay. The difference is that the work begins immediately on another thread. The flow of control is not blocked. If you dereference a future, it will block until the value is available:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(def f
  (future (Thread/sleep 10000) 42))</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>f
=&gt; #object[clojure.core$future_call {:status :pending, :val nil}]</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(realized? f)
=&gt; false</code></pre>
</div></div>
<div class="paragraph"><p>--- 10 seconds pass ---</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(realized? f)
=&gt; true</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>@f
=&gt; 42</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>f
#object[clojure.core$future_call {:status :ready, :val 42}]</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_promises">Promises</h3>
<div class="paragraph"><p>Promises are used in a similar way to delay or future in that you dereference them for a value, can check if they have a value with <code>realized?</code> and they block when you dereference them if they don’t have a value until they do. Where they differ is that you don’t immediately give them a value, but provide them with one by calling deliver:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(def p (promise))
(realized? p)
=&gt; false</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(deliver p "as-promised")
(realized? p)
=&gt; true</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>@p
=&gt; "as-promised"</code></pre>
</div></div>
<div class="paragraph"><p>Dereferencing works on futures, delays, promises, atoms, agents refs and vars.</p></div>
</div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_c_atoms_refs_and_agents">c. Atoms, Refs, and Agents</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Atoms provide a way to manage shared, synchronous, independent state. They are a reference type like refs and vars. You create an atom with atom, and can access its state with <code>deref</code>/<code>@</code>. Like refs and agents, atoms support validators. To change the value of an atom, you can use <code>swap!</code>. A lower-level <code>compare-and-set!</code> is also provided. Changes to atoms are always free of race conditions.</p></div>
<div class="paragraph"><p>As with all reference types, the intended use of atom is to hold one of Clojure’s immutable data structures. And, similar to ref’s alter and agent’s send, you change the value by applying a function to the old value. This is done in an atomic manner by <code>swap!</code> Internally, <code>swap!</code> reads the current value, applies the function to it, and attempts to <code>compare-and-set!</code> it in. Since another thread may have changed the value in the intervening time, it may have to retry, and does so in a spin loop. The net effect is that the value will always be the result of the application of the supplied function to a current value, atomically. However, because the function might be called multiple times, it must be free of side effects.</p></div>
<div class="paragraph"><p>Atoms are an efficient way to represent some state that will never need to be coordinated with any other, and for which you wish to make synchronous changes (unlike agents, which are similarly independent but asynchronous).</p></div>
<div class="paragraph"><p>While Vars ensure safe use of mutable storage locations via thread isolation, transactional references (Refs) ensure safe shared use of mutable storage locations via a software transactional memory (STM) system. Refs are bound to a single storage location for their lifetime, and only allow mutation of that location to occur within a transaction. In practise Refs are rarely used.</p></div>
<div class="paragraph"><p>Like Refs, Agents provide shared access to mutable state. Where Refs support coordinated, synchronous change of multiple locations, Agents provide independent, asynchronous change of individual locations. Agents are bound to a single storage location for their lifetime, and only allow mutation of that location (to a new state) to occur as a result of an action. Actions are functions (with, optionally, additional arguments) that are asynchronously applied to an Agent’s state and whose return value becomes the Agent’s new state. Because actions are functions they can also be multimethods and therefore actions are potentially polymorphic. Also, because the set of functions is open, the set of actions supported by an Agent is also open, a sharp contrast to pattern matching message handling loops provided by some other languages.</p></div>
<div class="paragraph"><p>Clojure’s Agents are reactive, not autonomous - there is no imperative message loop and no blocking receive. The state of an Agent should be itself immutable (preferably an instance of one of Clojure’s persistent collections), and the state of an Agent is always immediately available for reading by any thread (using the deref function or reader macro @) without any messages, i.e. observation does not require cooperation or coordination.</p></div>
<div class="paragraph"><p>Agent action dispatches take the form (send agent fn args*). send (and send-off) always returns immediately. At some point later, in another thread, the following will happen:</p></div>
<ul class="">
<li>
<span>
The given fn will be applied to the state of the Agent and the args, if any were supplied. The return value of the given fn will become the new state of the Agent.
</span>
</li>
<li>
<span>
If any watchers were added to the Agent, they will be called. See add-watch for details.
</span>
</li>
<li>
<span>
If during the function execution any other dispatches are made (directly or indirectly), they will be held until after the state of the Agent has been changed.
</span>
</li>
<li>
<span>
If any exceptions are thrown by an action function, no nested dispatches will occur, and the exception will be cached in the Agent itself. When an Agent has errors cached, any subsequent interactions will immediately throw an exception, until the agent’s errors are cleared. Agent errors can be examined with agent-error and the agent restarted with restart-agent.
</span>
</li>
</ul>
<div class="paragraph"><p>The actions of all Agents get interleaved amongst threads in a thread pool. At any point in time, at most one action for each Agent is being executed. Actions dispatched to an agent from another single agent or thread will occur in the order they were sent, potentially interleaved with actions dispatched to the same agent from other sources. send should be used for actions that are CPU limited, while send-off is appropriate for actions that may block on IO.</p></div>
<div class="paragraph"><p>Agents are integrated with the STM - any dispatches made in a transaction are held until it commits, and are discarded if it is retried or aborted. No user-code locking is involved.</p></div>
<div class="paragraph"><p>Note that use of Agents starts a pool of non-daemon background threads that will prevent shutdown of the JVM. Use shutdown-agents to terminate these threads and allow shutdown.</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_9_java_interop">9. Java Interop</h1>
<div class="sectionbody" style="max-width:45em">
</div>
</div>
<div class="sect1 slide">
<h1 id="_a_clojure_syntax_for_java_constructors">a. Clojure syntax for Java constructors</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Constructing a Java object is done by appending a period to the class identifier:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(ns training.core
  (:import [java.util Date]))</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(Date.)
(Date. 2018 02 17)</code></pre>
</div></div>
<div class="paragraph"><p>Which is equivalent to the less used variant:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(new Date)
(new Date 2018 02 17)</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_b_calling_methods">b. Calling methods</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Calling a method on a Java object done by prepending a leading period:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(.length "hello world")
(.isDirectory (java.io.File. "my-dir"))</code></pre>
</div></div>
<div class="paragraph"><p>Which is equivalent to the less used variant:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(. "hello world" length)
(. (java.io.File. "my-dir") isDirectory)</code></pre>
</div></div>
<div class="paragraph"><p>Java static method calls are accessed by slash:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(Math/pow 1 2)
(.print System/out "hi")</code></pre>
</div></div>
<div class="paragraph"><p>Inner classes can be accessed using the dollar symbol:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>java.nio.channels.FileChannel$MapMode/READ_ONLY</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_c_reify">c. reify</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p><code>reify</code> creates an object that conforms to an interface:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(.listFiles (java.io.File. ".")
  (reify
    java.io.FileFilter
    (accept [this f]
      (.isDirectory f))))</code></pre>
</div></div>
<div class="paragraph"><p>Notice that we didn’t define a class? We directly created an object that conforms to the <code>FileFilter</code> interface. <code>reify</code> is a convenient way to provide a concrete implementation of an interface.</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_d_gen_class_and_proxy">d. gen-class and proxy</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p><code>gen-class</code> creates a class. In practise the need to create a class from within Clojure is rare, so we won’t be covering the syntax.
(see <a href="https://kotka.de/blog/2010/02/gen-class_how_it_works_and_how_to_use_it.html">https://kotka.de/blog/2010/02/gen-class_how_it_works_and_how_to_use_it.html</a> if you want to explore this further)</p></div>
<div class="paragraph"><p><code>proxy</code> can be used to extend a concrete superclass. Again the need for this is rare.
(see <a href="https://kotka.de/blog/2010/03/proxy_gen-class_little_brother.html">https://kotka.de/blog/2010/03/proxy_gen-class_little_brother.html</a> if you want to explore this further)</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_e_including_java_classes_in_clojure_projects">e. Including Java classes in Clojure projects</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>You can define Java classes in Java in a separate directory and add</p></div>
<div class="listingblock">
<div class="content">
<pre><code>:java-source-paths ["src/java"]</code></pre>
</div></div>
<div class="paragraph"><p>To your <code>project.clj</code> file
(See <a href="https://github.com/technomancy/leiningen/blob/master/doc/MIXED_PROJECTS.md">https://github.com/technomancy/leiningen/blob/master/doc/MIXED_PROJECTS.md</a> for more other options.)</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_challenge_3_mocking_parallel_web_requests">Challenge 3: Mocking parallel web requests</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Insuricorp and Megacorp are integrating their IT systems. As part of this effort you need to modify the “Corgi cover” eligibility logic to call a remote web service. Your task is to set up the code and tests.</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_part_1_mock_a_web_request">Part 1: Mock a web request</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Every Insuricorp “Corgi cover” policy application needs to be cross referenced with Megacorp to see if the customer has a Megacorp policy already via a remote web service. The web service is not available for you to test against yet. Set up a function called fetch-megacorp-policies to do the web request but leave the implementation empty. Create a test that changes the behavior of fetch-megacorp-policies to behave as though it were a web request; make it pause for 100ms before returning the policies that the person has. Set up a test that exercises the eligibility checks using the mocked version of a web request.</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_part_2_report_the_how_long_it_takes">Part 2: Report the how long it takes</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>In Java you might write something like this:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>long startTime = System.nanoTime();
// ... the code being measured ...
long estimatedTime = System.nanoTime() - startTime;</code></pre>
</div></div>
<div class="paragraph"><p>Implement a similar solution in Clojure.</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_part_3_make_parallel_requests">Part 3: Make parallel requests</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>The web service you are using can handle multiple requests faster than a series of requests. It operates fastest with up to 20 connections. Modify your code such that multiple requests are made simultaneously. Compare the timing results to confirm the operations are happening in parallel.</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_part_4_error_handling">Part 4: Error handling</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Modify your mock of fetch-megacorp-policies such that it throws an exception randomly about 10% of the time. Make sure your tests report a failure. Now update your logic to handle the errors and retry up to 10 times. The tests should pass. Then create another test where the exception is thrown 100% of the time, and the max tries occurs.</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_10_polymorphism_and_types">10. Polymorphism and Types</h1>
<div class="sectionbody" style="max-width:45em">
</div>
</div>
<div class="sect1 slide">
<h1 id="_a_multimethods">a. Multimethods</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Polymorphic dispatch. First we define the name of the multimethod, and the dispatch function:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(defmulti encounter
  (fn dispatch [x y]
    [(:species x) (:species y)]))</code></pre>
</div></div>
<div class="paragraph"><p>In this case the dispatch function returns a vector pair of the species of input <code>x</code> and the species of input <code>y</code>. Now we can provide methods implementing functions to execute for a given dispatch value:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(defmethod encounter [:bunny :lion] [x y] :run-away)
(defmethod encounter [:lion :bunny] [x y] :eat)
(defmethod encounter [:lion :lion] [x y] :fight)
(defmethod encounter [:bunny :bunny] [x y] :mate)</code></pre>
</div></div>
<div class="paragraph"><p>These are somewhere between a case statement and a function definition. They give the conditions under which to be called, and a function definition. Given a dispatch result of <code>[:bunny :lion]</code>, the first method will be called on the <code>x</code> and <code>y</code> inputs, and the method here does nothing but return a value <code>:run-away</code>. Let’s set up some test inputs:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(def bunny1 {:species :bunny, :other :stuff})
(def bunny2 {:species :bunny, :other :stuff})
(def lion1 {:species :lion, :other :stuff})
(def lion2 {:species :lion, :other :stuff})</code></pre>
</div></div>
<div class="paragraph"><p>Now we can call encounter on the data to see what it does&#8230;</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(encounter bunny1 bunny2)
=&gt; :mate
(encounter bunny1 lion1)
=&gt; :run-away
(encounter lion1 bunny1)
=&gt; :eat
(encounter lion1 lion2)
=&gt; :fight</code></pre>
</div></div>
<div class="paragraph"><p>Because keywords are functions, it’s quite common to use a keyword as a dispatch function.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(defmulti draw :shape)</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_b_protocols">b. Protocols</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>A protocol is a named set of named methods and their signatures, defined using defprotocol:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(defprotocol AProtocol
  "A doc string for AProtocol abstraction"
  (bar [a b] "bar docs")
  (baz [a] [a b] [a b c] "baz docs"))</code></pre>
</div></div>
<div class="paragraph"><p>No implementations are provided. Docs can be specified for the protocol and the functions. The above yields a set of polymorphic functions and a protocol object. All are namespace-qualified by the namespace enclosing the definition.</p></div>
<div class="paragraph"><p>The resulting functions dispatch on the type of their first argument, and thus must have at least one argument. defprotocol is dynamic, and does not require AOT compilation. defprotocol will automatically generate a corresponding interface, with the same name as the protocol, e.g. given a protocol my.ns/Protocol, an interface my.ns.Protocol. The interface will have methods corresponding to the protocol functions, and the protocol will automatically work with instances of the interface.</p></div>
<div class="paragraph"><p>Note that you do not need to use this interface with deftype, defrecord, or reify, as they support protocols directly:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(defprotocol P
  (foo [x])
  (bar-me [x] [x y]))</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(deftype Foo [a b c]
  P
  (foo [x] a)
  (bar-me [x] b)
  (bar-me [x y] (+ c y)))</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(bar-me (Foo. 1 2 3) 42)
=&gt; 45</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(foo
 (let [x 42]
   (reify P
     (foo [this] 17)
     (bar-me [this] x)
     (bar-me [this y] x))))
=&gt; 17</code></pre>
</div></div>
<div class="paragraph"><p>A Java client looking to participate in the protocol can do so most efficiently by implementing the protocol-generated interface. External implementations of the protocol (which are needed when you want a class or type not in your control to participate in the protocol) can be provided using the extend construct:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(extend AType
  AProtocol
   {:foo an-existing-fn
    :bar (fn [a b] ...)
    :baz (fn ([a]...) ([a b] ...)...)}
  BProtocol
    {...}
...)</code></pre>
</div></div>
<div class="paragraph"><p><code>extend</code> takes a type/class (or interface, see below), a one or more protocol + function map (evaluated) pairs. Will extend the polymorphism of the protocol’s methods to call the supplied functions when an AType is provided as the first argument. Function maps are maps of the keywordized method names to ordinary fns. This facilitates easy reuse of existing fns and maps, for code reuse/mixins without derivation or composition.</p></div>
<div class="paragraph"><p>You can implement a protocol on an interface. This is primarily to facilitate interop with the host (e.g. Java) but opens the door to incidental multiple inheritance of implementation since a class can inherit from more than one interface, both of which implement the protocol. If one interface is derived from the other, the more derived is used, else which one is used is unspecified.</p></div>
<div class="paragraph"><p>The implementing <code>fn</code> can presume first argument is instanceof <code>AType</code>. You can implement a protocol on <code>nil</code>. To define a default implementation of protocol (for other than <code>nil</code>) just use <code>Object</code>. Protocols are fully reified and support reflective capabilities via <code>extends?</code>, <code>extenders</code>, and <code>satisfies?</code>. Note the convenience macros <code>extend-type</code>, and <code>extend-protocol</code>.</p></div>
<div class="paragraph"><p>If you are providing external definitions inline, these will be more convenient than using extend directly</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(extend-type MyType
  Countable
    (cnt [c] ...)
  Foo
    (bar [x y] ...)
    (baz ([x] ...) ([x y zs] ...)))</code></pre>
</div></div>
<div class="paragraph"><p>Expands into:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(extend MyType
  Countable
   {:cnt (fn [c] ...)}
  Foo
   {:baz (fn ([x] ...) ([x y zs] ...))
    :bar (fn [x y] ...)})</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_c_creating_types_with_defrecord_and_deftype">c. Creating types with defrecord and deftype</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p><code>deftype</code>, <code>defrecord</code>, and <code>reify</code> provide the mechanism for defining implementations of abstractions, and instances of those implementations. Resist the urge to use them to define ‘structured data’ as you would define classes or structures in other languages. It is preferred to use the built-in datatypes (vectors, maps, sets) to represent structured data.</p></div>
<div class="sect2">
<h3 id="_deftype">Deftype</h3>
<div class="listingblock">
<div class="content">
<pre><code>(deftype Circle [radius])
(deftype Square [length width])</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(Circle. 10)
(Square. 5 11)</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(-&gt;Circle 10)
(-&gt;Square 5 11)</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_defrecord">Defrecord</h3>
<div class="paragraph"><p>This example shows how to implement a Java interface in defrecord.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(import java.net.FileNameMap)</code></pre>
</div></div>
<div class="paragraph"><p>To define a record named <code>Thing</code> with a single field <code>a</code>, implement <code>FileNameMap</code> interface and provide an implementation for the single method: <code>String getContentTypeFor(String fileName)</code>.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(defrecord Thing [a]
  FileNameMap
  (getContentTypeFor [this fileName] (str a "-" fileName)))</code></pre>
</div></div>
<div class="paragraph"><p>Construct an instance of the record:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(def thing (Thing. "foo"))</code></pre>
</div></div>
<div class="paragraph"><p>Check that the instance implements the interface:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(instance? FileNameMap thing)</code></pre>
</div></div>
<div class="paragraph"><p>Call the method on the <code>thing</code> instance and pass <code>"bar"</code>:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(.getContentTypeFor thing "bar")</code></pre>
</div></div>
</div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_11_specifications_with_clojure_spec">11. Specifications with clojure.spec</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>The spec library specifies the structure of data, validates or destructures it, and can generate data based on the spec. Spec was introduced into Clojure 1.9.0, so update your <code>project.clj</code> to the right version:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>[org.clojure/clojure "1.9.0"]</code></pre>
</div></div>
<div class="paragraph"><p>To start working with spec, require the <code>clojure.spec.alpha</code> namespace at the REPL:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(ns my.ns
  (:require [clojure.spec.alpha :as s]))</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_a_validation">a. Validation</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Any function that takes a single argument and returns a truthy value is a valid predicate spec.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(s/valid? even? 10)
=&gt; true</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(s/valid? string? 0)
=&gt; false</code></pre>
</div></div>
<div class="paragraph"><p>Sets are functions, so can be used as predicates that match one or more literal values:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(s/valid? #{:club :diamond :heart :spade} :club)
=&gt; true</code></pre>
</div></div>
<div class="paragraph"><p>Specs are registered using <code>s/def</code>.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(s/def ::suit #{:club :diamond :heart :spade})</code></pre>
</div></div>
<div class="paragraph"><p>A registered spec identifier can be used in place of a spec definition.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(s/valid? ::suit :club)
=&gt; true</code></pre>
</div></div>
<div class="paragraph"><p>The simplest way to compose specs is with <code>and</code> and <code>or</code>. Let’s create a spec that combines several predicates into a composite spec with <code>s/and</code>:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(s/def ::big-even (s/and int? even? #(&gt; % 1000)))</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(s/valid? ::big-even 10)
=&gt; false</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(s/valid? ::big-even 100000)
=&gt; true</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_b_conforming">b. Conforming</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>We can also use <code>s/or</code> to specify two alternatives:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(s/def ::name-or-id (s/or :name string? :id int?))</code></pre>
</div></div>
<div class="paragraph"><p>This <code>or</code> spec is the first case we’ve seen that involves a choice during validity checking. Each choice is annotated with a tag (here, between <code>:name</code> and <code>:id</code>) and those tags give the branches names that can be used to understand or enrich the data returned from conform and other spec functions.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(s/conform ::name-or-id "abc")
=&gt; [:name "abc"]</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(s/conform ::name-or-id 100)
=&gt; [:id 100]</code></pre>
</div></div>
<div class="paragraph"><p>Many predicates that check an instance’s type do not allow nil as a valid value (<code>string?</code>, <code>number?</code>, <code>keyword?</code>, etc). To include <code>nil</code> as a valid value, use the provided function nilable to make a spec:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(s/nilable string?)</code></pre>
</div></div>
<div class="paragraph"><p>Explain can be used to report why a value does not conform to a spec.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(s/explain ::big-even 5)
=&gt; val: 5 fails spec: ::big-even predicate: even?</code></pre>
</div></div>
<div class="paragraph"><p>In addition to <code>explain</code>, you can use <code>explain-str</code> to receive the error messages as a string or <code>explain-data</code> to receive the errors as data.</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_c_maps">c. Maps</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Clojure programs rely heavily on passing around maps of data. Entity maps in spec are defined with keys:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(def email-regex
  #"^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,63}$")
(s/def ::email-type (s/and string? #(re-matches email-regex %)))
(s/def ::acctid int?)
(s/def ::first-name string?)
(s/def ::last-name string?)
(s/def ::email ::email-type)</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(s/def ::person (s/keys :req [::first-name ::last-name ::email]
                        :opt [::phone]))</code></pre>
</div></div>
<div class="paragraph"><p>Validation checks that the required attributes are included, and that every registered key has a conforming value.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(s/valid? ::person
  {::first-name "Elon"
   ::last-name "Musk"
   ::email "elon@example.com"})
=&gt; true</code></pre>
</div></div>
<div class="paragraph"><p>Much existing Clojure code does not use maps with namespaced keys and so keys can also specify <code>:req-un</code> and <code>:opt-un</code> for required and optional unqualified keys. These variants specify namespaced keys used to find their specification, but the map only checks for the unqualified version of the keys.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(s/def :unq/person
  (s/keys :req-un [::first-name ::last-name ::email]
          :opt-un [::phone]))</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(s/valid? :unq/person
  {:first-name "Elon"
   :last-name "Musk"
   :email "elon@example.com"})
=&gt; true</code></pre>
</div></div>
<div class="paragraph"><p>In addition to the support for information maps via keys, spec also provides map-of for maps with homogenous key and value predicates.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(s/def ::scores (s/map-of string? int?))
(s/valid? ::scores {"Sally" 1000, "Joe" 500})
=&gt; true</code></pre>
</div></div>
<div class="paragraph"><p>Spec has explicit support for pre and post conditions using <code>fdef</code>.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(defn adder [x] #(+ x %))
(s/fdef adder
  :args (s/cat :x number?)
  :ret (s/fspec :args (s/cat :y number?)
                :ret number?)
  :fn #(= (-&gt; % :args :x) ((:ret %) 0)))</code></pre>
</div></div>
<div class="paragraph"><p>The <code>:ret</code> spec uses fspec to declare that the returning function takes and returns a number. Even more interesting, the <code>:fn</code> spec can state a general property that relates the <code>:args</code> (where we know <code>x</code>) and the result we get from invoking the function returned from adder, namely that adding <code>0</code> to it should return <code>x</code>.</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_d_a_game_of_cards">d. A game of cards</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Here’s a bigger set of specs to model a game of cards:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(def suit? #{:club :diamond :heart :spade})
(def rank? (into #{:jack :queen :king :ace} (range 2 11)))
(def deck (for [suit suit? rank rank?] [rank suit]))</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(s/def ::card (s/tuple rank? suit?))
(s/def ::hand (s/* ::card))</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(s/def ::name string?)
(s/def ::score int?)
(s/def ::player (s/keys :req [::name ::score ::hand]))</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(s/def ::players (s/* ::player))
(s/def ::deck (s/* ::card))
(s/def ::game (s/keys :req [::players ::deck]))</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(def kenny
  {::name "Kenny Rogers"
   ::score 100
   ::hand []})
(s/valid? ::player kenny)
=&gt; true</code></pre>
</div></div>
<div class="paragraph"><p>Bad data produces errors</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(s/explain ::game
  {::deck deck
   ::players [{::name "Kenny Rogers"
               ::score 100
               ::hand [[2 :banana]]}]})
=&gt; In: [::players 0 ::hand 0 1]
   val: :banana fails spec: ::card
   at: [::players ::hand 1]
   predicate: suit?</code></pre>
</div></div>
<div class="paragraph"><p>If we have a function deal that doles out some cards to the players we can spec that function to verify the arg and return value are both suitable data values. We can also specify a :fn spec to verify that the count of cards in the game before the deal equals the count of cards after the deal.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(defn total-cards [{:keys [::deck ::players] :as game}]
  (apply + (count deck)
    (map #(-&gt; % ::hand count) players)))</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(defn deal [game] ...)</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(s/fdef deal
  :args (s/cat :game ::game)
  :ret ::game
  :fn #(= (total-cards (-&gt; % :args :game))
          (total-cards (-&gt; % :ret))))</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_e_generators">e. Generators</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>A key design constraint of spec is that all specs are also designed to act as generators of sample data that conforms to the spec (a critical requirement for property-based testing).</p></div>
<div class="paragraph"><p>Spec generators rely on the Clojure property testing library test.check. However, this dependency is dynamically loaded and you can use the parts of spec other than gen, exercise, and testing without declaring test.check as a runtime dependency. When we wish to use these parts of spec (typically during testing), we need to declare a dev dependency on <code>test.check</code> in our <code>project.clj</code>:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>:profiles {:dev {:dependencies [[org.clojure/test.check "0.9.0"]]}}</code></pre>
</div></div>
<div class="paragraph"><p>The dev profile dependencies are included during testing but not published as a dependency or included in uber jars.</p></div>
<div class="paragraph"><p>We require <code>clojure.spec.gen.alpha</code> in the <code>ns</code> form:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(ns my-ns.my-test
  (:require [clojure.spec.gen.alpha :as gen]))</code></pre>
</div></div>
<div class="paragraph"><p>The <code>gen</code> function can be used to obtain the generator for any spec.</p></div>
<div class="paragraph"><p>Once you have obtained a generator with <code>gen</code>, there are several ways to use it. You can generate a single sample value with generate or a series of samples with sample. Let’s see some basic examples:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(gen/generate (s/gen int?))
=&gt; -959</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(gen/sample (s/gen string?))
=&gt; ("" "" "" "" "8" "W" "" "G74SmCm" "K9sL9" "82vC")</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(gen/sample (s/gen #{:club :diamond :heart :spade}))
=&gt; (:heart :diamond :heart :heart :heart :diamond :spade :spade :spade :club)</code></pre>
</div></div>
<div class="paragraph"><p>What about generating a random player in our card game?</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(gen/generate (s/gen ::player))
=&gt; {:spec.examples.guide/name "sAt8r6t",
    :spec.examples.guide/score 233843,
    :spec.examples.guide/hand ([8 :spade] [5 :heart] [9 :club] [3 :heart])}</code></pre>
</div></div>
<div class="paragraph"><p>We can even generate an entire game:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(gen/generate (s/gen ::game))</code></pre>
</div></div>
<div class="paragraph"><p>It’s useful to spec (and generate) values in a range. For example, in the case of a range of integer values, use <code>int-in</code> to spec a range:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(s/def ::roll (s/int-in 0 11))
(gen/sample (s/gen ::roll))
=&gt; (1 0 0 3 1 7 10 1 5 0)</code></pre>
</div></div>
<div class="paragraph"><p>Spec also includes <code>inst-in</code> for a range of Dates, and <code>double-in</code> for double ranges.</p></div>
<div class="paragraph"><p>To learn more about generators, read the test.check tutorial <a href="https://clojure.github.io/test.check/intro.html">https://clojure.github.io/test.check/intro.html</a>.</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_f_instrumentation_and_testing">f. Instrumentation and Testing</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Spec provides a set of development and testing functionality in the clojure.spec.test.alpha namespace, which we can include with:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(ns my-ns.core
  (:require [clojure.spec.test.alpha :as stest]))</code></pre>
</div></div>
<div class="paragraph"><p>Instrumentation validates that the :args spec is being invoked on instrumented functions and thus provides validation for external uses of a function.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(defn ranged-rand
  "Returns random int in range start &lt;= rand &lt; end"
  [start end]
  (+ start (long (rand (- end start)))))</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(stest/instrument `ranged-rand)</code></pre>
</div></div>
<div class="paragraph"><p>Instrument takes a fully-qualified symbol so we use ``` here to resolve it in the context of the current namespace. If the function is invoked with args that do not conform with the <code>:args</code> spec you will see an error like this:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(ranged-rand 8 5)
=&gt; CompilerException clojure.lang.ExceptionInfo: Call to #'spec.examples.guide/ranged-rand did not conform to spec</code></pre>
</div></div>
<div class="paragraph"><p>Instrumentation can be turned off using the complementary function unstrument. Instrumentation is useful at both development time and during testing to discover errors in calling code. It is not recommended to use instrumentation in production due to the overhead involved with checking args specs.</p></div>
<div class="paragraph"><p>We mentioned earlier that <code>clojure.spec.test.alpha</code> provides tools for automatically testing functions. When functions have specs, we can use check, to automatically generate tests that check the function using the specs.</p></div>
<div class="paragraph"><p><code>check</code> will generate arguments based on the <code>:args</code> spec for a function, invoke the function, and check that the <code>:ret</code> and <code>:fn</code> specs were satisfied.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(ns my-ns.core
  (:require [clojure.spec.test.alpha :as stest]))</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(stest/check `ranged-rand)
=&gt; ({:spec #object[clojure.spec.alpha$fspec_impl ...],
     :clojure.spec.test.check/ret {:result true, :num-tests 1000, :seed 1466805740290},
     :sym spec.examples.guide/ranged-rand,
     :result true})</code></pre>
</div></div>
<div class="paragraph"><p>A keen observer will notice that <code>ranged-rand</code> contains a subtle bug. If the difference between start and end is very large (larger than is representable by <code>Long/MAX_VALUE</code>), then <code>ranged-rand</code> will produce an <code>IntegerOverflowException</code>. If you run check several times you will eventually cause this case to occur.</p></div>
<div class="paragraph"><p><code>check</code> also takes a number of options that can be passed to <code>test.check</code> to influence the test run, as well as the option to override generators for parts of the spec, by either name or path.</p></div>
<div class="paragraph"><p>Imagine instead that we made an error in the <code>ranged-rand</code> code and swapped start and end:</p></div>
<div class="dlist"><dl class="">
<dt class="hdlist1">
(defn ranged-rand  
</dt>
<dd>
<p>
BROKEN!
      "Returns random int in range start &#8656; rand &lt; end"
      [start end]
      (+ start (long (rand (- start end)))))
</p>
</dd>
</dl></div>
<div class="paragraph"><p>This broken function will still create random integers, just not in the expected range. Our <code>:fn</code> spec will detect the problem when checking the var:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(stest/abbrev-result (first (stest/check `ranged-rand)))
=&gt; ({...
     :result {...
              :clojure.spec.alpha/failure :test-failed}}</code></pre>
</div></div>
<div class="paragraph"><p><code>check</code> has reported an error in the <code>:fn</code> spec. We can see the arguments passed were <code>-3</code> and <code>0</code> and the return value was <code>-5</code>, which is out of the expected range.</p></div>
<div class="paragraph"><p>To test all of the spec’ed functions in a namespace (or multiple namespaces), use enumerate-namespace to generate the set of symbols naming vars in the namespace:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(-&gt; (stest/enumerate-namespace 'user) stest/check)</code></pre>
</div></div>
<div class="paragraph"><p>And you can check all of the spec’ed functions by calling <code>stest/check</code> without any arguments.</p></div>
<div class="paragraph"><p>While both instrument (for enabling <code>:args</code> checking) and check (for generating tests of a function) are useful tools, they can be combined to provide even deeper levels of test coverage.</p></div>
<div class="paragraph"><p>instrument takes a number of options for changing the behavior of instrumented functions, including support for swapping in alternate (narrower) specs, stubbing functions (by using the <code>:ret</code> spec to generate results), or replacing functions with an alternate implementation.</p></div>
<div class="paragraph"><p>Consider the case where we have a low-level function that invokes a remote service and a higher-level function that calls it.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(defn invoke-service [service request])</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(defn run-query [service query]
  (let [{::keys [result error]} (invoke-service service
                                  {::query query})]
    (or result error)))</code></pre>
</div></div>
<div class="paragraph"><p>We can spec these functions using the following specs:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(s/def ::query string?)
(s/def ::request (s/keys :req [::query]))
(s/def ::result (s/coll-of string? :gen-max 3))
(s/def ::error int?)
(s/def ::response (s/or :ok (s/keys :req [::result])
                        :err (s/keys :req [::error])))</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(s/fdef invoke-service
  :args (s/cat :service any? :request ::request)
  :ret ::response)</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(s/fdef run-query
  :args (s/cat :service any? :query string?)
  :ret (s/or :ok ::result :err ::error))</code></pre>
</div></div>
<div class="paragraph"><p>And then we want to test the behavior of run-query while stubbing out invoke-service with instrument so that the remote service is not invoked:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(stest/instrument `invoke-service {:stub #{`invoke-service}})
=&gt; [spec.examples.guide/invoke-service]</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(invoke-service nil {::query "test"})
=&gt; #:spec.examples.guide{:error -11}</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(invoke-service nil {::query "test"})
=&gt; #:spec.examples.guide{:result ["kq0H4yv08pLl4QkVH8" "in6gH64gI0ARefv3k9Z5Fi23720gc"]}</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(stest/summarize-results (stest/check `run-query))
=&gt; {:total 1, :check-passed 1}</code></pre>
</div></div>
<div class="paragraph"><p>The first call here instruments and stubs <code>invoke-service</code>. The second and third calls demonstrate that calls to <code>invoke-service</code> now return generated results (rather than hitting a service). Finally, we can use check on the higher level function to test that it behaves properly based on the generated stub results returned from <code>invoke-service</code>.</p></div>
<div class="paragraph"><p>There is even more to spec! Once you are comfortable with the basics you can learn more at <a href="https://clojure.org/guides/spec">https://clojure.org/guides/spec</a>.</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_12_interacting_with_a_database">12. Interacting with a Database</h1>
<div class="sectionbody" style="max-width:45em">
</div>
</div>
<div class="sect1 slide">
<h1 id="_a_intro_to_clojure_java_jdbc">a. Intro to clojure.java.jdbc</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Database persistence is important for many applications. We can use clojure.java.jdbc to interact with a database.</p></div>
<div class="paragraph"><p>To start, create a new project</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ lein new messenger</code></pre>
</div></div>
<div class="paragraph"><p>and add dependencies to your <code>project.clj</code> file:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>[org.clojure/java.jdbc "0.7.5"]
[hsqldb/hsqldb "1.8.0.10"]</code></pre>
</div></div>
<div class="paragraph"><p>Note that we need the driver we plan to use to connect to a database. In this case we are using an in memory HSQL database.</p></div>
<div class="paragraph"><p>In the Clojure project we require jdbc, and set up a db connection url.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(ns messenger.core
  (:require [clojure.java.jdbc :as jdbc]))</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(def db "jdbc:hsqldb:mem:testdb")</code></pre>
</div></div>
<div class="paragraph"><p>Now we are all set to start doing queries.</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_b_inserting_updating_and_retrieving_data">b. Inserting, updating and retrieving data</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>First we will create a table called testing inside the database with a text field named data, and then insert some rows.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(jdbc/execute! db
  "create table messages (message varchar(1024))")</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(jdbc/insert-multi! db :messages
                    [{:message "Hello World"}
                     {:message "How now?"}])</code></pre>
</div></div>
<div class="paragraph"><p>And we can query the data back:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(jdbc/query db ["select * from messages"])
=&gt; ({:message "Hello World"}
    {:message "How now?"})</code></pre>
</div></div>
<div class="paragraph"><p>To selectively delete some data:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(jdbc/delete! db :messages ["message like '%World%'"])</code></pre>
</div></div>
<div class="paragraph"><p>And now there is only one row remaining.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(jdbc/query db ["select * from messages"])
=&gt; ({:message "Hello World"})</code></pre>
</div></div>
<div class="paragraph"><p>Let’s add some more data&#8230;</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(jdbc/insert-multi! db :messages
                [{:message "Nobody panic!!!"}
                 {:message "What in the world?"}
                 {:message "All is well."}])</code></pre>
</div></div>
<div class="paragraph"><p>And now we create a function to do a parameterized query.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(defn search [s]
  (jdbc/query db
    ["select * from messages where message like ?" s]))</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(search "%How%")
=&gt; ({:message "How now?"})</code></pre>
</div></div>
<div class="paragraph"><p>It is important to use parameterized queries instead of string concatenation in this example because it protects us from SQL injection. Parameters are not part of the query, so they cannot perform SQL from malicious input.</p></div>
<div class="paragraph"><p>If you want to redo any steps, remember that you can always drop the table and start again.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(jdbc/execute! db "drop table messages")</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_c_solutions_for_sql_management">c. Solutions for SQL management</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>HoneySQL <a href="https://github.com/jkk/honeysql">https://github.com/jkk/honeysql</a> can be used to build SQL statements from data structures. This is useful when you have to programmatically combine clauses to produce a final SQL statement. For example if the user can check a checkbox to enable an additional clause in a search. In such cases it is more convenient to use Clojure’s capabilities for manipulating data structures. However if you do not need to do such manipulation, I recommend using plain old SQL queries in their original text form, as you can run them interactively from an SQL prompt much easier that way.</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_d_exercises_2">d. Exercises</h1>
<div class="sectionbody" style="max-width:45em">
<ul class="">
<li>
<span>
Create and populate a table <code>person</code> with two columns; <code>id</code>, <code>name</code>.
</span>
</li>
<li>
<span>
Create and populate a table <code>policy</code> with two columns; <code>id</code>, <code>name</code>
</span>
</li>
<li>
<span>
Create and populate a table <code>person_policy</code> with two columns; <code>person_id</code>, <code>policy_id</code>
</span>
</li>
<li>
<span>
Write a function that given a person name queries all the policies associated with them.
</span>
</li>
</ul>
</div>
</div>
<div class="sect1 slide">
<h1 id="_e_answers_2">e. Answers</h1>
<div class="sectionbody" style="max-width:45em">
<div class="listingblock">
<div class="content">
<pre><code>(ns messenger.core
  (:require [clojure.java.jdbc :as jdbc]))</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(def db "jdbc:hsqldb:mem:testdb")</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(jdbc/execute! db
  "create table person (id bigint, name varchar(1024))")
(jdbc/execute! db
  "create table policy (id bigint, name varchar(1024))")
(jdbc/execute! db
  "create table person_policy
  (person_id bigint, policy_id bigint)")
(jdbc/insert-multi! db :person
                    [{:id 1 :name "Sally"}
                     {:id 2 :name "Billy"}])
(jdbc/insert-multi! db :policy
                    [{:id 1 :name "Corgi Cover"}
                     {:id 2 :name "Poodle Protection"}])
(jdbc/insert-multi! db :person_policy
                    [{:person_id 1 :policy_id 1}
                     {:person_id 1 :policy_id 2}
                     {:person_id 2 :policy_id 1}])</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(defn find-policies [person-name]
  (jdbc/query db ["select a.name
                  from policy a
                  inner join person_policy b
                  on a.id = b.policy_id
                  inner join person c
                  on b.person_id = c.id
                  where c.name = ?"
                  person-name]))</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>(find-policies "Sally")
=&gt; ({:name "Corgi Cover"} {:name "Poodle Protection"})
(find-policies "Jane")
=&gt; ()
(find-policies "Billy")
=&gt; ({:name "Corgi Cover"})</code></pre>
</div></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_challenge_4_corgi_cover_database">Challenge 4: Corgi Cover Database</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Sending files around is proving to be problematic. Sometimes applications are lost or the results of the eligibility check are not communicated back to the customer. You have been tasked with creating a central source of truth that can be queried as to what applications have been submitted and processed.</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_part_1_set_up_the_schema">Part 1: Set up the schema</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Using the database of your choice, set up an initial database for the Corgi Cover project. In the code, connect to the database and create the initial table required. You can use whatever schema you like, but the first requirement is to store the applications with exactly the same data as was retrieved from the file format in Challenge 2.</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_part_2_populate_the_data">Part 2: Populate the data</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Modify the code to store the applications as they are processed, and the result of the eligibility check.</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_part_3_write_a_spec">Part 3: Write a spec</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Ensure that all records processed from the files meets your expectations for required fields. Write a spec that explicitly defines what should be in the applications. Validate the spec on the incoming records.</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_part_4_extending_to_poodle_protection">Part 4: Extending to Poodle Protection</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Insuricorp is about to launch a new policy called “Poodle Protection”. Soon they will be processing applications with completely new rules. Set up a multimethod to handle “Poodle Protection” applications differently from “Corgi Cover” applications. For now the only difference with the rules from “Corgi Cover” is that “Poodle Protection” is available in different states: California (CA), Florida (FL), Wyoming (WY), and Hawaii (HI).</p></div>
</div>
</div>
<div class="sect1 slide">
<h1 id="_further_reading">Further reading</h1>
<div class="sectionbody" style="max-width:45em">
<div class="paragraph"><p>Writing Clojure code requires more thinking and less typing than other languages. Don’t feel frustrated if the code comes slowly at first. Being a great programmer requires thinking. You will only reach your true potential expressing code in ways that empower you rather than constrain you.</p></div>
<div class="paragraph"><p>Further exercises:      <a href="https://www.4clojure.com/">https://www.4clojure.com/</a></p></div>
<div class="paragraph"><p>Clojure for Java Programmers - Rich Hickey</p></div>
<ul class="">
<li>
<span>
Part 1:               <a href="https://www.youtube.com/watch?v=P76Vbsk_3J0">https://www.youtube.com/watch?v=P76Vbsk_3J0</a>
</span>
</li>
<li>
<span>
Part 2:               <a href="https://www.youtube.com/watch?v=hb3rurFxrZ8">https://www.youtube.com/watch?v=hb3rurFxrZ8</a>
</span>
</li>
</ul>
<div class="paragraph"><p>Hadoop libraries</p></div>
<ul class="">
<li>
<span>
<a href="https://github.com/nathanmarz/cascalog">https://github.com/nathanmarz/cascalog</a>
</span>
</li>
<li>
<span>
<a href="https://github.com/damballa/parkour">https://github.com/damballa/parkour</a>
</span>
</li>
<li>
<span>
<a href="https://github.com/r0man/hdfs-clj">https://github.com/r0man/hdfs-clj</a>
</span>
</li>
</ul>
<div class="paragraph"><p>Spark libraries</p></div>
<ul class="">
<li>
<span>
<a href="https://github.com/yieldbot/flambo">https://github.com/yieldbot/flambo</a>
</span>
</li>
</ul>
</div>
</div>
</body>
</html>
